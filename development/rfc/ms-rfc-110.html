<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 110: MapCache REST Cache Backends &mdash; MapServer 7.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 111: MapCache Support for animated time series" href="ms-rfc-111.html" />
    <link rel="prev" title="MS RFC 109: Optimizing Runtime Substitutions" href="ms-rfc-109.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../faq.html" title="FAQ">FAQ</a> |
      <a href="../../download.html" title="Download">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        
        
          <a href="../../uk/development/rfc/ms-rfc-110.html"><img src="../../_static/flagicons/uk.png" alt="uk" title="uk" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-111.html" title="MS RFC 111: MapCache Support for animated time series"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-109.html" title="MS RFC 109: Optimizing Runtime Substitutions"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-110-mapcache-rest-cache-backends">
<span id="rfc110"></span><h1>MS RFC 110: MapCache REST Cache Backends<a class="headerlink" href="#ms-rfc-110-mapcache-rest-cache-backends" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2014/04</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Thomas Bonfort</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:tbonfort&#37;&#52;&#48;terriscope&#46;fr">tbonfort<span>&#64;</span>terriscope<span>&#46;</span>fr</a></td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapServer 7.0</td>
</tr>
<tr class="field-even field"><th class="field-name">Last Updated:</th><td class="field-body">2014/04/17</td>
</tr>
</tbody>
</table>
<div class="section" id="motivation">
<h2>1. Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>In addition to the supported cache backends, it is desirable for mapcache to
be able to store and retrieve tiles through a HTTP REST interface, using the
GET, PUT and DELETE verbs. While any webdav enabled server could be used, the
final aim for this improvement is to be able to store tiles to well known cloud
storage providers (initially: S3, Azure and Google).</p>
</div>
<div class="section" id="implementation-details">
<h2>2. Implementation details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<div class="section" id="generic-rest-backends">
<h3>2.2 Generic REST backends<a class="headerlink" href="#generic-rest-backends" title="Permalink to this headline">¶</a></h3>
<p>Adding a cache backend has no architectural impacts, as it implies only adding
the cache specific vtable functions. The REST caches themselves are rather
specific, as there&#8217;s usually an authentication/authorization step that is
specific to each provider, and usually consists in signing the given payload
with a secret key attached to an account.</p>
<p>A rest cache is configured with an xml block:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;cache name=&quot;myrestcache&quot; type=&quot;rest&quot;&gt;
   &lt;url&gt;https://myserver/webdav/{tileset}/{grid}/{z}/{x}/{y}.{ext}&lt;/url&gt;
   &lt;headers&gt;
     &lt;Host&gt;my-virtualhost-alias.domain.com&lt;/Host&gt;
   &lt;/headers&gt;
   &lt;operation type=&quot;put&quot;&gt;
     &lt;headers&gt;
       &lt;X-my-specific-put-header&gt;foo&lt;/X-my-specific-put-header&gt;
     &lt;/headers&gt;
   &lt;/operation&gt;
   &lt;operation type=&quot;get&quot;&gt;
     &lt;headers&gt;
       &lt;X-my-specific-get-header&gt;foo&lt;/X-my-specific-get-header&gt;
     &lt;/headers&gt;
   &lt;/operation&gt;
   &lt;operation type=&quot;head&quot;&gt;
     &lt;headers&gt;
       &lt;X-my-specific-head-header&gt;foo&lt;/X-my-specific-head-header&gt;
     &lt;/headers&gt;
   &lt;/operation&gt;
   &lt;operation type=&quot;delete&quot;&gt;
     &lt;headers&gt;
       &lt;X-my-specific-delete-header&gt;foo&lt;/X-my-specific-delete-header&gt;
     &lt;/headers&gt;
   &lt;/operation&gt;
&lt;/cache&gt;
</pre></div>
</div>
<ul class="simple">
<li>The &lt;url&gt; block configures the template URL to use when addressing a specific tile,
and follows the same syntax used when defining a templated based disk backend.</li>
<li>The initial &lt;header&gt; block contains a list of HTTP headers that will be added to any
HTTP request going to the third party server</li>
<li>Each &lt;operation&gt; block can also contain a &lt;header&gt; list of specific headers to be added
to the request for a particular operation, specified by it&#8217;s &#8220;type&#8221; attribute:<ul>
<li>&#8220;get&#8221; is used when requesting a tile from the server</li>
<li>&#8220;head&#8221; is used when querying the server for the existence of a tile (only used by the
seeder).</li>
<li>&#8220;put&#8221; is used when uploading a newly created tile</li>
<li>&#8220;delete&#8221; is used when deleting a tile from the server</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="adding-support-for-well-known-cloud-services">
<h3>2.2 Adding Support for Well Known Cloud Services<a class="headerlink" href="#adding-support-for-well-known-cloud-services" title="Permalink to this headline">¶</a></h3>
<p>The REST cache backends become really useful once associated with a third party
cloud storage provider, to be able to store tiles in the cloud. Architecturally,
each vendor specific implementation in mapcache provides a hook that can add
specific headers to the HTTP request to allow for signing/authenticating the
request. To allow signing, specific code for calculating SHAs of a payload will
be added to mapcache.</p>
<div class="section" id="amazon-s3">
<h4>2.2.1 Amazon S3<a class="headerlink" href="#amazon-s3" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;cache name=&quot;s3&quot; type=&quot;s3&quot;&gt;
  &lt;url&gt;https://mybucket.s3.amazonaws.com/tiles/{tileset}/{grid}/{z}/{x}/{y}.{ext}&lt;/url&gt;
  &lt;headers&gt;
    &lt;Host&gt;mybucket.s3.amazonaws.com&lt;/Host&gt;
  &lt;/headers&gt;
  &lt;id&gt;XXXXXXXXXXXXXXX&lt;/id&gt;
  &lt;secret&gt;foobaregrwq1235234532/3245234sadgfwevsd&lt;/secret&gt;
  &lt;region&gt;eu-west-1&lt;/region&gt;
  &lt;operation type=&quot;put&quot;&gt;
    &lt;headers&gt;
      &lt;x-amz-storage-class&gt;REDUCED_REDUNDANCY&lt;/x-amz-storage-class&gt;
      &lt;x-amz-acl&gt;public-read&lt;/x-amz-acl&gt;
    &lt;/headers&gt;
  &lt;/operation&gt;
&lt;/cache&gt;
</pre></div>
</div>
<p>This cache uses 3 mandatory configuration options: &lt;id&gt;,&lt;secret&gt;, and &lt;region&gt;. Values for
each are self-explanatory and can be found on the S3 documentation. In the previous example,
we add S3 specific headers to &#8220;put&#8221; requests, specifying we want publicly readable tiles, stored
in a less expensive backend. Other x-amz-* headers can be added once looked up from the S3 documentation
site.</p>
</div>
<div class="section" id="microsoft-azure">
<h4>2.2.2 Microsoft Azure<a class="headerlink" href="#microsoft-azure" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;cache name=&quot;azure&quot; type=&quot;azure&quot;&gt;
   &lt;url&gt;https://mytiles.blob.core.windows.net/tilestore/{tileset}/{grid}/{z}/{x}/{y}.{ext}&lt;/url&gt;
   &lt;headers&gt;
     &lt;Host&gt;mytiles.blob.core.windows.net&lt;/Host&gt;
   &lt;/headers&gt;
   &lt;id&gt;mytiles&lt;/id&gt;
   &lt;secret&gt;base64encodedsecretkey==&lt;/secret&gt;
   &lt;container&gt;tilestore&lt;/container&gt;
 &lt;/cache&gt;
</pre></div>
</div>
<p>This cache again has 3 configuration options: &lt;id&gt;, &lt;secret&gt; and &lt;container&gt;. There are no Azure
specific headers added to the previous example, as the redundancy and access rights are configured
for the container not each individual file in Azure.</p>
</div>
<div class="section" id="google-cloud-storage">
<h4>2.2.3 Google Cloud Storage<a class="headerlink" href="#google-cloud-storage" title="Permalink to this headline">¶</a></h4>
<div class="highlight-python"><div class="highlight"><pre><span></span>&lt;cache name=&quot;google&quot; type=&quot;google&quot;&gt;
   &lt;url&gt;https://storage.googleapis.com/mytiles-mapcache/{tileset}/{grid}/{z}/{x}/{y}.{ext}&lt;/url&gt;
   &lt;access&gt;GOOGPGDWFDG345SDFGSD&lt;/access&gt;
   &lt;secret&gt;sdfgsdSDFwedfwefr2345324dfsGdsfgs&lt;/secret&gt;
   &lt;operation type=&quot;put&quot;&gt;
     &lt;headers&gt;
       &lt;x-amz-acl&gt;public-read&lt;/x-amz-acl&gt;
     &lt;/headers&gt;
   &lt;/operation&gt;
 &lt;/cache&gt;
</pre></div>
</div>
<p>The google implementation uses google&#8217;s S3 compatibility layer (which in practice is different
than mapcache&#8217;s S3 implementation, as it uses a previous version of the authentication/signing
payloads). x-amz-* headers are therefore used to configure options for a given tile file.</p>
</div>
</div>
</div>
<div class="section" id="miscellaneous">
<h2>3. Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>A rest &lt;cache&gt; entry can contain a &lt;use_redirects&gt;true&lt;/use_redirects&gt; entry to inform
mapcache that single tile requests can be returned as a HTTP 302 redirect directly to
the cloud url of the tile rather than being returned by mapcache. This would only typically
be used for fully-seeded caches, as in that case mapcache does not query the cache to know
if the tile is actually present or not.</li>
<li>MapCache opens an HTTP connection to the cloud storage per request. In practice this has
shown to be potentially slow with some providers, the bottleneck being the DNS lookup. To
mitigate this, you can either use an IP address directly in the &lt;url&gt; member, or install a
local DNS caching server (dnsmasq comes to mind). Further developments (awaiting funding) could
implement reusing HTTP connections across requests.</li>
</ul>
<div class="section" id="backwards-incompatibilities">
<h3>3.1 Backwards Incompatibilities<a class="headerlink" href="#backwards-incompatibilities" title="Permalink to this headline">¶</a></h3>
<p>none expected, new functionality</p>
</div>
<div class="section" id="issue-tracking-id">
<h3>3.2 Issue Tracking ID<a class="headerlink" href="#issue-tracking-id" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/mapserver/mapcache/pull/98">https://github.com/mapserver/mapcache/pull/98</a></p>
</div>
<div class="section" id="files-changed">
<h3>3.4 Files Changed<a class="headerlink" href="#files-changed" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>include/mapcache.h</li>
<li>lib/cache_rest.c (added)</li>
<li>lib/hmac-sha.c (added) - used to sign payloads for cloud providers</li>
<li>minor modifications to support &#8220;redirect&#8221; mode</li>
</ul>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 110: MapCache REST Cache Backends</a><ul>
<li><a class="reference internal" href="#motivation">1. Motivation</a></li>
<li><a class="reference internal" href="#implementation-details">2. Implementation details</a><ul>
<li><a class="reference internal" href="#generic-rest-backends">2.2 Generic REST backends</a></li>
<li><a class="reference internal" href="#adding-support-for-well-known-cloud-services">2.2 Adding Support for Well Known Cloud Services</a><ul>
<li><a class="reference internal" href="#amazon-s3">2.2.1 Amazon S3</a></li>
<li><a class="reference internal" href="#microsoft-azure">2.2.2 Microsoft Azure</a></li>
<li><a class="reference internal" href="#google-cloud-storage">2.2.3 Google Cloud Storage</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#miscellaneous">3. Miscellaneous</a><ul>
<li><a class="reference internal" href="#backwards-incompatibilities">3.1 Backwards Incompatibilities</a></li>
<li><a class="reference internal" href="#issue-tracking-id">3.2 Issue Tracking ID</a></li>
<li><a class="reference internal" href="#files-changed">3.4 Files Changed</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Open Source Geospatial Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>