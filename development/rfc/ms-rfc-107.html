<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 107: Support for the edge of pixel (OGC) extent model in MapServer &mdash; MapServer 7.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 108: Dynamic Heatmap (Kernel Density Estimation) Layers" href="ms-rfc-108.html" />
    <link rel="prev" title="MS RFC 106: Support of Geomtransform JavaScript Plugin" href="ms-rfc-106.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../faq.html" title="FAQ">FAQ</a> |
      <a href="../../download.html" title="Download">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        
        
          <a href="../../uk/development/rfc/ms-rfc-107.html"><img src="../../_static/flagicons/uk.png" alt="uk" title="uk" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-108.html" title="MS RFC 108: Dynamic Heatmap (Kernel Density Estimation) Layers"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-106.html" title="MS RFC 106: Support of Geomtransform JavaScript Plugin"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-107-support-for-the-edge-of-pixel-ogc-extent-model-in-mapserver">
<span id="rfc107"></span><h1>MS RFC 107: Support for the edge of pixel (OGC) extent model in MapServer<a class="headerlink" href="#ms-rfc-107-support-for-the-edge-of-pixel-ogc-extent-model-in-mapserver" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2014/01</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Tamas Szekeres</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:szekerest&#37;&#52;&#48;gmail&#46;com">szekerest<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">Draft</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapServer 7.0</td>
</tr>
</tbody>
</table>
<p>This RFC is related to <a class="reference internal" href="ms-rfc-25.html#rfc25"><span>MS RFC 25</span></a> which addresses the same issue,
but we now intend to keep the current edge-of-pixel extent model as well by using
a different implementation proposal.</p>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>According to <a class="reference internal" href="ms-rfc-25.html#rfc25"><span>MS RFC 25</span></a>
&#8220;MapServer uses different pixel and extent model than defined by OGC
services such as WCS and WMS. MapServer uses the center of a pixel to represent
its unique coordinate value. An extent is interpreted as the bounding box that
runs from the center of the UL pixel in an image to the center of the LR pixel
in an image. Why? Well, it goes back to companion software that existed along
side MapServer to display satellite data stored in ERDAS that used the center
to center extent model. The math is simple and there is a certain logic in
having the extent actually represent pixel values - that is, if you render the
extent as a polygon you get the exact edge of the image as one might expect..</p>
<p>On the other hand, OGC service specifications define an extent (BBOX) to refer
to the dimensions of the outside edges of the image being requested. This
appears to be a far more common means of expressing an area of interest.&#8221;</p>
<p>As an attempt for handling the difference between the MapServer and OGC extent models
an adjustment code has been applied in MapServer (ie. in mapwms.c, mapwmslayer.c):</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">minx</span><span class="p">)</span> <span class="o">/</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">minx</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">*</span><span class="mf">0.5</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxx</span> <span class="o">-=</span> <span class="n">dx</span><span class="o">*</span><span class="mf">0.5</span><span class="p">;</span>

<span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">miny</span><span class="p">)</span> <span class="o">/</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">miny</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">*</span><span class="mf">0.5</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxy</span> <span class="o">-=</span> <span class="n">dy</span><span class="o">*</span><span class="mf">0.5</span><span class="p">;</span>
</pre></div>
</div>
<p>But this fix still doesn&#8217;t resolve a couple of issues, like:</p>
<ul class="simple">
<li>The search rectangle is decreased by half pixels at each sides, therefore we get
less amount of information we expect from the MapServer based OGC server</li>
<li>msAdjustExtent still causes extent distortion (especially for small images),
since (width-1)/(height-1) is not equal to width/height.</li>
</ul>
<p>Furthermore, mapscript users may incorrectly assume we use the OGC extent model
(the documentation of setExtent/getExtent doesn&#8217;t seem to provide guidance)
which results in different scales and incorrect width/height adjustments
they would normally expect.</p>
<p>In this RFC I&#8217;m about to provide support for both the OGC extent model and to
the current model which can be selected by a new parameter added to the mapfile.</p>
</div>
<div class="section" id="proposed-solution">
<h2>2. Proposed solution<a class="headerlink" href="#proposed-solution" title="Permalink to this headline">¶</a></h2>
<p>The key point of the implementation is to replace the &#8216;1&#8217; constant values in the
extent/scale calculations with a new pixeladjustment parameter. This parameter can be
defined in the mapfile as:</p>
<div class="highlight-mapfile"><div class="highlight"><pre><span></span><span class="k">MAP</span>
    <span class="c"># 0 for using the OGC extent model 2 for the current edge-of-pixel model</span>
    <span class="err">PIXELADJUSTMENT</span> <span class="mi">0</span>
<span class="p">...</span>
<span class="k">END</span>
</pre></div>
</div>
<p>The value 1 will represent the current (edge of pixel) behaviour
(which will be the default setting), while setting this parameter to 0 will switch
MapServer to use the OGC extent model. The introduction of this new parameter makes
the implementation fairly straightforward not requiring to add quite some
&#8216;if&#8217; conditions in the codebase.</p>
<p>Regarding to the performance, calculating with the new pixeladjustment parameter
in the formula instead of the constant 1 should not result in perceptible degradation.</p>
</div>
<div class="section" id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>The core of this implementation will change the cellsize calculation macro by adding
the new parameter (in mapfile.h) as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cp">#define MS_CELLSIZE(min,max,d,a) ((max - min)/(d-a))</span>
</pre></div>
</div>
<p>and we modify msAdjustExtent (maputil.c):</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">double</span> <span class="nf">msAdjustExtent</span><span class="p">(</span><span class="n">rectObj</span> <span class="o">*</span><span class="n">rect</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixeladjustment</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">cellsize</span><span class="p">,</span> <span class="n">ox</span><span class="p">,</span> <span class="n">oy</span><span class="p">;</span>

  <span class="k">if</span><span class="p">(</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">height</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">cellsize</span> <span class="o">=</span> <span class="n">MS_MAX</span><span class="p">(</span><span class="n">MS_CELLSIZE</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">minx</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxx</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">pixeladjustment</span><span class="p">),</span> <span class="n">MS_CELLSIZE</span><span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">miny</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxy</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixeladjustment</span><span class="p">));</span>

  <span class="k">if</span><span class="p">(</span><span class="n">cellsize</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* avoid division by zero errors */</span>
    <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

  <span class="n">ox</span> <span class="o">=</span> <span class="n">MS_MAX</span><span class="p">(((</span><span class="n">width</span> <span class="o">-</span> <span class="n">pixeladjustment</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">minx</span><span class="p">)</span><span class="o">/</span><span class="n">cellsize</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* these were width-1 and height-1 */</span>
  <span class="n">oy</span> <span class="o">=</span> <span class="n">MS_MAX</span><span class="p">(((</span><span class="n">height</span> <span class="o">-</span> <span class="n">pixeladjustment</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">miny</span><span class="p">)</span><span class="o">/</span><span class="n">cellsize</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

  <span class="n">rect</span><span class="o">-&gt;</span><span class="n">minx</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">minx</span> <span class="o">-</span> <span class="n">ox</span><span class="o">*</span><span class="n">cellsize</span><span class="p">;</span>
  <span class="n">rect</span><span class="o">-&gt;</span><span class="n">miny</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">miny</span> <span class="o">-</span> <span class="n">oy</span><span class="o">*</span><span class="n">cellsize</span><span class="p">;</span>
  <span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxx</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxx</span> <span class="o">+</span> <span class="n">ox</span><span class="o">*</span><span class="n">cellsize</span><span class="p">;</span>
  <span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxy</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">maxy</span> <span class="o">+</span> <span class="n">oy</span><span class="o">*</span><span class="n">cellsize</span><span class="p">;</span>

  <span class="k">return</span><span class="p">(</span><span class="n">cellsize</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and msCalculateScale (mapscale.c):</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">msCalculateScale</span><span class="p">(</span><span class="n">rectObj</span> <span class="n">extent</span><span class="p">,</span> <span class="kt">int</span> <span class="n">units</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixeladjustment</span><span class="p">,</span>  <span class="kt">double</span> <span class="n">resolution</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">scale</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">double</span> <span class="n">md</span><span class="p">,</span> <span class="n">gd</span><span class="p">,</span> <span class="n">center_y</span><span class="p">;</span>

  <span class="cm">/* if((extent.maxx == extent.minx) || (extent.maxy == extent.miny))   */</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">MS_VALID_EXTENT</span><span class="p">(</span><span class="n">extent</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">msSetError</span><span class="p">(</span><span class="n">MS_MISCERR</span><span class="p">,</span> <span class="s">&quot;Invalid image extent, minx=%lf, miny=%lf, maxx=%lf, maxy=%lf.&quot;</span><span class="p">,</span> <span class="s">&quot;msCalculateScale()&quot;</span><span class="p">,</span> <span class="n">extent</span><span class="p">.</span><span class="n">minx</span><span class="p">,</span> <span class="n">extent</span><span class="p">.</span><span class="n">miny</span><span class="p">,</span> <span class="n">extent</span><span class="p">.</span><span class="n">maxx</span><span class="p">,</span> <span class="n">extent</span><span class="p">.</span><span class="n">maxy</span><span class="p">);</span>
    <span class="k">return</span><span class="p">(</span><span class="n">MS_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">((</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">msSetError</span><span class="p">(</span><span class="n">MS_MISCERR</span><span class="p">,</span> <span class="s">&quot;Invalid image width or height.&quot;</span><span class="p">,</span> <span class="s">&quot;msCalculateScale()&quot;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">(</span><span class="n">MS_FAILURE</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">switch</span> <span class="p">(</span><span class="n">units</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span><span class="p">(</span><span class="n">MS_DD</span><span class="p">)</span><span class="o">:</span>
    <span class="k">case</span><span class="p">(</span><span class="n">MS_METERS</span><span class="p">)</span><span class="o">:</span>
    <span class="k">case</span><span class="p">(</span><span class="n">MS_KILOMETERS</span><span class="p">)</span><span class="o">:</span>
    <span class="k">case</span><span class="p">(</span><span class="n">MS_MILES</span><span class="p">)</span><span class="o">:</span>
    <span class="k">case</span><span class="p">(</span><span class="n">MS_NAUTICALMILES</span><span class="p">)</span><span class="o">:</span>
    <span class="k">case</span><span class="p">(</span><span class="n">MS_INCHES</span><span class="p">)</span><span class="o">:</span>
    <span class="k">case</span><span class="p">(</span><span class="n">MS_FEET</span><span class="p">)</span><span class="o">:</span>
      <span class="n">center_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">extent</span><span class="p">.</span><span class="n">miny</span><span class="o">+</span><span class="n">extent</span><span class="p">.</span><span class="n">maxy</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">;</span>
      <span class="n">md</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">pixeladjustment</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">resolution</span><span class="o">*</span><span class="n">msInchesPerUnit</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">center_y</span><span class="p">));</span>
      <span class="n">gd</span> <span class="o">=</span> <span class="n">extent</span><span class="p">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">extent</span><span class="p">.</span><span class="n">minx</span><span class="p">;</span>
      <span class="o">*</span><span class="n">scale</span> <span class="o">=</span> <span class="n">gd</span><span class="o">/</span><span class="n">md</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="o">*</span><span class="n">scale</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* this is not an error */</span>
      <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span><span class="p">(</span><span class="n">MS_SUCCESS</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Most of the further implementation will imply to change of all occurrences of
msAdjustExtent, msCalculateScale and MS_CELLSIZE to provide this new parameter from
the map object. See the following subchapters for the details.</p>
<div class="section" id="adding-pixeladjustment">
<h3>3.1 Adding PIXELADJUSTMENT<a class="headerlink" href="#adding-pixeladjustment" title="Permalink to this headline">¶</a></h3>
<p>A new integer parameter will be added to mapObj (in mapserver.h) and we
will also modify the lexer (maplexer.l, maplexer.c) to recognize this new setting.
The mapfile reader and writer (in mapfile.c, mapfile.h) will be modified to read/write this
new value and initialize the default value of PIXELADJUSTMENT to 1.</p>
</div>
<div class="section" id="modify-the-wms-half-of-pixel-adjustment-code">
<h3>3.2 Modify the WMS half of pixel adjustment code<a class="headerlink" href="#modify-the-wms-half-of-pixel-adjustment-code" title="Permalink to this headline">¶</a></h3>
<p>The OGC adjustment code (mentioned above) should now be changed to:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxx</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">minx</span><span class="p">)</span> <span class="o">/</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">minx</span> <span class="o">+=</span> <span class="n">dx</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxx</span> <span class="o">-=</span> <span class="n">dx</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">;</span>

<span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxy</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">miny</span><span class="p">)</span> <span class="o">/</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">miny</span> <span class="o">+=</span> <span class="n">dy</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">;</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">.</span><span class="n">maxy</span> <span class="o">-=</span> <span class="n">dy</span><span class="o">*</span><span class="mf">0.5</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="provide-pixeladjustment-parameter-for-msadjustextent-and-mscalculatescale-and-ms-cellsize">
<h3>3.3 Provide pixeladjustment parameter for msAdjustExtent and msCalculateScale and MS_CELLSIZE<a class="headerlink" href="#provide-pixeladjustment-parameter-for-msadjustextent-and-mscalculatescale-and-ms-cellsize" title="Permalink to this headline">¶</a></h3>
<p>We enumerate all occurrences of these functions and provide the new parameter
from mapObj-&gt;pixeladjustment or mapServObj-&gt;map-&gt;pixeladjustment.
For the list of all files affected in this change please refer to chapter 4.</p>
</div>
<div class="section" id="modify-the-calculation-of-the-search-rectangle">
<h3>3.4 Modify the calculation of the search rectangle<a class="headerlink" href="#modify-the-calculation-of-the-search-rectangle" title="Permalink to this headline">¶</a></h3>
<p>We should modify the code in some places when searching for the shapes
to utilize the pixeladjustment parameters like:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="cm">/* identify target shapes */</span>
<span class="k">if</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">transform</span> <span class="o">==</span> <span class="n">MS_TRUE</span><span class="p">)</span>
  <span class="n">searchrect</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">extent</span><span class="p">;</span>
<span class="k">else</span> <span class="p">{</span>
  <span class="n">searchrect</span><span class="p">.</span><span class="n">minx</span> <span class="o">=</span> <span class="n">searchrect</span><span class="p">.</span><span class="n">miny</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">searchrect</span><span class="p">.</span><span class="n">maxx</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">;</span>
  <span class="n">searchrect</span><span class="p">.</span><span class="n">maxy</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-msmapcomputegeotransform">
<h3>3.5 Modify msMapComputeGeotransform<a class="headerlink" href="#modify-msmapcomputegeotransform" title="Permalink to this headline">¶</a></h3>
<p>The calclulation should be modified as (in mapobject.c):</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
  <span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">geo_width</span> <span class="o">/</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">);</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
  <span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">geo_height</span> <span class="o">/</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">);</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_x</span>
                          <span class="o">-</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                          <span class="o">-</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>
  <span class="n">sin</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">geo_width</span> <span class="o">/</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">);</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>
  <span class="o">-</span> <span class="n">cos</span><span class="p">(</span><span class="n">rot_angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">geo_height</span> <span class="o">/</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">pixeladjustment</span><span class="p">);</span>
<span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">center_y</span>
                          <span class="o">-</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                          <span class="o">-</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">gt</span><span class="p">.</span><span class="n">geotransform</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
</pre></div>
</div>
</div>
<div class="section" id="mapscript-related-changes">
<h3>3.6 Mapscript related changes<a class="headerlink" href="#mapscript-related-changes" title="Permalink to this headline">¶</a></h3>
<p>We also have a couple of places in the mapscript code where the calls of
msAdjustExtent and msCalculateScale should be updated (see chapter 4 for the details).
We also have to modify the signature of the &#8216;fit&#8217; function for the rect object as follows:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">double</span> <span class="nf">fit</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pixeladjustment</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span>  <span class="n">msAdjustExtent</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">pixeladjustment</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="files-affected">
<h2>4. Files affected<a class="headerlink" href="#files-affected" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>mapchart.c: Modify the calculation of the search rectangle (see 3.4)</li>
<li>mapcluster.c: Modify the calculation of the search rectangle (see 3.4)</li>
<li>mapdraw.c: Modify the calls of msAdjustExtent and msCalculateScale (see 3.3)</li>
<li>mapfile.c: Mofify the reader/writer (see 3.1)</li>
<li>mapfile.h: Define PIXELAJUSTMENT</li>
<li>mapgraticule.c: Modify the call of msAdjustExtent (3.3) and the search rectangle (3.4)</li>
<li>maplegend.c: Modify the calls of msAdjustExtent and msCalculateScale (see 3.3)</li>
<li>maplexer.c: Add support for reading PIXELADJUSTTMENT (see 3.1)</li>
<li>maplexer.l: Add support for reading PIXELADJUSTTMENT (see 3.1)</li>
<li>mapobject.c: Modify the calls of msAdjustExtent and msCalculateScale (3.3), modify msMapComputeGeotransform (3.5)</li>
<li>mapquery.c: Modify the calls of msAdjustExtent and MS_CELLSIZE (see 3.3)</li>
<li>mapraster.c: Modify the call of msAdjustExtent (see 3.3)</li>
<li>maprasterquery.c: Modify the call of msAdjustExtent (see 3.3)</li>
<li>mapscale.c: Implement changes in msCalculateScale (see chapter 3) and modify calls (3.3)</li>
<li>mapserver.h: Implement changes in MS_CELLSIZE, add pixeladjustment to mapObj, modify the calls of msAdjustExtent and msCalculateScale</li>
<li>mapservutil.c: Modify the calls of msAdjustExtent, MS_CELLSOZE and msCalculateScale (see 3.3)</li>
<li>maptemplate.c: Modify the calculations in setExtent (FROMIMGBOX, FROMIMGPNT, FROMREFPNT, FROMSCALE), change the call of msAdjustExtent in checkWebScale</li>
<li>maptile.c: Modify the adjustment code in msTileSetExtent (see 3.2)</li>
<li>maputil.c: Implement changes in msAdjustExtent (see chapter 3)</li>
<li>mapuvraster.c: Modify the cellsize and the extent calculation in msUVRASTERLayerWhichShapes</li>
<li>mapwcs.c: Modify msWCSGetCoverage to include pixeladjustment in the formula when recomputing the BBOX.</li>
<li>mapwms.c: Modify the adjustment code (3.2) and msAdjustExtent and MS_CELLSIZE calls (3.3)</li>
<li>mapwmslayer.c: Modify the adjustment code (3.2) and msCalculateScale and MS_CELLSIZE calls (3.3)</li>
<li>mapscript/swiginc/map.i: Modify the call of msCalculateScale (see 3.3)</li>
<li>mapscript/swiginc/mapzoom.i: Modify the calls of msAdjustExtent and msCalculateScale (see 3.6)</li>
<li>mapscript/swiginc/rect.i: Modify the signature of &#8216;fit&#8217; (see 3.6)</li>
<li>mapscript/php/map.c: Modify the calls of msAdjustExtent and msCalculateScale (see 3.6)</li>
<li>mapscript/php/mapscript_i.c: Modify the calls of msCalculateScale, modify the signature of &#8216;fit&#8217; (see 3.6)</li>
</ul>
</div>
<div class="section" id="backwards-compatibility-issues">
<h2>5. Backwards Compatibility Issues<a class="headerlink" href="#backwards-compatibility-issues" title="Permalink to this headline">¶</a></h2>
<p>The default value of PIXELADJUSTMENT will keep the current behaviour with regards
the the calculation, but we need to modify the signature of the mapscript
function: &#8216;fit&#8217;.</p>
</div>
<div class="section" id="bug-id">
<h2>6. Bug ID<a class="headerlink" href="#bug-id" title="Permalink to this headline">¶</a></h2>
<p>TBD</p>
</div>
<div class="section" id="voting-history">
<h2>7. Voting history<a class="headerlink" href="#voting-history" title="Permalink to this headline">¶</a></h2>
<p>TBD</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 107: Support for the edge of pixel (OGC) extent model in MapServer</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-solution">2. Proposed solution</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a><ul>
<li><a class="reference internal" href="#adding-pixeladjustment">3.1 Adding PIXELADJUSTMENT</a></li>
<li><a class="reference internal" href="#modify-the-wms-half-of-pixel-adjustment-code">3.2 Modify the WMS half of pixel adjustment code</a></li>
<li><a class="reference internal" href="#provide-pixeladjustment-parameter-for-msadjustextent-and-mscalculatescale-and-ms-cellsize">3.3 Provide pixeladjustment parameter for msAdjustExtent and msCalculateScale and MS_CELLSIZE</a></li>
<li><a class="reference internal" href="#modify-the-calculation-of-the-search-rectangle">3.4 Modify the calculation of the search rectangle</a></li>
<li><a class="reference internal" href="#modify-msmapcomputegeotransform">3.5 Modify msMapComputeGeotransform</a></li>
<li><a class="reference internal" href="#mapscript-related-changes">3.6 Mapscript related changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#files-affected">4. Files affected</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">5. Backwards Compatibility Issues</a></li>
<li><a class="reference internal" href="#bug-id">6. Bug ID</a></li>
<li><a class="reference internal" href="#voting-history">7. Voting history</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Open Source Geospatial Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>