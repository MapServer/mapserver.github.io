<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 109: Optimizing Runtime Substitutions &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 110: MapCache REST Cache Backends" href="ms-rfc-110.html" />
    <link rel="prev" title="MS RFC 108: Dynamic Heatmap (Kernel Density Estimation) Layers" href="ms-rfc-108.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-110.html" title="MS RFC 110: MapCache REST Cache Backends"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-108.html" title="MS RFC 108: Dynamic Heatmap (Kernel Density Estimation) Layers"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 109: Optimizing Runtime Substitutions</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-109-optimizing-runtime-substitutions">
<span id="rfc109"></span><h1>MS RFC 109: Optimizing Runtime Substitutions<a class="headerlink" href="#ms-rfc-109-optimizing-runtime-substitutions" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2014/03</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Thomas Bonfort</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="mailto:tbonfort&#37;&#52;&#48;terriscope&#46;fr">tbonfort<span>&#64;</span>terriscope<span>&#46;</span>fr</a></p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Adopted</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>MapServer 7.0</p>
</dd>
<dt class="field-even">Amended<span class="colon">:</span></dt>
<dd class="field-even"><p>2015/02</p>
</dd>
<dt class="field-odd">Last Updated<span class="colon">:</span></dt>
<dd class="field-odd"><p>2014/03/07</p>
</dd>
</dl>
<section id="motivation">
<h2>1. Motivation<a class="headerlink" href="#motivation" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>While profiling the WMS shootout queries, a noticeable amount of time was
spent in the <a class="reference internal" href="../../cgi/runsub.html#runsub"><span class="std std-ref">Run-time Substitution</span></a> code, even though the functionality was not being
used at all. As runtime substitutions apply to <strong>all</strong> mapserv requests, an
optimization in this part of the code is beneficial for all mapserv
operations.</p></li>
<li><p>For some specific cases, there can be the need to apply runtime substitutions
inside metadata entries (e.g. modify ows_enable_request when using a proxy
between mapserver and the client, to enable specific operations for
authenticated clients). The current implementation prohibits this as it would
put a far too noticeable hit on performance.</p></li>
</ul>
</section>
<section id="proposed-rewrite">
<h2>2. Proposed Rewrite<a class="headerlink" href="#proposed-rewrite" title="Link to this heading">¶</a></h2>
<p>In pseudo-code, the current algorithm is: (KVP stands for key-value-pair, and
is one of the parameters passed in the URL to mapserver, e.g.
…&amp;map=path/to/mapfile.map&amp;…)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foreach</span> <span class="n">KVP</span><span class="p">:</span>
  <span class="n">foreach</span> <span class="n">outputformat</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">KVP</span> <span class="n">appears</span> <span class="ow">in</span> <span class="s2">&quot;FILENAME&quot;</span> <span class="n">formatoption</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">KVP</span> <span class="n">validates</span> <span class="n">against</span> <span class="n">MAP_</span><span class="o">&gt;</span><span class="n">WEB</span><span class="o">-&gt;</span><span class="n">VALIDATION</span><span class="p">:</span>
        <span class="n">apply</span> <span class="n">substitution</span>

  <span class="n">foreach</span> <span class="n">layer</span><span class="p">:</span>
    <span class="n">foreach</span> <span class="n">class</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">KVP</span> <span class="n">appears</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">substitutable</span> <span class="n">CLASS</span> <span class="n">keyword</span> <span class="p">(</span><span class="n">EXPRESSION</span><span class="p">,</span> <span class="n">TEXT</span><span class="p">,</span> <span class="n">TITLE</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">KVP</span> <span class="n">validates</span> <span class="n">against</span> <span class="n">CLASS</span><span class="o">-&gt;</span><span class="n">VALIDATION</span><span class="p">:</span>
          <span class="n">apply</span> <span class="n">substitution</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">KVP</span> <span class="n">validates</span> <span class="n">against</span> <span class="n">LAYER</span><span class="o">-&gt;</span><span class="n">VALIDATION</span><span class="p">:</span>
          <span class="n">apply</span> <span class="n">substitution</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">KVP</span> <span class="n">validates</span> <span class="n">against</span> <span class="n">MAP</span><span class="o">-&gt;</span><span class="n">WEB</span><span class="o">-&gt;</span><span class="n">VALIDATION</span><span class="p">:</span>
          <span class="n">apply</span> <span class="n">substitution</span>
      <span class="k">if</span> <span class="n">KVP</span> <span class="n">appears</span> <span class="ow">in</span> <span class="n">a</span> <span class="n">substitutable</span> <span class="n">LAYER</span> <span class="n">keyword</span> <span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">CONNECTION</span><span class="p">,</span> <span class="n">FILTER</span><span class="p">,</span> <span class="n">TILEINDEX</span><span class="p">):</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">KVP</span> <span class="n">validates</span> <span class="n">against</span> <span class="n">LAYER</span><span class="o">-&gt;</span><span class="n">VALIDATION</span><span class="p">:</span>
          <span class="n">apply</span> <span class="n">substitution</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">KVP</span> <span class="n">validates</span> <span class="n">against</span> <span class="n">MAP</span><span class="o">-&gt;</span><span class="n">WEB</span><span class="o">-&gt;</span><span class="n">VALIDATION</span><span class="p">:</span>
          <span class="n">apply</span> <span class="n">substitution</span>
</pre></div>
</div>
<p>For a typical request where the number of KVPs is relatively high (e.g. all OWS
requests) and where the number of layers/classes is also relatively high, this
results in a very large number of strcasestr calls being made for the “if KVP
appears in XXX keyword” parts. These happen whether or not actual runtime
substitutions are going to be used or not.</p>
<p>With this RFC, we will be switching to this pseudo-code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foreach</span> <span class="n">layer</span><span class="p">:</span>
  <span class="n">foreach</span> <span class="n">class</span><span class="p">:</span>
    <span class="n">foreach</span> <span class="n">class</span><span class="o">-&gt;</span><span class="n">validation</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">validation_key</span> <span class="ow">in</span> <span class="n">kvp</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kvp</span> <span class="n">validates</span><span class="p">:</span>
          <span class="n">apply</span> <span class="k">class</span> <span class="nc">substitutions</span>
  <span class="n">foreach</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">validation</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">validation_key</span> <span class="ow">in</span> <span class="n">kvp</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">kvp</span> <span class="n">validates</span><span class="p">:</span>
        <span class="n">apply</span> <span class="n">layer</span> <span class="n">substitutions</span>
        <span class="n">foreach</span> <span class="n">class</span><span class="p">:</span>
          <span class="n">apply</span> <span class="k">class</span> <span class="nc">substitutions</span>
<span class="n">foreach</span> <span class="nb">map</span><span class="o">-&gt;</span><span class="n">web</span><span class="o">-&gt;</span><span class="n">validation</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">validation_key</span> <span class="ow">in</span> <span class="n">kvp</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">kvp</span> <span class="n">validates</span><span class="p">:</span>
      <span class="n">apply</span> <span class="n">outputformat</span> <span class="n">validations</span>
      <span class="n">foreach</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">apply</span> <span class="n">layer</span> <span class="n">substitutions</span>
        <span class="n">foreach</span> <span class="n">class</span><span class="p">:</span>
          <span class="n">apply</span> <span class="k">class</span> <span class="nc">substitutions</span>
</pre></div>
</div>
<p>This has the advantage of requiring very little overhead if no substitutions
are in use, and somewhat simplifying the code. This optimization becomes
possible because we require VALIDATION entries to be present (since 6.0).</p>
</section>
<section id="miscellaneous">
<h2>3. Miscellaneous<a class="headerlink" href="#miscellaneous" title="Link to this heading">¶</a></h2>
<p>In exchange for this speedup, we now allow substitutions to occur on
layer-&gt;metadata and map-&gt;web-&gt;metadata entries, which would have had a too
large impact on performance with the previous method. We can also imagine
adding substitutions to other mapfile elements, now that the cost of this
operation does not impact performance when not in use.</p>
<p>For performance reasons, validations should be put in the validation block
“closest” to where they will actually be used. Putting a validation in
map-&gt;web-&gt;validation is practical as it will apply to the whole mapfile, it
however will behave slightly slower than duplicating it in the needed
layer/class validations.</p>
<p>Update from 2015/02, with +1 from ThomasB, StephanM, DanielM, MikeS and SteveW:
As discussed on the email list, this RFC is extended with the two following features:</p>
<ul class="simple">
<li><p>Allow substitutions to happen in PROCESSING entries (needed for RFC91
native filters, could also be used to e.g. allow to dynamically set resampling
methods for raster layers)</p></li>
<li><p>Allow substitution values to be read in priority from an envirronment variable.
This would allow a server administrator to set substitutions based on a user id, etc…
As an envirronment lookup would only happen if the mapfile contains the corresponding
entry in a VALIDATION block, this feature would not allow the global environment to
be leaked, unless the user has chosen a substitution key that matches an existing
environment value. Note that a key from the envirronment would take precedence over
the same key passed in the URL.</p></li>
</ul>
<section id="backwards-incompatibilities">
<h3>3.1 Backwards Incompatibilities<a class="headerlink" href="#backwards-incompatibilities" title="Link to this heading">¶</a></h3>
<p>As substitutions can now apply to metadata, there is a potential
incompatibility for this uncommon scenario:</p>
<blockquote>
<div><ul class="simple">
<li><p>a metadata block contains a %variable% substring in one of its entries</p></li>
<li><p><strong>and</strong> the mapfile contains a VALIDATION block for the “variable” runsub.</p></li>
</ul>
</div></blockquote>
<p>In this case, a substitution will occur if variable=foo is present in the URL,
whereas this would not have been the case beforehand.</p>
</section>
<section id="issue-tracking-id">
<h3>3.2 Issue Tracking ID<a class="headerlink" href="#issue-tracking-id" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://github.com/MapServer/MapServer/pull/4877">https://github.com/MapServer/MapServer/pull/4877</a></p>
<p>see also:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/4596">https://github.com/MapServer/MapServer/issues/4596</a></p></li>
</ul>
</section>
<section id="voting-history">
<h3>3.3 Voting History<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h3>
<p>+1 from ThomasB, TomK, SteveW, YewondwossenA, SteveL, PerryN, MikeS, JeffM and StephanM</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 109: Optimizing Runtime Substitutions</a><ul>
<li><a class="reference internal" href="#motivation">1. Motivation</a></li>
<li><a class="reference internal" href="#proposed-rewrite">2. Proposed Rewrite</a></li>
<li><a class="reference internal" href="#miscellaneous">3. Miscellaneous</a><ul>
<li><a class="reference internal" href="#backwards-incompatibilities">3.1 Backwards Incompatibilities</a></li>
<li><a class="reference internal" href="#issue-tracking-id">3.2 Issue Tracking ID</a></li>
<li><a class="reference internal" href="#voting-history">3.3 Voting History</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-110.html" title="MS RFC 110: MapCache REST Cache Backends"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-108.html" title="MS RFC 108: Dynamic Heatmap (Kernel Density Estimation) Layers"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 109: Optimizing Runtime Substitutions</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>