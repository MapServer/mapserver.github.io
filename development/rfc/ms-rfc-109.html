<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 109: Optimizing Runtime Substitutions &mdash; MapServer 7.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 110: MapCache REST Cache Backends" href="ms-rfc-110.html" />
    <link rel="prev" title="MS RFC 108: Dynamic Heatmap (Kernel Density Estimation) Layers" href="ms-rfc-108.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../faq.html" title="FAQ">FAQ</a> |
      <a href="../../download.html" title="Download">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        
        
          <a href="../../uk/development/rfc/ms-rfc-109.html"><img src="../../_static/flagicons/uk.png" alt="uk" title="uk" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-110.html" title="MS RFC 110: MapCache REST Cache Backends"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-108.html" title="MS RFC 108: Dynamic Heatmap (Kernel Density Estimation) Layers"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-109-optimizing-runtime-substitutions">
<span id="rfc109"></span><h1>MS RFC 109: Optimizing Runtime Substitutions<a class="headerlink" href="#ms-rfc-109-optimizing-runtime-substitutions" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2014/03</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Thomas Bonfort</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:tbonfort&#37;&#52;&#48;terriscope&#46;fr">tbonfort<span>&#64;</span>terriscope<span>&#46;</span>fr</a></td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">Adopted</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapServer 7.0</td>
</tr>
<tr class="field-even field"><th class="field-name">Amended:</th><td class="field-body">2015/02</td>
</tr>
<tr class="field-odd field"><th class="field-name">Last Updated:</th><td class="field-body">2014/03/07</td>
</tr>
</tbody>
</table>
<div class="section" id="motivation">
<h2>1. Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>While profiling the WMS shootout queries, a noticeable amount of time was
spent in the <a class="reference internal" href="../../cgi/runsub.html#runsub"><span>Run-time Substitution</span></a> code, even though the functionality was not being
used at all. As runtime substitutions apply to <strong>all</strong> mapserv requests, an
optimization in this part of the code is beneficial for all mapserv
operations.</li>
<li>For some specific cases, there can be the need to apply runtime substitutions
inside metadata entries (e.g. modify ows_enable_request when using a proxy
between mapserver and the client, to enable specific operations for
authenticated clients). The current implementation prohibits this as it would
put a far too noticeable hit on performance.</li>
</ul>
</div>
<div class="section" id="proposed-rewrite">
<h2>2. Proposed Rewrite<a class="headerlink" href="#proposed-rewrite" title="Permalink to this headline">¶</a></h2>
<p>In pseudo-code, the current algorithm is: (KVP stands for key-value-pair, and
is one of the parameters passed in the URL to mapserver, e.g.
...&amp;map=path/to/mapfile.map&amp;...)</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>foreach KVP:
  foreach outputformat:
    if KVP appears in &quot;FILENAME&quot; formatoption:
      if KVP validates against MAP_&gt;WEB-&gt;VALIDATION:
        apply substitution

  foreach layer:
    foreach class:
      if KVP appears in a substitutable CLASS keyword (EXPRESSION, TEXT, TITLE):
        if KVP validates against CLASS-&gt;VALIDATION:
          apply substitution
        else if KVP validates against LAYER-&gt;VALIDATION:
          apply substitution
        else if KVP validates against MAP-&gt;WEB-&gt;VALIDATION:
          apply substitution
      if KVP appears in a substitutable LAYER keyword (DATA, CONNECTION, FILTER, TILEINDEX):
        else if KVP validates against LAYER-&gt;VALIDATION:
          apply substitution
        else if KVP validates against MAP-&gt;WEB-&gt;VALIDATION:
          apply substitution
</pre></div>
</div>
<p>For a typical request where the number of KVPs is relatively high (e.g. all OWS
requests) and where the number of layers/classes is also relatively high, this
results in a very large number of strcasestr calls being made for the &#8220;if KVP
appears in XXX keyword&#8221; parts. These happen whether or not actual runtime
substitutions are going to be used or not.</p>
<p>With this RFC, we will be switching to this pseudo-code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>foreach layer:
  foreach class:
    foreach class-&gt;validation:
      if validation_key in kvp:
        if kvp validates:
          apply class substitutions
  foreach layer-&gt;validation:
    if validation_key in kvp:
      if kvp validates:
        apply layer substitutions
        foreach class:
          apply class substitutions
foreach map-&gt;web-&gt;validation:
  if validation_key in kvp:
    if kvp validates:
      apply outputformat validations
      foreach layer:
        apply layer substitutions
        foreach class:
          apply class substitutions
</pre></div>
</div>
<p>This has the advantage of requiring very little overhead if no substitutions
are in use, and somewhat simplifying the code. This optimization becomes
possible because we require VALIDATION entries to be present (since 6.0).</p>
</div>
<div class="section" id="miscellaneous">
<h2>3. Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h2>
<p>In exchange for this speedup, we now allow substitutions to occur on
layer-&gt;metadata and map-&gt;web-&gt;metadata entries, which would have had a too
large impact on performance with the previous method. We can also imagine
adding substitutions to other mapfile elements, now that the cost of this
operation does not impact performance when not in use.</p>
<p>For performance reasons, validations should be put in the validation block
&#8220;closest&#8221; to where they will actually be used. Putting a validation in
map-&gt;web-&gt;validation is practical as it will apply to the whole mapfile, it
however will behave slightly slower than duplicating it in the needed
layer/class validations.</p>
<p>Update from 2015/02, with +1 from ThomasB, StephanM, DanielM, MikeS and SteveW:
As discussed on the email list, this RFC is extended with the two following features:</p>
<ul class="simple">
<li>Allow substitutions to happen in PROCESSING entries (needed for RFC91
native filters, could also be used to e.g. allow to dynamically set resampling
methods for raster layers)</li>
<li>Allow substitution values to be read in priority from an envirronment variable.
This would allow a server administrator to set substitutions based on a user id, etc...
As an envirronment lookup would only happen if the mapfile contains the corresponding
entry in a VALIDATION block, this feature would not allow the global environment to
be leaked, unless the user has chosen a substitution key that matches an existing
environment value. Note that a key from the envirronment would take precedence over
the same key passed in the URL.</li>
</ul>
<div class="section" id="backwards-incompatibilities">
<h3>3.1 Backwards Incompatibilities<a class="headerlink" href="#backwards-incompatibilities" title="Permalink to this headline">¶</a></h3>
<p>As substitutions can now apply to metadata, there is a potential
incompatibility for this uncommon scenario:</p>
<blockquote>
<div><ul class="simple">
<li>a metadata block contains a %variable% substring in one of its entries</li>
<li><strong>and</strong> the mapfile contains a VALIDATION block for the &#8220;variable&#8221; runsub.</li>
</ul>
</div></blockquote>
<p>In this case, a substitution will occur if variable=foo is present in the URL,
whereas this would not have been the case beforehand.</p>
</div>
<div class="section" id="issue-tracking-id">
<h3>3.2 Issue Tracking ID<a class="headerlink" href="#issue-tracking-id" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://github.com/mapserver/mapserver/pull/4877">https://github.com/mapserver/mapserver/pull/4877</a></p>
<p>see also:</p>
<ul class="simple">
<li><a class="reference external" href="https://github.com/mapserver/mapserver/issues/4596">https://github.com/mapserver/mapserver/issues/4596</a></li>
</ul>
</div>
<div class="section" id="voting-history">
<h3>3.3 Voting History<a class="headerlink" href="#voting-history" title="Permalink to this headline">¶</a></h3>
<p>+1 from ThomasB, TomK, SteveW, YewondwossenA, SteveL, PerryN, MikeS, JeffM and StephanM</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 109: Optimizing Runtime Substitutions</a><ul>
<li><a class="reference internal" href="#motivation">1. Motivation</a></li>
<li><a class="reference internal" href="#proposed-rewrite">2. Proposed Rewrite</a></li>
<li><a class="reference internal" href="#miscellaneous">3. Miscellaneous</a><ul>
<li><a class="reference internal" href="#backwards-incompatibilities">3.1 Backwards Incompatibilities</a></li>
<li><a class="reference internal" href="#issue-tracking-id">3.2 Issue Tracking ID</a></li>
<li><a class="reference internal" href="#voting-history">3.3 Voting History</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Open Source Geospatial Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>