<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 33: Removing msLayerWhichItems() from maplayer.c &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 34: MapServer Release Manager and Release Process" href="ms-rfc-34.html" />
    <link rel="prev" title="MS RFC 32: Support for Anti-Grain Geometry (AGG) Rendering Engine" href="ms-rfc-32.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-33.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-34.html" title="MS RFC 34: MapServer Release Manager and Release Process"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-32.html" title="MS RFC 32: Support for Anti-Grain Geometry (AGG) Rendering Engine"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 33: Removing msLayerWhichItems() from maplayer.c</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-33-removing-mslayerwhichitems-from-maplayer-c">
<span id="rfc33"></span><h1>MS RFC 33: Removing msLayerWhichItems() from maplayer.c<a class="headerlink" href="#ms-rfc-33-removing-mslayerwhichitems-from-maplayer-c" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2007/07/09</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Steve Lime</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p>steve.lime at dnr.state.mn.us</p>
</dd>
<dt class="field-even">Last Edited<span class="colon">:</span></dt>
<dd class="field-even"><p>2007/07/09</p>
</dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><p>draft</p>
</dd>
<dt class="field-even">Version<span class="colon">:</span></dt>
<dd class="field-even"><p>MapServer 5.0</p>
</dd>
</dl>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The function msLayerWhichItems() is a function in maplayer.c that determines
exactly which feature attributes need to be retrieved from a given data
source. All item-based properties (e.g. CLASSITEM, bound properties,
EXPRESSIONs, etc…) are checked and a list (an array) is compiled. At
the same time index references are made (e.g. classitemindex, labelitemindex,
etc…). The item indexes are used instead of names to access attribute values
at runtime.</p>
<p>The problem with this method is that a feature (a shapeObj) used for drawing
or the first pass of a query is not the same as that used for presentation
(the second pass of a query). The second pass of a query uses
msLayerGetShape() which by default requests all attributes of a feature since
we don’t know ahead of time which attributes might be output.</p>
<p>By removing msLayerWhichItems() and always retrieving all attributes a feature
is a feature whether drawing, querying or outputting via a template so caching
features now becomes practical.</p>
</section>
<section id="technical-solution">
<h2>Technical Solution<a class="headerlink" href="#technical-solution" title="Link to this heading">¶</a></h2>
<p>As mentioned earlier msLayerWhichItems() does a couple of things. Some of
these functions would need to be retained somehow and are described below.</p>
<ol class="arabic simple">
<li><p>Layer items array: this array normally would be populated by the
msLayerWhichItems() call. Instead it should be populated as a layer is opened
in msLayerOpen. (makes sense?)</p></li>
<li><p>Index references: linking a attribute name to an index value would have to
happen during the course of rendering or querying instead of ahead of time.
Basically code that uses attributes would have to first check if the parameter
is not NULL, and then if the index reference is not set it would have to call
a function like that shown below. While this affects a good number of places
in the code base the change is relatively minor. The use of attribute binding
isolates much of this code so this change is smaller for version 5.0 that it
otherwise would have been.</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>int msGetItemIndex(char **itemlist, int numitems, char *item) {
  int i;

  if (!itemlist || numitems &lt;= 0 || !item) return -1;

  for (i=0; i&lt;numitems; i++)
    if(strcasecmp(itemlist[i], item) return i;

  return -1; /* failure */
}
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Logical expression handling: expressions maintain their own individual list
of items to process so like 2 above this list would have to be created during
processing. The code to do this exists as part of msLayerWhichItems() and
would be retained under some other name.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>this RFC does not address single pass queries, but rather sets the
stage for them. Subsequent drawing, query and template output processes would
remain unaltered.</p>
</div>
</section>
<section id="general-c-api-changes">
<h2>General C API Changes<a class="headerlink" href="#general-c-api-changes" title="Link to this heading">¶</a></h2>
<p>maplayer.c - msLayerWhichItems() goes away. msLayerOpen() now sets the
layer-&gt;items array.</p>
<p>maputil.c - Binding functions now must assign index references when executed.
Same goes for the functions to assign a classObj to a feature.</p>
<p>mapdraw.c - Layeritemindex and classitemindex must now be dynamically assigned
values.</p>
</section>
<section id="input-driver-changes">
<h2>Input Driver Changes<a class="headerlink" href="#input-driver-changes" title="Link to this heading">¶</a></h2>
<p>It is unclear how each driver made use of the output of msLayerWhichItems().
It may be as easy as calling msLayerGetItems() instead of using
msLayerGetItemInfo() in msLayerOpen() in which case we’d loose the
msLayerGetItemInfo() function for each driver too (and the main wrapper
function). TODO…</p>
<p>mapshape.c -
mapsde.c -
mapogr.cpp -
mappostgis.c -
maporaclespatial.c -
mapmygis.c -</p>
</section>
<section id="mapscript">
<h2>MapScript<a class="headerlink" href="#mapscript" title="Link to this heading">¶</a></h2>
<p>No changes.</p>
</section>
<section id="mapfiles">
<h2>Mapfiles<a class="headerlink" href="#mapfiles" title="Link to this heading">¶</a></h2>
<p>No changes anticipated.</p>
</section>
<section id="backwards-compatibility-issues">
<h2>Backwards Compatibility Issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>None. This is a new feature.</p>
</section>
<section id="bug-id">
<h2>Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<p>None assigned.</p>
</section>
<section id="voting-history">
<h2>Voting History<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>None</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 33: Removing msLayerWhichItems() from maplayer.c</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#technical-solution">Technical Solution</a></li>
<li><a class="reference internal" href="#general-c-api-changes">General C API Changes</a></li>
<li><a class="reference internal" href="#input-driver-changes">Input Driver Changes</a></li>
<li><a class="reference internal" href="#mapscript">MapScript</a></li>
<li><a class="reference internal" href="#mapfiles">Mapfiles</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">Backwards Compatibility Issues</a></li>
<li><a class="reference internal" href="#bug-id">Bug ID</a></li>
<li><a class="reference internal" href="#voting-history">Voting History</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-34.html" title="MS RFC 34: MapServer Release Manager and Release Process"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-32.html" title="MS RFC 32: Support for Anti-Grain Geometry (AGG) Rendering Engine"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 33: Removing msLayerWhichItems() from maplayer.c</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>