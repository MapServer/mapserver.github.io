<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 88: Saving MapServer Objects to Strings &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 89: Layer Geomtransforms" href="ms-rfc-89.html" />
    <link rel="prev" title="MS RFC 87: Bitmap pattern support" href="ms-rfc-87.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-88.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-89.html" title="MS RFC 89: Layer Geomtransforms"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-87.html" title="MS RFC 87: Bitmap pattern support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 88: Saving MapServer Objects to Strings</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-88-saving-mapserver-objects-to-strings">
<span id="rfc88"></span><h1>MS RFC 88: Saving MapServer Objects to Strings<a class="headerlink" href="#ms-rfc-88-saving-mapserver-objects-to-strings" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2013/01/15</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Tamas Szekeres</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p>szekerest at gmail.com</p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Accepted (2013/03/02), Implemented</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>MapServer 6.3-dev</p>
</dd>
</dl>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>This RFC provides the option to save map objects to strings as mapfile string fragments.
This functionality will mainly be utilized in MapScript and a new method (convertToString)
will be added to the corresponding objects. This new method will provide the inverse option
for updateFromString that has already been added within the scope of RFC 31.</p>
</section>
<section id="proposed-solution">
<h2>2. Proposed Solution<a class="headerlink" href="#proposed-solution" title="Link to this heading">¶</a></h2>
<p>The solution will utilize the existing msIO machinery when writing mapfiles. The key point
of the implementation is to replace all occurrences of fprintf with msIO_fprintf in mapfile.c
and mapsymbol.c. This replacement will establish the option to redirect mapfile writes to a buffer.</p>
</section>
<section id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
<p>Assuming the replacement of fprintf is done, writing objects to strings could be implemented
by adding a new function for each object type something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">char</span><span class="o">*</span> <span class="n">msWriteLayerToString</span><span class="p">(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">msIOContext</span>  <span class="n">context</span><span class="p">;</span>
  <span class="n">msIOBuffer</span> <span class="n">buffer</span><span class="p">;</span>

  <span class="n">context</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
  <span class="n">context</span><span class="o">.</span><span class="n">write_channel</span> <span class="o">=</span> <span class="n">MS_TRUE</span><span class="p">;</span>
  <span class="n">context</span><span class="o">.</span><span class="n">readWriteFunc</span> <span class="o">=</span> <span class="n">msIO_bufferWrite</span><span class="p">;</span>
  <span class="n">context</span><span class="o">.</span><span class="n">cbData</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">;</span>
  <span class="n">buffer</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
  <span class="n">buffer</span><span class="o">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">buffer</span><span class="o">.</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">msIO_installHandlers</span><span class="p">(</span> <span class="n">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">context</span><span class="p">,</span> <span class="n">NULL</span> <span class="p">);</span>

  <span class="n">writeLayer</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">layer</span><span class="p">);</span>
  <span class="n">msIO_bufferWrite</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

  <span class="n">msIO_installHandlers</span><span class="p">(</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">NULL</span> <span class="p">);</span>

  <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The owneship of the returned buffer is passed to the caller, so we should hook this function
in layer.i as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">newobject</span> <span class="n">convertToString</span><span class="p">;</span>
<span class="n">char</span><span class="o">*</span> <span class="n">convertToString</span><span class="p">()</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">msWriteLayerToString</span><span class="p">(</span><span class="bp">self</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In order to implement the writer for mapObj (msWriteMapToString) we will require to isolate
the bulk of the writing code in a separate function writeMap from msSaveMap.
In this regard msSaveMap will now look something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>int msSaveMap(mapObj *map, char *filename)
{
  FILE *stream;
  char szPath[MS_MAXPATHLEN];

  if(!map) {
    msSetError(MS_MISCERR, &quot;Map is undefined.&quot;, &quot;msSaveMap()&quot;);
    return(-1);
  }

  if(!filename) {
    msSetError(MS_MISCERR, &quot;Filename is undefined.&quot;, &quot;msSaveMap()&quot;);
    return(-1);
  }

  stream = fopen(msBuildPath(szPath, map-&gt;mappath, filename), &quot;w&quot;);
  if(!stream) {
    msSetError(MS_IOERR, &quot;(%s)&quot;, &quot;msSaveMap()&quot;, filename);
    return(-1);
  }

  writeMap(stream, 0, map);
  fclose(stream);

  return(0);
}
</pre></div>
</div>
<p>As the result of this implementation the following new functions will be exposed in mapserver.h</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteLayerToString</span><span class="p">(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">);</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteMapToString</span><span class="p">(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">);</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteClassToString</span><span class="p">(</span><span class="n">classObj</span> <span class="o">*</span><span class="n">_class</span><span class="p">);</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteStyleToString</span><span class="p">(</span><span class="n">styleObj</span> <span class="o">*</span><span class="n">style</span><span class="p">);</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteLabelToString</span><span class="p">(</span><span class="n">labelObj</span> <span class="o">*</span><span class="n">label</span><span class="p">)</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteWebToString</span><span class="p">(</span><span class="n">webObj</span> <span class="o">*</span><span class="n">web</span><span class="p">)</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteScalebarToString</span><span class="p">(</span><span class="n">scalebarObj</span> <span class="o">*</span><span class="n">scalebar</span><span class="p">)</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteQueryMapToString</span><span class="p">(</span><span class="n">queryMapObj</span> <span class="o">*</span><span class="n">querymap</span><span class="p">)</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteReferenceMapToString</span><span class="p">(</span><span class="n">referenceMapObj</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteLegendToString</span><span class="p">(</span><span class="n">legendObj</span> <span class="o">*</span><span class="n">legend</span><span class="p">)</span>
<span class="n">MS_DLL_EXPORT</span> <span class="n">char</span> <span class="o">*</span><span class="n">msWriteClusterToString</span><span class="p">(</span><span class="n">clusterObj</span> <span class="o">*</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="files-affected">
<h2>4. Files Affected<a class="headerlink" href="#files-affected" title="Link to this heading">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p>mapserver.h: Expose msWriteXXXToString methods</p></li>
<li><p>mapfile.c: Implement msWriteXXXToString methods</p></li>
<li><p>mapsymbol.c: Implement msWriteSymbolToString methods</p></li>
<li><p>mapscript/swiginc/map.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/layer.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/class.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/web.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/legend.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/scalebar.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/querymap.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/referencemap.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/cluster.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/label.i: Add convertToString method</p></li>
<li><p>mapscript/swiginc/style.i: Add convertToString method</p></li>
<li><p>mapscript/php/php_mapscript.h: Declare new functions</p></li>
<li><p>mapscript/php/mapscript_i.c: Add proxyes for new functions</p></li>
<li><p>mapscript/php/map.c: Add convertToString method</p></li>
<li><p>mapscript/php/layer.c: Add convertToString method</p></li>
<li><p>mapscript/php/class.c: Add convertToString method</p></li>
<li><p>mapscript/php/web.c: Add convertToString method</p></li>
<li><p>mapscript/php/legend.c: Add convertToString method</p></li>
<li><p>mapscript/php/scalebar.c: Add convertToString method</p></li>
<li><p>mapscript/php/querymap.c: Add convertToString method</p></li>
<li><p>mapscript/php/referencemap.c: Add convertToString method</p></li>
<li><p>mapscript/php/cluster.c: Add convertToString method</p></li>
<li><p>mapscript/php/label.c: Add convertToString method</p></li>
<li><p>mapscript/php/style.c: Add convertToString method</p></li>
</ul>
</div></blockquote>
</section>
<section id="bug-id">
<h2>5. Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/4563">https://github.com/MapServer/MapServer/issues/4563</a></p></li>
</ul>
</section>
<section id="backwards-compatibility-issues">
<h2>6. Backwards compatibility issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>None expected, new functionality.</p>
</section>
<section id="mapscript-changes">
<h2>7. MapScript changes<a class="headerlink" href="#mapscript-changes" title="Link to this heading">¶</a></h2>
<p>New function convertToString will be added to the corresponding objects.</p>
</section>
<section id="voting-history">
<h2>8. Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Tom Kralidis +1
Steve Lime +1
Jeff McKenna +1
Daniel Morissette +1
Umberto Nicoletti +1
Michael Smith +1
Tamas Szekeres +1
Stephen Woodbridge +1</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 88: Saving MapServer Objects to Strings</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-solution">2. Proposed Solution</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a></li>
<li><a class="reference internal" href="#files-affected">4. Files Affected</a></li>
<li><a class="reference internal" href="#bug-id">5. Bug ID</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">6. Backwards compatibility issues</a></li>
<li><a class="reference internal" href="#mapscript-changes">7. MapScript changes</a></li>
<li><a class="reference internal" href="#voting-history">8. Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-89.html" title="MS RFC 89: Layer Geomtransforms"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-87.html" title="MS RFC 87: Bitmap pattern support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 88: Saving MapServer Objects to Strings</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>