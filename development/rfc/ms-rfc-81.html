
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>MS RFC 81: Offset Labels with Leader Lines &#8212; MapServer 7.2.2 documentation</title>
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 82: Support for Enhanced Layer Metadata Management" href="ms-rfc-82.html" />
    <link rel="prev" title="MS RFC 80: Font Fallback Support" href="ms-rfc-80.html" /> 
  </head><body>

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-81.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-82.html" title="MS RFC 82: Support for Enhanced Layer Metadata Management"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-80.html" title="MS RFC 80: Font Fallback Support"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-81-offset-labels-with-leader-lines">
<span id="rfc81"></span><h1>MS RFC 81: Offset Labels with Leader Lines<a class="headerlink" href="#ms-rfc-81-offset-labels-with-leader-lines" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2011/12/15</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Thomas Bonfort</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body">tbonfort at terriscope.fr</td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">Adopted</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapServer 6.2</td>
</tr>
</tbody>
</table>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Current labelling schemes place label text at the proximity of the point
they are attached to. In the labelcache phase, depending on the label’s
POSITION, either one or nine label positions are tested, and the label is
discarded if all of these positions cause a collision with the already
rendered labels.</p>
<p>This RFC proposes to extend the number of positions that are tested for
a given label, and evetually render a leader line from the rendered text to
the actual position the label is attached to.</p>
<p>An example rendering of the proposed change can be:</p>
<blockquote>
<div><img alt="../../_images/label-leaders1.jpg" src="../../_images/label-leaders1.jpg" />
</div></blockquote>
</div>
<div class="section" id="proposed-technical-change">
<h2>2. Proposed Technical Change<a class="headerlink" href="#proposed-technical-change" title="Permalink to this headline">¶</a></h2>
<p>The labelcache code will be extended to test for extended labelling positions
if the label was configured with “leader” parameters. There will be two
configuration options that specify how the offsetted positions are determined:</p>
<blockquote>
<div><ul class="simple">
<li>LEADERMAXDISTANCE will determine the maximum distance that the label text
can be placed from its original anchoring position</li>
<li>LEADERGRIDSTEP will determine the step in pixels between each tested position.</li>
</ul>
</div></blockquote>
<p>If a label cannot be placed due to a collision with an existing label or
marker, alternate positions are sampled for by iterating further and further
away from the original label point. In the figures below, “X” represents the
original label point, “.” represents an individual pixel, “0” represents an
offset that has already been tested for in a previous iteration, and
“1”,”2”,”3”, represents the order in which the positions are tested for in the
current iteration.</p>
<p>1st iteration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">2.</span><span class="o">..</span><span class="mf">1.</span><span class="o">..</span><span class="mi">2</span>
<span class="o">.........</span>
<span class="o">.........</span>
<span class="o">.........</span>
<span class="mf">1.</span><span class="o">..</span><span class="n">X</span><span class="o">...</span><span class="mi">1</span>
<span class="o">.........</span>
<span class="o">.........</span>
<span class="o">.........</span>
<span class="mf">2.</span><span class="o">..</span><span class="mf">1.</span><span class="o">..</span><span class="mi">2</span>
</pre></div>
</div>
<p>second iteration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">3.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">1.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mi">3</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="mf">2.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mi">2</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="mf">1.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="n">X</span><span class="o">...</span><span class="mf">0.</span><span class="o">..</span><span class="mi">1</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="mf">2.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mi">2</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="o">.................</span>
<span class="mf">3.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">1.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mi">3</span>
</pre></div>
</div>
<p>third iteration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">3.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">1.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mi">3</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="mf">2.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mi">2</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="mf">2.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mi">2</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="mf">1.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="n">X</span><span class="o">...</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mi">1</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="mf">2.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mi">2</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="mf">2.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mf">0.</span><span class="o">..</span><span class="mi">2</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="o">.........................</span>
<span class="mf">3.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">1.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mf">2.</span><span class="o">..</span><span class="mi">3</span>
</pre></div>
</div>
<p>For each offsetted position, the actual position of the text is adapted
depending on the general direction of the offset (e.g. with position “uc” for a
label at the vertical of the original point, “ur” for the top right diagonal,
etc…)</p>
<p>The iterations stop once an offset position does not cause a collision with the
existing labels, in which case the label text is sent down to the rendering
backend, or once the first offseted position is further away than the
configured LEADERMAXDISTANCE.</p>
<p>The collision detection functions will be extended to account for these
added constraints:</p>
<blockquote>
<div><ul class="simple">
<li>A label cannot collide with an existing leader line, and a leader line
cannot collide with an existing label. Note that these collision detections
operate on the bounding box of the label itself, without taking the label
BUFFER into account (i.e. a leader line is allowed to cross the buffer area
around an existing label)</li>
<li>A leader line cannot intersect another leader line.</li>
<li>A label who’s original position is inside the edge_buffer cannot be
offseted, as this would cause rendering artifacts for tiled output.</li>
</ul>
</div></blockquote>
<p>If an offseted label has been placed, a line between the original and the
offseted position is rendered with the label style(s) that has(ve) the
“LABELLEADER” geomtransform.</p>
</div>
<div class="section" id="expected-issues">
<h2>2.1 Expected issues<a class="headerlink" href="#expected-issues" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>With RFC77’s multiple labels per feature, the offset should be applied
as a whole to all the labels of the feature. In this sense, the leader
parameters should be owned by the classObj and not the labelObj, which
is semantically awkward.</li>
<li>For labels with LABELPNT geomtransform, should the marker be rendered at
the original label point, or at the position the label was offseted to? This
probably calls for an additional label style geomtransform.</li>
<li>This functionality is computationally expensive as the label collision
functions are called much more frequently than beforehand. The gridstep and
maxdistance parameters allow to cut down the number of iterations and therefore
the number of times the collision detection is called, at the expense of
missing out some potential correct offseted positions. Note that with a gridstep
of 1 and a maxdistance of the size of the image, there is the potential that
every pixel in the image be tested for collisions. Reasonable values are a
gridstep of 5 pixels, and a maxdistance of 30 pixels.</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>A function will be added in maplabel.c to test the configured offsetted
positions for a labelcache member against the already rendered labels. A
configuration option (TBD) will be added, and this function will be called:</p>
<blockquote>
<div><ul class="simple">
<li>either immediately once a label hasn’t been successfully rendered on its
original position</li>
<li>either after a label priority loop has finished. In this
case, the function will be called for all unsuccessful labels of the current
priority phase.</li>
</ul>
</div></blockquote>
<p>The labelcache member objects will have two members added, namely a lineObj
containing the leader line, and a shapeObj representing the unbuffered label’s
bounding box.</p>
<p>The functions that test for collision with existing labels will be extended to
check for intersections between leader lines and unbuffered existing labels.</p>
</div>
<div class="section" id="files-affected">
<h2>3.1. Files Affected<a class="headerlink" href="#files-affected" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li>mapserver.h: additional members for labelcachememberobj and labelobj</li>
<li>mapfile.c, maplexer.*, mapcopy.c : parsing and utility functions</li>
<li>maplabel.c: additional collision tests in msTestLabelCacheCollisions</li>
<li>mapdraw.c:<ul>
<li>function for trying a label at offset positions</li>
<li>calls to this function in msDrawLabelCache</li>
</ul>
</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="bug-id">
<h2>3.2 Bug ID<a class="headerlink" href="#bug-id" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/mapserver/mapserver/issues/XXX">https://github.com/mapserver/mapserver/issues/XXX</a></li>
</ul>
</div>
<div class="section" id="backwards-compatibility-issues">
<h2>4. Backwards compatibility issues<a class="headerlink" href="#backwards-compatibility-issues" title="Permalink to this headline">¶</a></h2>
<p>None expected, new functionality.</p>
</div>
<div class="section" id="error-reporting">
<h2>5. Error reporting<a class="headerlink" href="#error-reporting" title="Permalink to this headline">¶</a></h2>
<p>No additional error reporting aside from parsing errors.</p>
</div>
<div class="section" id="example-usage">
<h2>6. Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<p>TBD.</p>
</div>
<div class="section" id="voting-history">
<h2>7. Voting history<a class="headerlink" href="#voting-history" title="Permalink to this headline">¶</a></h2>
<p>+1 from ThomasB, MikeS, SteveW, DanielM, SteveL, JeffM, PerryN and TamasS</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 81: Offset Labels with Leader Lines</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-technical-change">2. Proposed Technical Change</a></li>
<li><a class="reference internal" href="#expected-issues">2.1 Expected issues</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a></li>
<li><a class="reference internal" href="#files-affected">3.1. Files Affected</a></li>
<li><a class="reference internal" href="#bug-id">3.2 Bug ID</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">4. Backwards compatibility issues</a></li>
<li><a class="reference internal" href="#error-reporting">5. Error reporting</a></li>
<li><a class="reference internal" href="#example-usage">6. Example Usage</a></li>
<li><a class="reference internal" href="#voting-history">7. Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-82.html" title="MS RFC 82: Support for Enhanced Layer Metadata Management"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-80.html" title="MS RFC 80: Font Fallback Support"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2019, Open Source Geospatial Foundation.
      Last updated on 2019-03-29.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.7.6.
    </div>
  </body>
</html>