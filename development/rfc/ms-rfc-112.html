<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 112: Retry “Follow” label positioning after maxoverlapangle colision &mdash; MapServer 7.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 113: Layer Compositing Pipeline" href="ms-rfc-113.html" />
    <link rel="prev" title="MS RFC 111: MapCache Support for animated time series" href="ms-rfc-111.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../faq.html" title="FAQ">FAQ</a> |
      <a href="../../download.html" title="Download">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        
        
          <a href="../../uk/development/rfc/ms-rfc-112.html"><img src="../../_static/flagicons/uk.png" alt="uk" title="uk" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-113.html" title="MS RFC 113: Layer Compositing Pipeline"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-111.html" title="MS RFC 111: MapCache Support for animated time series"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-112-retry-follow-label-positioning-after-maxoverlapangle-colision">
<span id="rfc112"></span><h1>MS RFC 112: Retry &#8220;Follow&#8221; label positioning after maxoverlapangle colision<a class="headerlink" href="#ms-rfc-112-retry-follow-label-positioning-after-maxoverlapangle-colision" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2014/10</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Thomas Bonfort</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:thomas&#46;bonfort&#37;&#52;&#48;gmail&#46;com">thomas<span>&#46;</span>bonfort<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">Implemented</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapServer 7.2</td>
</tr>
</tbody>
</table>
<div class="section" id="the-current-situation">
<h2>1. The Current Situation<a class="headerlink" href="#the-current-situation" title="Permalink to this headline">¶</a></h2>
<p>The current algorithm used to place &#8220;FOLLOW&#8221; labels has the following limitations:</p>
<ul class="simple">
<li>When two subsequent caracters of the label have a relative angle that is over
the defined &#8220;maxoverlapangle&#8221;, the label is unconditionally discarded.</li>
<li>The function used to compute character positions relies on &#8220;gotos&#8221; that
interrupt the code flow</li>
<li>Placement of repeated labels works optimally for odd number of repetitions
only when using repeatdistance, i.e. even if there&#8217;s room for two labels,
only one will be rendered</li>
</ul>
</div>
<div class="section" id="proposed-enhancement">
<h2>2. Proposed enhancement<a class="headerlink" href="#proposed-enhancement" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The algorithm will be extended to account for and try to correct for
colisions happening when maxoverlapangle kicks in, by ensuring that such
colisions may only occur between words:<ul>
<li>collisions hapenning on a &#8216;space&#8217; character will be ignored</li>
<li>when a colision does occur, the label placement will be retried with an
offset placed such that the colision falls either on a space or at the
beginning or end of the string.</li>
</ul>
</li>
<li>Code will be refactored to avoid usage of gotos</li>
<li>The placement algorithm will be modified to optimally treat an even number of
label repetitions:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>before:</li>
</ul>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span>-------label--------
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li>after:</li>
</ul>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre><span></span>--label------label--
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</div>
<div class="section" id="questions-limitations">
<h2>2.1 Questions/Limitations<a class="headerlink" href="#questions-limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Should the retrying behavior be enabled by default, and/or can it be
deactivated ? Computing and testing a retried offset is not costly, the
impact in terms of performance should be minimal and will result in more
labels being placed.</li>
<li>Should the maximum allowed offset be configurable?  Seems unnecessary for the
time being, all the relevant info as to what the maximum offset can be is contained
by the line length, label length, and repeatdistance.</li>
</ul>
</div>
<div class="section" id="backwards-compatibility">
<h2>2.2 Backwards Compatibility<a class="headerlink" href="#backwards-compatibility" title="Permalink to this headline">¶</a></h2>
<p>None expected aside from the fact created maps may contain more/different labels
than beforehand.</p>
</div>
<div class="section" id="performance-implications">
<h2>2.3 Performance Implications<a class="headerlink" href="#performance-implications" title="Permalink to this headline">¶</a></h2>
<p>Limited. Retrying a label after a colision is not a cpu-heavy operation. Costly
operations such as computing glyph advances and/or shaping text runs are not
re-run for each retry.</p>
</div>
<div class="section" id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<div class="section" id="affected-files">
<h3>3.1 Affected files<a class="headerlink" href="#affected-files" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>mapprimitive.c: implement retrying behavior - compute retried offsets</li>
</ul>
</div>
<div class="section" id="tracking-issue">
<h3>3.2 Tracking Issue<a class="headerlink" href="#tracking-issue" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>code: <a class="reference external" href="https://github.com/mapserver/mapserver/pull/5048">https://github.com/mapserver/mapserver/pull/5048</a></li>
<li>tests: <a class="reference external" href="https://github.com/tbonfort/msautotest/tree/displace_follow_labels">https://github.com/tbonfort/msautotest/tree/displace_follow_labels</a></li>
</ul>
</div>
</div>
<div class="section" id="voting-history">
<h2>4. Voting History<a class="headerlink" href="#voting-history" title="Permalink to this headline">¶</a></h2>
<p>+1 from SteveL, DanielM, StephanM, PerryN, MikeS, StephenW, ThomasB</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 112: Retry &#8220;Follow&#8221; label positioning after maxoverlapangle colision</a><ul>
<li><a class="reference internal" href="#the-current-situation">1. The Current Situation</a></li>
<li><a class="reference internal" href="#proposed-enhancement">2. Proposed enhancement</a></li>
<li><a class="reference internal" href="#questions-limitations">2.1 Questions/Limitations</a></li>
<li><a class="reference internal" href="#backwards-compatibility">2.2 Backwards Compatibility</a></li>
<li><a class="reference internal" href="#performance-implications">2.3 Performance Implications</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a><ul>
<li><a class="reference internal" href="#affected-files">3.1 Affected files</a></li>
<li><a class="reference internal" href="#tracking-issue">3.2 Tracking Issue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#voting-history">4. Voting History</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Open Source Geospatial Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>