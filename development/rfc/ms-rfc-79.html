<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 79: Layer Masking &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 80: Font Fallback Support" href="ms-rfc-80.html" />
    <link rel="prev" title="MS RFC 78: Vector Field Rendering (CONNECTIONTYPE UVRASTER)" href="ms-rfc-78.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-80.html" title="MS RFC 80: Font Fallback Support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-78.html" title="MS RFC 78: Vector Field Rendering (CONNECTIONTYPE UVRASTER)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 79: Layer Masking</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-79-layer-masking">
<span id="rfc79"></span><h1>MS RFC 79: Layer Masking<a class="headerlink" href="#ms-rfc-79-layer-masking" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2011/11/30</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Thomas Bonfort</p>
</dd>
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Alan Boudreault</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>tbonfort at terriscope.fr</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p>aboudreault at mapgears.com</p>
</dd>
<dt class="field-even">Last Edited<span class="colon">:</span></dt>
<dd class="field-even"><p>2012/05/11</p>
</dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><p>Implemented</p>
</dd>
<dt class="field-even">Version<span class="colon">:</span></dt>
<dd class="field-even"><p>MapServer 6.2</p>
</dd>
</dl>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>For some applications, it is desirable to mask out one or more layers so
that only the features that intersect another set of features are rendered
in the returned image.
While it is relatively trivial to achieve this goal with sql joins if all
the data is stored in postgis, the task becomes much more evolved or even
impossible if the layer to be masked, or the layer to use as a mask, comes
from a shapefile or a raster datasource.</p>
<p>A example use-case for this could be rendering meteo data for a given
client, but only on the areas where the client has purchased the service.
In this case, the meteo data should only be rendered on the areas covered by
a set of polygons that represent the purchased areas.</p>
<p>Another example use-case given an input DEM raster, could be to only render
data where the elevation is comprised in a given range.</p>
<p>To achieve these goals, the present RFC proposes the introduction of “MASK”
layers, where only the features that intersect the given mask are rendered
onto the final image.</p>
</section>
<section id="proposed-solution">
<h2>2. Proposed solution<a class="headerlink" href="#proposed-solution" title="Link to this heading">¶</a></h2>
<p>In order to work with all layer types, this RFC proposes to implement layer
masking at the pixel level, with the addition of a single “MASK” mapfile
keyword. The MASK keywords is placed at the layer level, and takes a single
argument which is the name of another mapfile layer that should be used as
a mask.</p>
<p>The mechanism to achieve masking at rendering time is:</p>
<ul class="simple">
<li><p>Each layer that is used as a mask is rendered in its own temporary image.
All the filtering and styling is done as usual, which implies that raster
classification/filtering can be performed, as well as style-level
geomtransforms, etc…</p></li>
<li><p>When a layer references a MASK, it is rendered in its own temporary image,
in the same way that is done when OPACITY is set. As before, all kind of
filtering/transformations can be performed on the masked layer</p></li>
<li><p>The masked layer is blended onto the final map image, but only for the
pixels that have been set in the mask image.</p></li>
</ul>
<p>Example of MASK usage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
 <span class="n">NAME</span> <span class="s2">&quot;parcels&quot;</span>
 <span class="n">TYPE</span> <span class="n">POLYGON</span>
 <span class="n">STATUS</span> <span class="n">OFF</span>
 <span class="n">DATA</span> <span class="s2">&quot;the_geom from parcels where clientid=&#39;%token%&#39;&quot;</span>
 <span class="n">CLASS</span>
  <span class="n">STYLE</span>
   <span class="n">COLOR</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span>
  <span class="n">END</span>
 <span class="n">END</span>
<span class="n">END</span>

<span class="n">LAYER</span>
 <span class="n">NAME</span> <span class="s2">&quot;meteo&quot;</span>
 <span class="n">STATUS</span> <span class="n">ON</span>
 <span class="n">TYPE</span> <span class="n">RASTER</span>
 <span class="n">DATA</span> <span class="s2">&quot;raster.tif&quot;</span>
 <span class="n">MASK</span> <span class="s2">&quot;parcels&quot;</span>
<span class="n">END</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The layer used as a mask <strong>will</strong> be rendered in the final map image
if its status is set to DEFAULT, or if its status is set to ON and the
layer name is included in the requested layers. Most users of this
feature will probably want to set the mask layer to STATUS OFF.</p>
</div>
</section>
<section id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>The parser will have a MASK keyword added to it, expecting a string</p></li>
<li><p>The layerObj will have two properties added to it:</p>
<ul>
<li><p>char* masklayer : the name of the layer that should be used as a mask</p></li>
<li><p>imageObj* maskimage : for a layer that has been referenced as a mask by
another layer, this will contain the pixels that should be used to
determine where data can be rendered on the final map image. This is to
prevent the mask layer from being rendered multiple times if it is
referenced by multiple layers.</p></li>
</ul>
</li>
<li><p>In msDrawLayer(), if the current layer references a MASK layer:</p>
<ul>
<li><p>a temp image is created and rendered into by another call to
msDrawLayer()</p></li>
<li><p>a temp image is created and rendered into following the same codepath
as if layer-&gt;opacity has been set</p></li>
<li><p>the second temporary image’s
alpha channel is tampered with and set to 0 for all the pixels that haven’t
been set in the first temporary image.</p></li>
<li><p>the second temporary image is blended into the final map image, again
following codepath as if layer-&gt;opacity has been set.</p></li>
</ul>
</li>
</ul>
</section>
<section id="files-affected">
<h2>3.1 Files affected<a class="headerlink" href="#files-affected" title="Link to this heading">¶</a></h2>
<p>The following files will be modified/created by this RFC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mapserver</span><span class="o">.</span><span class="n">h</span><span class="o">/</span><span class="n">mapfile</span><span class="o">.</span><span class="n">c</span><span class="o">/</span><span class="n">mapfile</span><span class="o">.</span><span class="n">h</span><span class="o">/</span><span class="n">maplexer</span><span class="o">.</span><span class="n">l</span><span class="o">/</span><span class="n">mapcopy</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">parser</span> <span class="ow">and</span> <span class="n">new</span> <span class="n">layerObj</span> <span class="n">members</span>
<span class="n">mapdraw</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">implementation</span> <span class="ow">in</span> <span class="n">msDrawLayer</span><span class="p">()</span>
<span class="n">maplabel</span><span class="o">.</span><span class="n">c</span><span class="p">:</span> <span class="n">implementation</span> <span class="k">for</span> <span class="n">dropping</span> <span class="n">labels</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">labelcache</span> <span class="k">if</span> <span class="n">they</span> <span class="n">don</span><span class="s1">&#39;t</span>
            <span class="n">intersect</span> <span class="n">the</span> <span class="n">mask</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">msAddLabel</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="mapscript">
<h2>3.2 MapScript<a class="headerlink" href="#mapscript" title="Link to this heading">¶</a></h2>
<p>Getters and Setters will have to be added to programmatically add a MASK to a layerObj.
No other issues are to be expected.</p>
</section>
<section id="backwards-compatibility-issues">
<h2>3.4 Backwards Compatibility Issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>This change provides a new functionality with no backwards compatibility issues being considered.</p>
</section>
<section id="limitations">
<h2>4. Limitations<a class="headerlink" href="#limitations" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Querying: The masking is done at the pixel level, as such all operations that query the
datasource will not mask out features.</p></li>
<li><p>Vector renderers: masking operations will not be supported on the vector renderers (svg,pdf)</p></li>
<li><p>Labelling: Labelling is usually performed after all layers have been rendered, in the labelcache
phase.</p>
<ul>
<li><p>For layers that are referenced as a mask, the layer’s labelcache will be set to OFF, which
results in all labels being directly added to the temporary mask image instead of being added
to the labelcache. Of course, it is not recommended to add labels to a layer used as a mask
(that is, unless someone finds a compelling use-case to do so)</p></li>
<li><p>If the layer that is being masked has labels, these have the potential to be rendered outside the
mask area if they go through the labelcache. To overcome this, there will be a test to ensure
that the labelpoint is contained in the masked areas before adding it to the labelcache. Note that
the label text itself might be rendered outside of the masked areas, but this should not be an
issue. If the masked layer is set with LABELCACHE FALSE, the rendered labels will be filtered
out automatically at the pixel level, although there will probably be truncated labels that
can appear.</p></li>
</ul>
</li>
</ul>
</section>
<section id="error-handling">
<h2>5. Error Handling<a class="headerlink" href="#error-handling" title="Link to this heading">¶</a></h2>
<p>There are no special cases to treat here aside from the classic ones (parsing errors, invalid
layer referenced by MASK, invalid renderer selected)</p>
</section>
<section id="bug-id">
<h2>6. Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/4111">https://github.com/MapServer/MapServer/issues/4111</a></p>
</section>
<section id="voting-history">
<h2>7. Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Passed with +1 from ThomasB, MichaelS, StephenW, AssefaY, FrankW, TamasS, DanielM, JeffMcK, TomK,
OlivierC, SteveL</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 79: Layer Masking</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-solution">2. Proposed solution</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a></li>
<li><a class="reference internal" href="#files-affected">3.1 Files affected</a></li>
<li><a class="reference internal" href="#mapscript">3.2 MapScript</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">3.4 Backwards Compatibility Issues</a></li>
<li><a class="reference internal" href="#limitations">4. Limitations</a></li>
<li><a class="reference internal" href="#error-handling">5. Error Handling</a></li>
<li><a class="reference internal" href="#bug-id">6. Bug ID</a></li>
<li><a class="reference internal" href="#voting-history">7. Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-80.html" title="MS RFC 80: Font Fallback Support"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-78.html" title="MS RFC 78: Vector Field Rendering (CONNECTIONTYPE UVRASTER)"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 79: Layer Masking</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>