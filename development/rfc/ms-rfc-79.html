<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 79: Layer Masking &mdash; MapServer 7.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 80: Font Fallback Support" href="ms-rfc-80.html" />
    <link rel="prev" title="MS RFC 78: Vector Field Rendering (CONNECTIONTYPE UVRASTER)" href="ms-rfc-78.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../faq.html" title="FAQ">FAQ</a> |
      <a href="../../download.html" title="Download">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        
        
          <a href="../../uk/development/rfc/ms-rfc-79.html"><img src="../../_static/flagicons/uk.png" alt="uk" title="uk" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-80.html" title="MS RFC 80: Font Fallback Support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-78.html" title="MS RFC 78: Vector Field Rendering (CONNECTIONTYPE UVRASTER)"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-79-layer-masking">
<span id="rfc79"></span><h1>MS RFC 79: Layer Masking<a class="headerlink" href="#ms-rfc-79-layer-masking" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2011/11/30</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Thomas Bonfort</td>
</tr>
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Alan Boudreault</td>
</tr>
<tr class="field-even field"><th class="field-name">Contact:</th><td class="field-body">tbonfort at terriscope.fr</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body">aboudreault at mapgears.com</td>
</tr>
<tr class="field-even field"><th class="field-name">Last Edited:</th><td class="field-body">2012/05/11</td>
</tr>
<tr class="field-odd field"><th class="field-name">Status:</th><td class="field-body">Implemented</td>
</tr>
<tr class="field-even field"><th class="field-name">Version:</th><td class="field-body">MapServer 6.2</td>
</tr>
</tbody>
</table>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>For some applications, it is desirable to mask out one or more layers so
that only the features that intersect another set of features are rendered
in the returned image.
While it is relatively trivial to achieve this goal with sql joins if all
the data is stored in postgis, the task becomes much more evolved or even
impossible if the layer to be masked, or the layer to use as a mask, comes
from a shapefile or a raster datasource.</p>
<p>A example use-case for this could be rendering meteo data for a given
client, but only on the areas where the client has purchased the service.
In this case, the meteo data should only be rendered on the areas covered by
a set of polygons that represent the purchased areas.</p>
<p>Another example use-case given an input DEM raster, could be to only render
data where the elevation is comprised in a given range.</p>
<p>To achieve these goals, the present RFC proposes the introduction of &#8220;MASK&#8221;
layers, where only the features that intersect the given mask are rendered
onto the final image.</p>
</div>
<div class="section" id="proposed-solution">
<h2>2. Proposed solution<a class="headerlink" href="#proposed-solution" title="Permalink to this headline">¶</a></h2>
<p>In order to work with all layer types, this RFC proposes to implement layer
masking at the pixel level, with the addition of a single &#8220;MASK&#8221; mapfile
keyword. The MASK keywords is placed at the layer level, and takes a single
argument which is the name of another mapfile layer that should be used as
a mask.</p>
<p>The mechanism to achieve masking at rendering time is:</p>
<ul class="simple">
<li>Each layer that is used as a mask is rendered in its own temporary image.
All the filtering and styling is done as usual, which implies that raster
classification/filtering can be performed, as well as style-level
geomtransforms, etc...</li>
<li>When a layer references a MASK, it is rendered in its own temporary image,
in the same way that is done when OPACITY is set. As before, all kind of
filtering/transformations can be performed on the masked layer</li>
<li>The masked layer is blended onto the final map image, but only for the
pixels that have been set in the mask image.</li>
</ul>
<p>Example of MASK usage:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>LAYER
 NAME &quot;parcels&quot;
 TYPE POLYGON
 STATUS OFF
 DATA &quot;the_geom from parcels where clientid=&#39;%token%&#39;&quot;
 CLASS
  STYLE
   COLOR 0 0 0
  END
 END
END

LAYER
 NAME &quot;meteo&quot;
 STATUS ON
 TYPE RASTER
 DATA &quot;raster.tif&quot;
 MASK &quot;parcels&quot;
END
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The layer used as a mask <strong>will</strong> be rendered in the final map image
if its status is set to DEFAULT, or if its status is set to ON and the
layer name is included in the requested layers. Most users of this
feature will probably want to set the mask layer to STATUS OFF.</p>
</div>
</div>
<div class="section" id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The parser will have a MASK keyword added to it, expecting a string</li>
<li>The layerObj will have two properties added to it:<ul>
<li>char* masklayer : the name of the layer that should be used as a mask</li>
<li>imageObj* maskimage : for a layer that has been referenced as a mask by
another layer, this will contain the pixels that should be used to
determine where data can be rendered on the final map image. This is to
prevent the mask layer from being rendered multiple times if it is
referenced by multiple layers.</li>
</ul>
</li>
<li>In msDrawLayer(), if the current layer references a MASK layer:<ul>
<li>a temp image is created and rendered into by another call to
msDrawLayer()</li>
<li>a temp image is created and rendered into following the same codepath
as if layer-&gt;opacity has been set</li>
<li>the second temporary image&#8217;s
alpha channel is tampered with and set to 0 for all the pixels that haven&#8217;t
been set in the first temporary image.</li>
<li>the second temporary image is blended into the final map image, again
following codepath as if layer-&gt;opacity has been set.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="files-affected">
<h2>3.1 Files affected<a class="headerlink" href="#files-affected" title="Permalink to this headline">¶</a></h2>
<p>The following files will be modified/created by this RFC:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>mapserver.h/mapfile.c/mapfile.h/maplexer.l/mapcopy.c: parser and new layerObj members
mapdraw.c: implementation in msDrawLayer()
maplabel.c: implementation for dropping labels from the labelcache if they don&#39;t
            intersect the mask layer in msAddLabel()
</pre></div>
</div>
</div>
<div class="section" id="mapscript">
<h2>3.2 MapScript<a class="headerlink" href="#mapscript" title="Permalink to this headline">¶</a></h2>
<p>Getters and Setters will have to be added to programmatically add a MASK to a layerObj.
No other issues are to be expected.</p>
</div>
<div class="section" id="backwards-compatibility-issues">
<h2>3.4 Backwards Compatibility Issues<a class="headerlink" href="#backwards-compatibility-issues" title="Permalink to this headline">¶</a></h2>
<p>This change provides a new functionality with no backwards compatibility issues being considered.</p>
</div>
<div class="section" id="limitations">
<h2>4. Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Querying: The masking is done at the pixel level, as such all operations that query the
datasource will not mask out features.</li>
<li>Vector renderers: masking operations will not be supported on the vector renderers (svg,pdf)</li>
<li>Labelling: Labelling is usually performed after all layers have been rendered, in the labelcache
phase.<ul>
<li>For layers that are referenced as a mask, the layer&#8217;s labelcache will be set to OFF, which
results in all labels being directly added to the temporary mask image instead of being added
to the labelcache. Of course, it is not recommended to add labels to a layer used as a mask
(that is, unless someone finds a compelling use-case to do so)</li>
<li>If the layer that is being masked has labels, these have the potential to be rendered outside the
mask area if they go through the labelcache. To overcome this, there will be a test to ensure
that the labelpoint is contained in the masked areas before adding it to the labelcache. Note that
the label text itself might be rendered outside of the masked areas, but this should not be an
issue. If the masked layer is set with LABELCACHE FALSE, the rendered labels will be filtered
out automatically at the pixel level, although there will probably be truncated labels that
can appear.</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="error-handling">
<h2>5. Error Handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>There are no special cases to treat here aside from the classic ones (parsing errors, invalid
layer referenced by MASK, invalid renderer selected)</p>
</div>
<div class="section" id="bug-id">
<h2>6. Bug ID<a class="headerlink" href="#bug-id" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/mapserver/mapserver/issues/4111">https://github.com/mapserver/mapserver/issues/4111</a></p>
</div>
<div class="section" id="voting-history">
<h2>7. Voting history<a class="headerlink" href="#voting-history" title="Permalink to this headline">¶</a></h2>
<p>Passed with +1 from ThomasB, MichaelS, StephenW, AssefaY, FrankW, TamasS, DanielM, JeffMcK, TomK,
OlivierC, SteveL</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 79: Layer Masking</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-solution">2. Proposed solution</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a></li>
<li><a class="reference internal" href="#files-affected">3.1 Files affected</a></li>
<li><a class="reference internal" href="#mapscript">3.2 MapScript</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">3.4 Backwards Compatibility Issues</a></li>
<li><a class="reference internal" href="#limitations">4. Limitations</a></li>
<li><a class="reference internal" href="#error-handling">5. Error Handling</a></li>
<li><a class="reference internal" href="#bug-id">6. Bug ID</a></li>
<li><a class="reference internal" href="#voting-history">7. Voting history</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Open Source Geospatial Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>