<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 80: Font Fallback Support &mdash; MapServer 7.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 81: Offset Labels with Leader Lines" href="ms-rfc-81.html" />
    <link rel="prev" title="MS RFC 79: Layer Masking" href="ms-rfc-79.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../faq.html" title="FAQ">FAQ</a> |
      <a href="../../download.html" title="Download">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        
        
          <a href="../../uk/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/uk.png" alt="uk" title="uk" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-81.html" title="MS RFC 81: Offset Labels with Leader Lines"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-79.html" title="MS RFC 79: Layer Masking"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-80-font-fallback-support">
<span id="rfc80"></span><h1>MS RFC 80: Font Fallback Support<a class="headerlink" href="#ms-rfc-80-font-fallback-support" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2011/12/07</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Thomas &#8220;fake&#8221; Jakobi</td>
</tr>
<tr class="field-odd field"><th class="field-name">Author:</th><td class="field-body">Thomas Bonfort</td>
</tr>
<tr class="field-even field"><th class="field-name">Contact:</th><td class="field-body">thomas at derfake.com</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body">tbonfort at terriscope.fr</td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">Passed</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapServer 6.2</td>
</tr>
</tbody>
</table>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>This RFC proposes allowing for the definition of fallback fonts for labels, to
be used when a glyph is not available in the initial font.</p>
<p>Presently, if a glyph is not available in the font of a label, the font&#8217;s error
glyph is drawn (usually an empty box). This is problematic when rendering
international data, as it may contain a wide range of unicode characters. Up
to now, this can only be fixed using a (near-)complete unicode font. The free
&#8220;unifont&#8221; contains all glyphs of the basic unicode set (~60.000), but does not
look very pleasing as a default font.</p>
<p>With fallback fonts, glyph lookup would try a set of fonts, in a given order,
before accepting the error glyph. This way, a unicode font like unifont would
only be used as &#8220;last resort&#8221; on a glyph-by-glyph basis.</p>
<p>In the mapfile, a list of fonts would be given as a comma-separated string like
&#8220;font1,font2,font3&#8221;, where each font is listed in the fonts.lst as usual. If
only one font is specified, this functionality has no effect. The same fontlist
support is available for attribute binding.</p>
</div>
<div class="section" id="proposed-technical-change">
<h2>2. Proposed Technical Change<a class="headerlink" href="#proposed-technical-change" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="core-object-changes">
<h2>2.1 Core Object Changes<a class="headerlink" href="#core-object-changes" title="Permalink to this headline">¶</a></h2>
<p>The Label Style Object would need to support multiple fonts. The proposed
implementation uses a hard limit to the number of fonts, to avoid overhead. The
number of fonts can be changed using the MS_MAX_LABEL_FONTS define, the
suggested default is 5.</p>
</div>
<div class="section" id="label-rendering-changes">
<h2>2.2 Label Rendering Changes<a class="headerlink" href="#label-rendering-changes" title="Permalink to this headline">¶</a></h2>
<p>The function pointer signature of GetTruetypeTextBBox needs to be changed to be
able to receive multiple fonts and their count. This requires a change to every
renderer, as does the change of the labelStyleObj.</p>
<p>Renderers supporting single-glyph operation like cairo and agg can use the font
list passed in to implement the glyph fallback. Renderers operating on complete
strings can use fonts[0] for no change in behavior.</p>
</div>
<div class="section" id="mapscript">
<h2>2.3 MapScript<a class="headerlink" href="#mapscript" title="Permalink to this headline">¶</a></h2>
<p>The mapscript getters and setters are unchanged, but the semantics
of the string passed to labelObj-&gt;setFont() is modified as it now
expects a comma-separated list of fontset keys.</p>
</div>
<div class="section" id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<p>The proposed implementation adds font fallback support to the cairo and agg
renderers.</p>
<p>The labelObj is unchanged, but its &#8220;char* font&#8221; member semantics
is changed to contain a comma separated list of fontset keys instead of a
single fontset key. This ensures minimal backwards incompatibility for
mapscript applications and datasource bindings.</p>
<p>A new function &#8220;msFontsetLookupFonts()&#8221; is called before labelling
renderer-specific functions are called, and maps the comma-separated
labelObj-&gt;font into an array of full font filenames, by iterating
through the labelObj-&gt;font keys and calling msFontsetLookup.</p>
<p>The renderer-specific labelling function signatures are modified to take
a list of font filenames instead of a single filename as is the case now.
Renderers that do not (yet?) support multiple font fallbacks are slightly
modified to use the first entry of the font array, while the other renderers
use some specific code to detect missing characters and use the fallback
fonts when needed.</p>
</div>
<div class="section" id="files-affected">
<h2>3.1. Files Affected<a class="headerlink" href="#files-affected" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>maplabel.c:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>add msFontsetLookupFonts implementation that splits the input
font on commas and looks up each font key in the fontset.</li>
<li>call msFontsetLookupFonts before calling the renderer vtable
boundingbox calculation functions.</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>maprendering.c: call msFontsetLookupFonts to set list of fonts
in labelStyleObj</li>
<li>mapagg.cpp: glyph fallback implementation, agg specific</li>
<li>mapcairo.c: glyph fallback implementation, cairo and freetype specific</li>
<li>mapgd.c, mapkml.c, mapogl.cpp:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>use only the first font of the given font list</li>
<li>getTruetypeTextBBox function signature update</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>mapserver.h:</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>add msFontsetLookupFonts function and MS_MAX_LABEL_FONTS define</li>
<li>change labelStyleObj char* font to char* font[MS_MAX_LABEL_FONTS]</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>mapsymbol.c: symbol font fallback adoptions</li>
<li>maputil.c: only bind font from shape if it&#8217;s different</li>
<li>mapdummyrenderer.c: getTruetypeTextBBox signature change</li>
</ul>
</div>
<div class="section" id="bug-id">
<h2>3.2 Bug ID<a class="headerlink" href="#bug-id" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/mapserver/mapserver/issues/4114">https://github.com/mapserver/mapserver/issues/4114</a></li>
</ul>
</div>
<div class="section" id="backwards-compatibility-issues">
<h2>4. Backwards compatibility issues<a class="headerlink" href="#backwards-compatibility-issues" title="Permalink to this headline">¶</a></h2>
<p>None expected, unless existing fontset keys contained commas. I&#8217;m not
sure this was valid syntax anyways, and was definitely bad practice.</p>
</div>
<div class="section" id="error-reporting">
<h2>5. Error reporting<a class="headerlink" href="#error-reporting" title="Permalink to this headline">¶</a></h2>
<p>The hard limit on the maximum number of fonts allowed is enforced in
msFontsetLookupFonts() which will halt processing and return an error
message stating that the maximum number of fonts is set to
MS_MAX_LABEL_FONTS. The renderers themselves will report the usual
error message if one of the referenced fonts could not be loaded (due
to an inaccessible or corrupt ttf file).</p>
</div>
<div class="section" id="example-usage">
<h2>6. Example Usage<a class="headerlink" href="#example-usage" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>see msautotest entry <a class="reference external" href="http://trac.osgeo.org/mapserver/changeset/12863">http://trac.osgeo.org/mapserver/changeset/12863</a></li>
</ul>
</div>
<div class="section" id="voting-history">
<h2>7. Voting history<a class="headerlink" href="#voting-history" title="Permalink to this headline">¶</a></h2>
<p>Passed with +1 from ThomasB, SteveW, MichaelS, SteveL, PerryN, DanielM</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 80: Font Fallback Support</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-technical-change">2. Proposed Technical Change</a></li>
<li><a class="reference internal" href="#core-object-changes">2.1 Core Object Changes</a></li>
<li><a class="reference internal" href="#label-rendering-changes">2.2 Label Rendering Changes</a></li>
<li><a class="reference internal" href="#mapscript">2.3 MapScript</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a></li>
<li><a class="reference internal" href="#files-affected">3.1. Files Affected</a></li>
<li><a class="reference internal" href="#bug-id">3.2 Bug ID</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">4. Backwards compatibility issues</a></li>
<li><a class="reference internal" href="#error-reporting">5. Error reporting</a></li>
<li><a class="reference internal" href="#example-usage">6. Example Usage</a></li>
<li><a class="reference internal" href="#voting-history">7. Voting history</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Open Source Geospatial Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>