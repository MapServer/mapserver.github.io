<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 80: Font Fallback Support &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 81: Offset Labels with Leader Lines" href="ms-rfc-81.html" />
    <link rel="prev" title="MS RFC 79: Layer Masking" href="ms-rfc-79.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-80.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-81.html" title="MS RFC 81: Offset Labels with Leader Lines"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-79.html" title="MS RFC 79: Layer Masking"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 80: Font Fallback Support</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-80-font-fallback-support">
<span id="rfc80"></span><h1>MS RFC 80: Font Fallback Support<a class="headerlink" href="#ms-rfc-80-font-fallback-support" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2011/12/07</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Thomas “fake” Jakobi</p>
</dd>
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Thomas Bonfort</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>thomas at derfake.com</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p>tbonfort at terriscope.fr</p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Passed</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>MapServer 6.2</p>
</dd>
</dl>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>This RFC proposes allowing for the definition of fallback fonts for labels, to
be used when a glyph is not available in the initial font.</p>
<p>Presently, if a glyph is not available in the font of a label, the font’s error
glyph is drawn (usually an empty box). This is problematic when rendering
international data, as it may contain a wide range of unicode characters. Up
to now, this can only be fixed using a (near-)complete unicode font. The free
“unifont” contains all glyphs of the basic unicode set (~60.000), but does not
look very pleasing as a default font.</p>
<p>With fallback fonts, glyph lookup would try a set of fonts, in a given order,
before accepting the error glyph. This way, a unicode font like unifont would
only be used as “last resort” on a glyph-by-glyph basis.</p>
<p>In the mapfile, a list of fonts would be given as a comma-separated string like
“font1,font2,font3”, where each font is listed in the fonts.lst as usual. If
only one font is specified, this functionality has no effect. The same fontlist
support is available for attribute binding.</p>
</section>
<section id="proposed-technical-change">
<h2>2. Proposed Technical Change<a class="headerlink" href="#proposed-technical-change" title="Link to this heading">¶</a></h2>
</section>
<section id="core-object-changes">
<h2>2.1 Core Object Changes<a class="headerlink" href="#core-object-changes" title="Link to this heading">¶</a></h2>
<p>The Label Style Object would need to support multiple fonts. The proposed
implementation uses a hard limit to the number of fonts, to avoid overhead. The
number of fonts can be changed using the MS_MAX_LABEL_FONTS define, the
suggested default is 5.</p>
</section>
<section id="label-rendering-changes">
<h2>2.2 Label Rendering Changes<a class="headerlink" href="#label-rendering-changes" title="Link to this heading">¶</a></h2>
<p>The function pointer signature of GetTruetypeTextBBox needs to be changed to be
able to receive multiple fonts and their count. This requires a change to every
renderer, as does the change of the labelStyleObj.</p>
<p>Renderers supporting single-glyph operation like cairo and agg can use the font
list passed in to implement the glyph fallback. Renderers operating on complete
strings can use fonts[0] for no change in behavior.</p>
</section>
<section id="mapscript">
<h2>2.3 MapScript<a class="headerlink" href="#mapscript" title="Link to this heading">¶</a></h2>
<p>The mapscript getters and setters are unchanged, but the semantics
of the string passed to labelObj-&gt;setFont() is modified as it now
expects a comma-separated list of fontset keys.</p>
</section>
<section id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
<p>The proposed implementation adds font fallback support to the cairo and agg
renderers.</p>
<p>The labelObj is unchanged, but its “char* font” member semantics
is changed to contain a comma separated list of fontset keys instead of a
single fontset key. This ensures minimal backwards incompatibility for
mapscript applications and datasource bindings.</p>
<p>A new function “msFontsetLookupFonts()” is called before labelling
renderer-specific functions are called, and maps the comma-separated
labelObj-&gt;font into an array of full font filenames, by iterating
through the labelObj-&gt;font keys and calling msFontsetLookup.</p>
<p>The renderer-specific labelling function signatures are modified to take
a list of font filenames instead of a single filename as is the case now.
Renderers that do not (yet?) support multiple font fallbacks are slightly
modified to use the first entry of the font array, while the other renderers
use some specific code to detect missing characters and use the fallback
fonts when needed.</p>
</section>
<section id="files-affected">
<h2>3.1. Files Affected<a class="headerlink" href="#files-affected" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>maplabel.c:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>add msFontsetLookupFonts implementation that splits the input
font on commas and looks up each font key in the fontset.</p></li>
<li><p>call msFontsetLookupFonts before calling the renderer vtable
boundingbox calculation functions.</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>maprendering.c: call msFontsetLookupFonts to set list of fonts
in labelStyleObj</p></li>
<li><p>mapagg.cpp: glyph fallback implementation, agg specific</p></li>
<li><p>mapcairo.c: glyph fallback implementation, cairo and freetype specific</p></li>
<li><p>mapgd.c, mapkml.c, mapogl.cpp:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>use only the first font of the given font list</p></li>
<li><p>getTruetypeTextBBox function signature update</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>mapserver.h:</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>add msFontsetLookupFonts function and MS_MAX_LABEL_FONTS define</p></li>
<li><p>change labelStyleObj char* font to char* font[MS_MAX_LABEL_FONTS]</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>mapsymbol.c: symbol font fallback adoptions</p></li>
<li><p>maputil.c: only bind font from shape if it’s different</p></li>
<li><p>mapdummyrenderer.c: getTruetypeTextBBox signature change</p></li>
</ul>
</section>
<section id="bug-id">
<h2>3.2 Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/4114">https://github.com/MapServer/MapServer/issues/4114</a></p></li>
</ul>
</section>
<section id="backwards-compatibility-issues">
<h2>4. Backwards compatibility issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>None expected, unless existing fontset keys contained commas. I’m not
sure this was valid syntax anyways, and was definitely bad practice.</p>
</section>
<section id="error-reporting">
<h2>5. Error reporting<a class="headerlink" href="#error-reporting" title="Link to this heading">¶</a></h2>
<p>The hard limit on the maximum number of fonts allowed is enforced in
msFontsetLookupFonts() which will halt processing and return an error
message stating that the maximum number of fonts is set to
MS_MAX_LABEL_FONTS. The renderers themselves will report the usual
error message if one of the referenced fonts could not be loaded (due
to an inaccessible or corrupt ttf file).</p>
</section>
<section id="example-usage">
<h2>6. Example Usage<a class="headerlink" href="#example-usage" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>see msautotest entry <a class="reference external" href="http://trac.osgeo.org/mapserver/changeset/12863">http://trac.osgeo.org/mapserver/changeset/12863</a></p></li>
</ul>
</section>
<section id="voting-history">
<h2>7. Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Passed with +1 from ThomasB, SteveW, MichaelS, SteveL, PerryN, DanielM</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 80: Font Fallback Support</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-technical-change">2. Proposed Technical Change</a></li>
<li><a class="reference internal" href="#core-object-changes">2.1 Core Object Changes</a></li>
<li><a class="reference internal" href="#label-rendering-changes">2.2 Label Rendering Changes</a></li>
<li><a class="reference internal" href="#mapscript">2.3 MapScript</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a></li>
<li><a class="reference internal" href="#files-affected">3.1. Files Affected</a></li>
<li><a class="reference internal" href="#bug-id">3.2 Bug ID</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">4. Backwards compatibility issues</a></li>
<li><a class="reference internal" href="#error-reporting">5. Error reporting</a></li>
<li><a class="reference internal" href="#example-usage">6. Example Usage</a></li>
<li><a class="reference internal" href="#voting-history">7. Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-81.html" title="MS RFC 81: Offset Labels with Leader Lines"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-79.html" title="MS RFC 79: Layer Masking"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 80: Font Fallback Support</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>