<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 22a: Feature cache for long running processes and query processing &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 23: Technical Steering Committee Guidelines" href="ms-rfc-23.html" />
    <link rel="prev" title="MS RFC 21: MapServer Raster Color Correction" href="ms-rfc-21.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-22a.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-23.html" title="MS RFC 23: Technical Steering Committee Guidelines"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-21.html" title="MS RFC 21: MapServer Raster Color Correction"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 22a: Feature cache for long running processes and query processing</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-22a-feature-cache-for-long-running-processes-and-query-processing">
<span id="rfc22a"></span><h1>MS RFC 22a: Feature cache for long running processes and query processing<a class="headerlink" href="#ms-rfc-22a-feature-cache-for-long-running-processes-and-query-processing" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2007/06/24</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Tamas Szekeres</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p>szekerest at gmail.com</p>
</dd>
<dt class="field-even">Last Edited<span class="colon">:</span></dt>
<dd class="field-even"><p>2007/06/24</p>
</dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><p>Discussion Draft</p>
</dd>
<dt class="field-even">Version<span class="colon">:</span></dt>
<dd class="field-even"><p>MapServer  5.0</p>
</dd>
</dl>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Currently the various query operations involve multiple accesses to the data
providers which may cause a significant performance impact depending on the
providers. In the first phase all of the features in the given search area are
retrieved and the index of the relevant shapes are stored in the result cache.
In the second phase the features in the result cache are retrieved form the
provider one by one. Retaining the shapes in the memory we could eliminate the
need of the subsequent accesses to the providers and increase the overall
performance of the query. Implementing the cache requires a transformation of
the data between the data provider and the client. From this aspect it is
desirable to provide a framework to implement this transformation in a higher
level of abstraction.</p>
</section>
<section id="purpose">
<h2>2. Purpose<a class="headerlink" href="#purpose" title="Link to this heading">¶</a></h2>
<p>The main purpose of this RFC is to implement a feature cache and retain the
shapes in the memory for the further retrievals during a query operation.
However I would also want to create a mechanism so that a layer could use
another layer as a data source. This outer layer could apply transformations
on the shapes coming from the base layer or even retain the shapes in the
memory for the subsequent fetches. Here are some other examples where this
framework would provide a solution:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>Constructing geometries based on feature attributes</p></li>
<li><p>Modifying the geometries or the feature attribute values</p></li>
<li><p>Geometry transformations (like GEOS operations)</p></li>
<li><p>Feature cache</p></li>
<li><p>Providing default layer style based on external style information, or
attribute based styling</p></li>
<li><p>Providing custom data filters</p></li>
</ol>
</div></blockquote>
<p>Setting up a proper layer hierarchy one can solve pretty complex issues
without the need of creating additional (eg. mapscript) code. Later on - as a
live example - I’ll show up the solution of the following scenario:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p>The user will select one or more shapes in one layer (by attribute selection in this case).</p></li>
<li><p>Cascaded transformations will be applied on the selected shapes (I’ll use the GEOS convexhull and buffer operations)</p></li>
<li><p>In another layer the features will be selected based on the transformed shapes as the selection shapes.</p></li>
</ol>
</div></blockquote>
<p>In this proposal to ensure the better readability I’ll avoid embedding much of the code inline. However most of the implementation patches are available at the tracking ticket of this RFC (see later).</p>
</section>
<section id="general-principles-of-the-solution">
<h2>3. General principles of the solution<a class="headerlink" href="#general-principles-of-the-solution" title="Link to this heading">¶</a></h2>
<p>This proposal involves writing additional data providers. These providers will use another layer as the source of the features. To set up this hierarchy of the layers, the CONNECTION parameter of these layers will contain the name of the source layer.
In some cases the source layer doesn’t participate in the renderings and should be kept internal to the original layer. Therefore we will establish the support for nesting the layers into each other. In this regard the CONNECTION parameter will contain the full path of the layer it refers to. The path contains the layer names in the hierarchy using the slash ‘/’ as the separator between the names. We can specify the pathnames relative to the actual layer or relative to the map itself.</p>
<ol class="loweralpha simple">
<li><p>Specify a reference relative to the map:</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
  <span class="n">NAME</span> <span class="s2">&quot;roads&quot;</span>
  <span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
  <span class="n">CONNECTION</span> <span class="s2">&quot;roads.tab&quot;</span>
  <span class="o">...</span>
<span class="n">END</span>
<span class="n">LAYER</span>
  <span class="n">NAME</span> <span class="s2">&quot;cache&quot;</span>
  <span class="n">CONNECTIONTYPE</span> <span class="n">CACHE</span>
  <span class="n">CONNECTION</span> <span class="s2">&quot;/roads&quot;</span>
  <span class="o">...</span>
<span class="n">END</span>
</pre></div>
</div>
<ol class="loweralpha simple" start="2">
<li><p>Specify a reference relative to the outer layer</p></li>
</ol>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
  <span class="n">NAME</span> <span class="s2">&quot;cache&quot;</span>
  <span class="n">CONNECTIONTYPE</span> <span class="n">CACHE</span>
  <span class="n">CONNECTION</span> <span class="s2">&quot;roads&quot;</span>
  <span class="o">...</span>
  <span class="n">LAYER</span>
    <span class="n">NAME</span> <span class="s2">&quot;roads&quot;</span>
    <span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
    <span class="n">CONNECTION</span> <span class="s2">&quot;roads.tab&quot;</span>
    <span class="o">...</span>
  <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>The main difference between these 2 options is that in the first case the referred layer is contained by the layers collection of the map, so the layer will participate in the drawings. In the second case the referred layer is internal to the outer layer.
It is supported that 2 or more layers connect to the same base layer so that the features will be served from the same cache repository. The base layer can reside in any place of the layer hierarchy.</p>
<p>In any case, the extension layer can also be implemented as a pluggable external layer. (CONNECTIONTYPE PLUGIN)</p>
<p>To achieve the desired functionality the following 3 providers will be implemented:</p>
</section>
<section id="feature-caching-provider">
<h2>3.1 Feature caching provider<a class="headerlink" href="#feature-caching-provider" title="Link to this heading">¶</a></h2>
<p>The purpose of this provider is to retain the features from the source layer in the memory so the subsequent fetches on the feature caching provider will be served from the internal cache. With the current implementation I’m planning to retain the shapes of last extent. When the subsequent shape retrieval refers to the same extent (or within that extent) the features will be served from the cache.
At the moment I will not address caching features from multiple non overlapping extents and implement more sophisticated cache management (like size limit/expiration handling) but it might be the object of an enhancement in the future.
All of the provider specific data will be placed in the layerinfo structure of the provider. The shapes in the cache will be stored in a hashtable.
This provider will be implemented in a separate file (mapcache.c).</p>
</section>
<section id="shape-retrieval-options">
<h2>3.1.1 Shape retrieval options<a class="headerlink" href="#shape-retrieval-options" title="Link to this heading">¶</a></h2>
<p>This provider will be capable to populate the cache with all of the shapes in the given extent or only with the shapes in the resultcache of the source layer. The first one is the default option and the latter can be selected by the following PROCESSING directive:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESSING</span> <span class="s2">&quot;fetch_mode=selection&quot;</span>
</pre></div>
</div>
<p>The cache will be populated upon the WhichShapes call of the caching provider when the given rect falls outside of the previous one. We can also specify that the provider will retieve all the shapes of the current map extent regardless to the search area using the following setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESSING</span> <span class="s2">&quot;spatial_selection_mode=mapextent&quot;</span>
</pre></div>
</div>
</section>
<section id="items-selection">
<h2>3.1.2 Items selection<a class="headerlink" href="#items-selection" title="Link to this heading">¶</a></h2>
<p>The feature caching provider will store all of the items available regardless of which items have been selected externally (by using the WhichItems call). However the iteminfo will contain the indexes only of the requested items. The GetShape and the NextShape operations will copy only the requested subset of the items to the caller. This solution will provide the compatibility with any other existing provider so there’s no need to alter the common mapserver code from this aspect.</p>
</section>
<section id="support-for-the-styleitem-auto-option">
<h2>3.1.3 Support for the STYLEITEM “AUTO” option<a class="headerlink" href="#support-for-the-styleitem-auto-option" title="Link to this heading">¶</a></h2>
<p>By using the STYLEITEM “AUTO” option the provider can retrieve the classObj of every shapeObj from the data source. So as to keep on supporting this option the caching provider will be capable to cache these classObj-s as well as the shapeObj-s in a separate hashtable. When the STYLEITEM “AUTO” option is set on the feature caching provider the style cache will also be populated by calling the GetAutoStyle function to the source layer. The subsequent GetAutoStyle calls on the feature caching provider will retrieve the classObj-s from the style cache and provide a copy to the caller.</p>
</section>
<section id="support-for-the-attribute-filter">
<h2>3.1.4 Support for the attribute filter<a class="headerlink" href="#support-for-the-attribute-filter" title="Link to this heading">¶</a></h2>
<p>The feature caching provider will be compatible with the existing query operations (implemented in the msQueryBy[] functions in mapquery.c). For supporting the msQueryByAttributes the NextShape will use msEvalExpression before returning the shapes to the caller.</p>
</section>
<section id="geometry-transformation-provider">
<h2>3.2 Geometry transformation provider<a class="headerlink" href="#geometry-transformation-provider" title="Link to this heading">¶</a></h2>
<p>The geometry transformation provider (implemented in mapgeomtrans.c) will support transparent access to the source layer. Every vtable operations will be dispatched to corresponding vtable operation of the source layer. In addition some of the other layer properties might require to copy between the connected layers.</p>
</section>
<section id="id1">
<h2>3.2.1 Items selection<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p>This provider will serve the same subset of the items as the source layer provides. Therefore the InitIteminfo will copy the items and the numitems of the external layer to the source layer, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">msGeomTransLayerInitItemInfo</span><span class="p">(</span> <span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span> <span class="p">)</span>
<span class="p">{</span>
    <span class="o">/*</span> <span class="n">copying</span> <span class="n">the</span> <span class="n">item</span> <span class="n">array</span> <span class="n">an</span> <span class="n">call</span> <span class="n">the</span> <span class="n">subsequent</span> <span class="n">InitItemInfo</span><span class="o">*/</span>
    <span class="k">return</span> <span class="n">msLayerSetItems</span><span class="p">(((</span><span class="n">GeomTransLayerInfo</span><span class="o">*</span><span class="p">)</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layerinfo</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">srclayer</span><span class="p">,</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">items</span><span class="p">,</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">numitems</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And upon the GetItems call these values will be copied back to the external layer, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">msGeomTransLayerGetItems</span><span class="p">(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">/*</span> <span class="n">copying</span> <span class="n">the</span> <span class="n">item</span> <span class="n">array</span> <span class="n">back</span> <span class="o">*/</span>
    <span class="nb">int</span> <span class="n">result</span><span class="p">;</span>
    <span class="n">GeomTransLayerInfo</span><span class="o">*</span> <span class="n">layerinfo</span> <span class="o">=</span> <span class="p">(</span><span class="n">GeomTransLayerInfo</span><span class="o">*</span><span class="p">)</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layerinfo</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">msLayerGetItems</span><span class="p">(</span><span class="n">layerinfo</span><span class="o">-&gt;</span><span class="n">srclayer</span><span class="p">);</span>
    <span class="n">msLayerSetItems</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">layerinfo</span><span class="o">-&gt;</span><span class="n">srclayer</span><span class="o">-&gt;</span><span class="n">items</span><span class="p">,</span> <span class="n">layerinfo</span><span class="o">-&gt;</span><span class="n">srclayer</span><span class="o">-&gt;</span><span class="n">numitems</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="applying-the-transformations">
<h2>3.2.2 Applying the transformations<a class="headerlink" href="#applying-the-transformations" title="Link to this heading">¶</a></h2>
<p>The proposed implementation will support most of the GEOS transformations supported by mapserver (buffer, convexhull, boundary, union, intersection, difference, symdifference). The transformations will be applied right before retrieving a shape to the caller.
The desired transformation can be selected using a PROCESSING option, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESSING</span> <span class="s2">&quot;transformation=buffer&quot;</span>
</pre></div>
</div>
<p>Some of the transformations will accept further parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESSING</span> <span class="s2">&quot;buffer_width=0.2&quot;</span>
</pre></div>
</div>
<p>Some of these operations will use 2 shapes to create the transformed shape. The reference shape of these transformations can be set externally using the WKT representation of a processing option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESSING</span> <span class="s2">&quot;ref_shape=[WKT of the shape]&quot;</span>
</pre></div>
</div>
<p>I’m also planning to support retrieving this shape from the features collection of the layer and from an external layer as well.</p>
</section>
<section id="layer-filter-provider">
<h2>3.3 Layer filter provider<a class="headerlink" href="#layer-filter-provider" title="Link to this heading">¶</a></h2>
<p>The layer filter provider (implemented in mapfilter.c) will provide the shape retrieved from the source layer and will not apply any transformation on that. However some of the shapes will be skipped in the NextShape operations depending on the spatial and the attribute selection options. This provider ensures transparent access to the source layer (just as the previous one) but uses a cache for storing the selection shapes. The selection shapes will be retrieved from another layer which can be specified in the following processing option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESSING</span> <span class="s2">&quot;selection_layer=[path to the layer]&quot;</span>
</pre></div>
</div>
<p>When populating the selection cache I’ll support to retrieve all of the shapes or only the shapes in the result cache as for the caching provider mentioned before:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROCESSING</span> <span class="s2">&quot;fetch_mode=selection&quot;</span>
</pre></div>
</div>
</section>
<section id="putting-the-things-together-example">
<h2>4. Putting the things together (example)<a class="headerlink" href="#putting-the-things-together-example" title="Link to this heading">¶</a></h2>
<p>In this chapter I’ll describe the solution of the scenario have been mentioned earlier. I’ll start with a simple map file definition with 2 layers the counties and the citypoints of the country:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MAP</span>
      <span class="n">NAME</span> <span class="s2">&quot;Hungary&quot;</span>
      <span class="n">STATUS</span> <span class="n">ON</span>
      <span class="n">EXTENT</span> <span class="mf">421543.362603</span> <span class="mf">47885.103526</span> <span class="mf">933973.563202</span> <span class="mf">367180.479761</span>
      <span class="n">SIZE</span> <span class="mi">800</span> <span class="mi">600</span>
      <span class="n">IMAGETYPE</span> <span class="n">PNG</span>
      <span class="n">IMAGECOLOR</span> <span class="mi">255</span> <span class="mi">255</span> <span class="mi">255</span>

      <span class="n">PROJECTION</span>
              <span class="s2">&quot;proj=somerc&quot;</span>
              <span class="s2">&quot;lat_0=47.14439372222222&quot;</span>
              <span class="s2">&quot;lon_0=19.04857177777778&quot;</span>
              <span class="s2">&quot;x_0=650000&quot;</span>
              <span class="s2">&quot;y_0=200000&quot;</span>
              <span class="s2">&quot;ellps=GRS67&quot;</span>
              <span class="s2">&quot;units=m&quot;</span>
              <span class="s2">&quot;no_defs&quot;</span>
      <span class="n">END</span>

      <span class="n">SYMBOL</span>
          <span class="n">Name</span> <span class="s1">&#39;point&#39;</span>
          <span class="n">Type</span> <span class="n">ELLIPSE</span>
          <span class="n">POINTS</span>
              <span class="mi">1</span> <span class="mi">1</span>
          <span class="n">END</span>
          <span class="n">FILLED</span> <span class="n">TRUE</span>
      <span class="n">END</span>

      <span class="n">LAYER</span>
              <span class="n">PROJECTION</span>
                      <span class="s2">&quot;AUTO&quot;</span>
              <span class="n">END</span>
              <span class="n">NAME</span> <span class="s2">&quot;Hun_Counties&quot;</span>
              <span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
              <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_Megye.TAB&quot;</span>
              <span class="n">STATUS</span> <span class="n">default</span>
              <span class="n">TYPE</span> <span class="n">POLYGON</span>
              <span class="n">LABELITEM</span> <span class="s2">&quot;name&quot;</span>
              <span class="n">CLASS</span>
                      <span class="n">TEMPLATE</span> <span class="s2">&quot;query.html&quot;</span>
                      <span class="n">LABEL</span>
                              <span class="n">SIZE</span> <span class="n">medium</span>
                              <span class="n">COLOR</span> <span class="mi">64</span> <span class="mi">128</span> <span class="mi">64</span>
                      <span class="n">END</span>
                      <span class="n">STYLE</span>
                              <span class="n">COLOR</span> <span class="mi">208</span> <span class="mi">255</span> <span class="mi">208</span>
                              <span class="n">OUTLINECOLOR</span> <span class="mi">64</span> <span class="mi">64</span> <span class="mi">64</span>
                      <span class="n">END</span>
              <span class="n">END</span>
      <span class="n">END</span>
      <span class="n">LAYER</span>
              <span class="n">PROJECTION</span>
                      <span class="s2">&quot;AUTO&quot;</span>
              <span class="n">END</span>
              <span class="n">NAME</span> <span class="s2">&quot;Hun_CityPoints&quot;</span>
              <span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
              <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_CityPoints.TAB&quot;</span>
              <span class="n">STATUS</span> <span class="n">default</span>
              <span class="n">TYPE</span> <span class="n">POINT</span>
              <span class="n">CLASS</span>
                      <span class="n">STYLE</span>
                              <span class="n">COLOR</span> <span class="mi">255</span> <span class="mi">0</span> <span class="mi">0</span>
                              <span class="n">SYMBOL</span> <span class="s2">&quot;point&quot;</span>
                              <span class="n">SIZE</span> <span class="mi">2</span>
                      <span class="n">END</span>
              <span class="n">END</span>
      <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>This map will look like this:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample.png">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample.png</a></p>
</section>
<section id="adding-the-feature-cache-for-the-layers">
<h2>4.1 Adding the feature cache for the layers<a class="headerlink" href="#adding-the-feature-cache-for-the-layers" title="Link to this heading">¶</a></h2>
<p>Any of the layers might be cached by using the CACHE layer provider. The original provider might be nested inside the cache. The parameters related to the drawing should be specified for the outer layer, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
            <span class="n">PROJECTION</span>
                    <span class="s2">&quot;AUTO&quot;</span>
            <span class="n">END</span>
            <span class="n">NAME</span> <span class="s2">&quot;Hun_Counties_cache&quot;</span>
            <span class="n">CONNECTIONTYPE</span> <span class="n">CACHE</span>
            <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_Counties&quot;</span>
            <span class="n">STATUS</span> <span class="n">default</span>
            <span class="n">TYPE</span> <span class="n">POLYGON</span>
            <span class="n">LABELITEM</span> <span class="s2">&quot;name&quot;</span>
            <span class="n">CLASS</span>
                    <span class="n">TEMPLATE</span> <span class="s2">&quot;query.html&quot;</span>
                    <span class="n">LABEL</span>
                            <span class="n">SIZE</span> <span class="n">medium</span>
                            <span class="n">COLOR</span> <span class="mi">64</span> <span class="mi">128</span> <span class="mi">64</span>
                    <span class="n">END</span>
                    <span class="n">STYLE</span>
                            <span class="n">COLOR</span> <span class="mi">208</span> <span class="mi">255</span> <span class="mi">208</span>
                            <span class="n">OUTLINECOLOR</span> <span class="mi">64</span> <span class="mi">64</span> <span class="mi">64</span>
                    <span class="n">END</span>
            <span class="n">END</span>
            <span class="n">LAYER</span>
                <span class="n">PROJECTION</span>
                        <span class="s2">&quot;AUTO&quot;</span>
                <span class="n">END</span>
                <span class="n">NAME</span> <span class="s2">&quot;Hun_Counties&quot;</span>
                <span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
                <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_Megye.TAB&quot;</span>
                <span class="n">TYPE</span> <span class="n">POLYGON</span>
            <span class="n">END</span>
    <span class="n">END</span>
</pre></div>
</div>
<p>The Hun_Counties_cache layer is queryable and all of the existing methods are available to populate the resultcache. In my example I’ll use the mapscript C# drawquery example (implemented in drawquery.cs) to execute an attribute query and use the drawquery afterwards. The following command will be used along with this sample:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drawquery</span> <span class="n">sample</span><span class="o">.</span><span class="n">map</span> <span class="s2">&quot;(&#39;[Name]&#39;=&#39;Tolna&#39;)&quot;</span> <span class="n">sample</span><span class="o">.</span><span class="n">png</span>
</pre></div>
</div>
<p>Which passes the (‘[Name]’=’Tolna’) query string to the queryByAttributes of the first layer.</p>
<p>The result of the rendering will look like:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample1.png">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample1.png</a></p>
<p>The corresponding mapfile can be found here:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample1.map">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample1.map</a></p>
</section>
<section id="applying-transformations-on-the-counties">
<h2>4.2 Applying transformations on the counties<a class="headerlink" href="#applying-transformations-on-the-counties" title="Link to this heading">¶</a></h2>
<p>In the next step I’ll apply a cascaded GEOS convexhull and buffer operations on the first layer. The results will be rendered in a separate layer using the following definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
             <span class="n">NAME</span> <span class="s2">&quot;selectionshape&quot;</span>
             <span class="n">CONNECTIONTYPE</span> <span class="n">GEOMTRANS</span>
             <span class="n">CONNECTION</span> <span class="s2">&quot;simplify&quot;</span>
             <span class="n">STATUS</span> <span class="n">default</span>
             <span class="n">TYPE</span> <span class="n">POLYGON</span>
             <span class="n">TRANSPARENCY</span> <span class="mi">50</span>
             <span class="n">CLASS</span>
                     <span class="n">STYLE</span>
                             <span class="n">COLOR</span> <span class="mi">64</span> <span class="mi">255</span> <span class="mi">64</span>
                             <span class="n">OUTLINECOLOR</span> <span class="mi">64</span> <span class="mi">64</span> <span class="mi">64</span>
                     <span class="n">END</span>
             <span class="n">END</span>
             <span class="n">PROCESSING</span> <span class="s2">&quot;transformation=buffer&quot;</span>
             <span class="n">PROCESSING</span> <span class="s2">&quot;buffer_width=0.2&quot;</span>
             <span class="n">LAYER</span>
                <span class="n">NAME</span> <span class="s2">&quot;simplify&quot;</span>
                <span class="n">TYPE</span> <span class="n">POLYGON</span>
                <span class="n">CONNECTIONTYPE</span> <span class="n">GEOMTRANS</span>
                <span class="n">CONNECTION</span> <span class="s2">&quot;/Hun_Counties_cache&quot;</span>
                <span class="n">PROCESSING</span> <span class="s2">&quot;transformation=convexhull&quot;</span>
             <span class="n">END</span>
     <span class="n">END</span>
</pre></div>
</div>
<p>The result of the rendering will look like:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample2.png">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample2.png</a></p>
<p>The corresponding mapfile:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample2.map">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample2.map</a></p>
<p>Which is not the desired result since all of the polygons were transformed. So as to transform only the selected shape an additional cache should be specified by using the “fetch_mode=selection” processing option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
            <span class="n">NAME</span> <span class="s2">&quot;selectionshape&quot;</span>
            <span class="n">CONNECTIONTYPE</span> <span class="n">GEOMTRANS</span>
            <span class="n">CONNECTION</span> <span class="s2">&quot;simplify&quot;</span>
            <span class="n">STATUS</span> <span class="n">default</span>
            <span class="n">TYPE</span> <span class="n">POLYGON</span>
            <span class="n">TRANSPARENCY</span> <span class="mi">50</span>
            <span class="n">CLASS</span>
                    <span class="n">STYLE</span>
                            <span class="n">COLOR</span> <span class="mi">64</span> <span class="mi">255</span> <span class="mi">64</span>
                            <span class="n">OUTLINECOLOR</span> <span class="mi">64</span> <span class="mi">64</span> <span class="mi">64</span>
                    <span class="n">END</span>
            <span class="n">END</span>
            <span class="n">PROCESSING</span> <span class="s2">&quot;transformation=buffer&quot;</span>
            <span class="n">PROCESSING</span> <span class="s2">&quot;buffer_width=0.2&quot;</span>
            <span class="n">LAYER</span>
               <span class="n">NAME</span> <span class="s2">&quot;simplify&quot;</span>
               <span class="n">TYPE</span> <span class="n">POLYGON</span>
               <span class="n">CONNECTIONTYPE</span> <span class="n">GEOMTRANS</span>
               <span class="n">CONNECTION</span> <span class="s2">&quot;selectioncache&quot;</span>
               <span class="n">PROCESSING</span> <span class="s2">&quot;transformation=convexhull&quot;</span>
               <span class="n">LAYER</span>
                   <span class="n">NAME</span> <span class="s2">&quot;selectioncache&quot;</span>
                   <span class="n">TYPE</span> <span class="n">POLYGON</span>
                   <span class="n">CONNECTIONTYPE</span> <span class="n">CACHE</span>
                   <span class="n">CONNECTION</span> <span class="s2">&quot;/Hun_Counties_cache&quot;</span>
                   <span class="n">PROCESSING</span> <span class="s2">&quot;fetch_mode=selection&quot;</span>
               <span class="n">END</span>
            <span class="n">END</span>
    <span class="n">END</span>
</pre></div>
</div>
<p>And here is the result of the drawing:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample3.png">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample3.png</a></p>
<p>The corresponding mapfile:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample3.map">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample3.map</a></p>
</section>
<section id="using-the-transformed-shape-as-the-selection-shape">
<h2>4.3 Using the transformed shape as the selection shape<a class="headerlink" href="#using-the-transformed-shape-as-the-selection-shape" title="Link to this heading">¶</a></h2>
<p>My final goal is to select the features of the point layer using the transformed shape as the selection shape. Therefore I’ll have to use the layer filter provider on the point layer and setting the selection_layer to the transformed layer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
         <span class="n">TYPE</span> <span class="n">POINT</span>
         <span class="n">CONNECTIONTYPE</span> <span class="n">LAYERFILTER</span>
         <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_CityPoints&quot;</span>
         <span class="n">NAME</span> <span class="s2">&quot;selectedpoints&quot;</span>
         <span class="n">STATUS</span> <span class="n">default</span>
         <span class="n">PROCESSING</span> <span class="s2">&quot;selection_layer=/selectionshape&quot;</span>
         <span class="n">CLASS</span>
             <span class="n">STYLE</span>
                     <span class="n">COLOR</span> <span class="mi">255</span> <span class="mi">0</span> <span class="mi">0</span>
                     <span class="n">SYMBOL</span> <span class="s2">&quot;point&quot;</span>
                     <span class="n">SIZE</span> <span class="mi">2</span>
             <span class="n">END</span>
         <span class="n">END</span>
         <span class="n">LAYER</span>
                 <span class="n">PROJECTION</span>
                         <span class="s2">&quot;AUTO&quot;</span>
                 <span class="n">END</span>
                 <span class="n">NAME</span> <span class="s2">&quot;Hun_CityPoints&quot;</span>
                 <span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
                 <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_CityPoints.TAB&quot;</span>
                 <span class="n">TYPE</span> <span class="n">POINT</span>
         <span class="n">END</span>
     <span class="n">END</span>
</pre></div>
</div>
<p>Here is the result:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample4.png">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample4.png</a></p>
<p>The corresponding mapfile:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample4.map">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample4.map</a></p>
<p>Note1: Without altering the map configuration I can modify the selection externally and the rendered image will reflect the changes automatically. For example I can select 2 counties using the query string: (‘[Name]’=’Tolna’ or ‘[Name]’=’Baranya’)</p>
<p>The resulting image can be found here:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample4a.png">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample4a.png</a></p>
<p>Note2: If there’s no need to render the selection layer I can specify that configuration inline:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
        <span class="n">TYPE</span> <span class="n">POINT</span>
        <span class="n">CONNECTIONTYPE</span> <span class="n">LAYERFILTER</span>
        <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_CityPoints&quot;</span>
        <span class="n">NAME</span> <span class="s2">&quot;selectedpoints&quot;</span>
        <span class="n">STATUS</span> <span class="n">default</span>
        <span class="n">PROCESSING</span> <span class="s2">&quot;selection_layer=selectionshape&quot;</span>
        <span class="n">CLASS</span>
            <span class="n">STYLE</span>
                    <span class="n">COLOR</span> <span class="mi">255</span> <span class="mi">0</span> <span class="mi">0</span>
                    <span class="n">SYMBOL</span> <span class="s2">&quot;point&quot;</span>
                    <span class="n">SIZE</span> <span class="mi">2</span>
            <span class="n">END</span>
        <span class="n">END</span>
        <span class="n">LAYER</span>
                <span class="n">PROJECTION</span>
                        <span class="s2">&quot;AUTO&quot;</span>
                <span class="n">END</span>
                <span class="n">NAME</span> <span class="s2">&quot;Hun_CityPoints&quot;</span>
                <span class="n">CONNECTIONTYPE</span> <span class="n">OGR</span>
                <span class="n">CONNECTION</span> <span class="s2">&quot;Hun_CityPoints.TAB&quot;</span>
                <span class="n">TYPE</span> <span class="n">POINT</span>
        <span class="n">END</span>
        <span class="n">LAYER</span>
                <span class="n">NAME</span> <span class="s2">&quot;selectionshape&quot;</span>
                <span class="n">CONNECTIONTYPE</span> <span class="n">GEOMTRANS</span>
                <span class="n">CONNECTION</span> <span class="s2">&quot;simplify&quot;</span>
                <span class="n">STATUS</span> <span class="n">default</span>
                <span class="n">TYPE</span> <span class="n">POLYGON</span>
                <span class="n">TRANSPARENCY</span> <span class="mi">50</span>
                <span class="n">CLASS</span>
                        <span class="n">STYLE</span>
                                <span class="n">COLOR</span> <span class="mi">64</span> <span class="mi">255</span> <span class="mi">64</span>
                                <span class="n">OUTLINECOLOR</span> <span class="mi">64</span> <span class="mi">64</span> <span class="mi">64</span>
                        <span class="n">END</span>
                <span class="n">END</span>
                <span class="n">PROCESSING</span> <span class="s2">&quot;transformation=buffer&quot;</span>
                <span class="n">PROCESSING</span> <span class="s2">&quot;buffer_width=0.2&quot;</span>
                <span class="n">LAYER</span>
                    <span class="n">NAME</span> <span class="s2">&quot;simplify&quot;</span>
                    <span class="n">TYPE</span> <span class="n">POLYGON</span>
                    <span class="n">CONNECTIONTYPE</span> <span class="n">GEOMTRANS</span>
                    <span class="n">CONNECTION</span> <span class="s2">&quot;selectioncache&quot;</span>
                    <span class="n">PROCESSING</span> <span class="s2">&quot;transformation=convexhull&quot;</span>
                    <span class="n">LAYER</span>
                        <span class="n">NAME</span> <span class="s2">&quot;selectioncache&quot;</span>
                        <span class="n">TYPE</span> <span class="n">POLYGON</span>
                        <span class="n">CONNECTIONTYPE</span> <span class="n">CACHE</span>
                        <span class="n">CONNECTION</span> <span class="s2">&quot;/Hun_Counties_cache&quot;</span>
                        <span class="n">PROCESSING</span> <span class="s2">&quot;fetch_mode=selection&quot;</span>
                    <span class="n">END</span>
                <span class="n">END</span>
        <span class="n">END</span>
    <span class="n">END</span>
</pre></div>
</div>
<p>Here is the result:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample5.png">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample5.png</a></p>
<p>And the corresponding mapfile:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample5.map">http://trac.osgeo.org/mapserver/attachment/ticket/2128/sample5.map</a></p>
<p>And recall that because I’ve used a cache on the counties layer all of these renderings require to retrieve the shapes only once from the original provider. That was the primary objective of this RFC.</p>
</section>
<section id="modifying-the-mapserver-core">
<h2>5. Modifying the mapserver core<a class="headerlink" href="#modifying-the-mapserver-core" title="Link to this heading">¶</a></h2>
<p>To achieve the desired fuctionality the following major steps should be done in the mapserver core. The details of the proposed changes can be found here:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2128/common.patch">http://trac.osgeo.org/mapserver/attachment/ticket/2128/common.patch</a></p>
</section>
<section id="hashtable-implementation">
<h2>5.1 Hashtable implementation<a class="headerlink" href="#hashtable-implementation" title="Link to this heading">¶</a></h2>
<p>The current hashtable implementation (in maphash.c) will be generalized to be capable to store objects as well as strings. Currently the hashtable can store only string values. In addition the we will provide support for specifying the hashsize upon the construction of the hashtable. The objects will be stored in the hashtable by reference and the destroy function of the objects can also be specified externally. The following functions will be added to maphash.c</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">initHashTableEx</span><span class="p">(</span> <span class="n">hashTableObj</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="nb">int</span> <span class="n">hashSize</span> <span class="p">);</span>
<span class="n">void</span> <span class="n">msClearHashItems</span><span class="p">(</span> <span class="n">hashTableObj</span> <span class="o">*</span><span class="n">table</span> <span class="p">);</span>
<span class="n">struct</span> <span class="n">hashObj</span> <span class="o">*</span><span class="n">msInsertHashTablePtr</span><span class="p">(</span><span class="n">hashTableObj</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">const</span> <span class="n">char</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
<span class="n">struct</span> <span class="n">hashObj</span> <span class="o">*</span><span class="n">msFirstItemFromHashTable</span><span class="p">(</span> <span class="n">hashTableObj</span> <span class="o">*</span><span class="n">table</span><span class="p">);</span>
<span class="n">struct</span> <span class="n">hashObj</span> <span class="o">*</span><span class="n">msNextItemFromHashTable</span><span class="p">(</span> <span class="n">hashTableObj</span> <span class="o">*</span><span class="n">table</span><span class="p">,</span> <span class="n">struct</span> <span class="n">hashObj</span> <span class="o">*</span><span class="n">lastItem</span> <span class="p">);</span>
<span class="nb">int</span> <span class="n">msGetHashTableItemCount</span><span class="p">(</span><span class="n">hashTableObj</span> <span class="o">*</span><span class="n">table</span><span class="p">);</span>
</pre></div>
</div>
<p>initHashTableEx can be called to specify the hash size externally. Actually the original initHashTable will be implemented as calling initHashTableEx with MS_HASHSIZE.
msClearHashItems will clear all of the elements of the hashtable but does not clear the items array.
msInsertHashTablePtr provides the support for adding object by reference to the hashtable.
msFirstItemFromHashTable and msNextItemFromHashTable will provide the iteration of the elements efficiently and will be called by the NextShape of the feature caching provider.
msGetHashTableItemCount will retrieve the actual number of the hashtable items.</p>
</section>
<section id="extending-the-layerobj-structure-to-support-nesting-the-layers-map-h">
<h2>5.2 Extending the layerObj structure to support nesting the layers (map.h)<a class="headerlink" href="#extending-the-layerobj-structure-to-support-nesting-the-layers-map-h" title="Link to this heading">¶</a></h2>
<p>The sublayers in the layerObj structure will be stored as an array of layers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">layer_obj</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="c1">#ifndef SWIG</span>
  <span class="n">struct</span> <span class="n">layer_obj</span> <span class="o">**</span><span class="n">layers</span><span class="p">;</span>
  <span class="nb">int</span> <span class="n">numlayers</span><span class="p">;</span> <span class="o">/*</span> <span class="n">number</span> <span class="n">of</span> <span class="n">sublayers</span> <span class="ow">in</span> <span class="n">layer</span> <span class="o">*/</span>
  <span class="c1">#endif /* SWIG */</span>
  <span class="o">...</span>
<span class="p">}</span> <span class="n">layerObj</span><span class="p">;</span>
</pre></div>
</div>
<p>The parser will take care of loading the nested layers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">loadLayer</span><span class="p">(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">,</span> <span class="n">mapObj</span> <span class="o">*</span><span class="nb">map</span><span class="p">)</span>
<span class="p">{</span>
  <span class="o">...</span>
  <span class="k">case</span> <span class="p">(</span><span class="n">LAYER</span><span class="p">):</span>
    <span class="k">if</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">layer</span><span class="o">-&gt;</span><span class="n">layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">layerObj</span><span class="o">**</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">layerObj</span><span class="o">*</span><span class="p">));</span>
    <span class="k">else</span>
        <span class="n">layer</span><span class="o">-&gt;</span><span class="n">layers</span> <span class="o">=</span> <span class="p">(</span><span class="n">layerObj</span><span class="o">**</span><span class="p">)</span> <span class="n">realloc</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">layerObj</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span><span class="p">));</span>
    <span class="n">layer</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">layerObj</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">layerObj</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span><span class="p">]</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">msSetError</span><span class="p">(</span><span class="n">MS_MEMERR</span><span class="p">,</span> <span class="s2">&quot;Malloc of a new layer failed.&quot;</span><span class="p">,</span> <span class="s2">&quot;loadLayer()&quot;</span><span class="p">);</span>
             <span class="k">return</span> <span class="n">MS_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="n">loadLayer</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span><span class="p">],</span> <span class="nb">map</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">MS_FAILURE</span><span class="p">;</span>
    <span class="n">layer</span><span class="o">-&gt;</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span><span class="p">;</span> <span class="o">/*</span> <span class="n">save</span> <span class="n">the</span> <span class="n">index</span> <span class="o">*/</span>
    <span class="o">++</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">numlayers</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="adding-a-new-built-in-data-connection-types-map-h">
<h2>5.3 Adding a new built in data connection types (map.h)<a class="headerlink" href="#adding-a-new-built-in-data-connection-types-map-h" title="Link to this heading">¶</a></h2>
<p>A new data connection type is established for the new providers.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">enum</span> <span class="n">MS_CONNECTION_TYPE</span> <span class="p">{</span><span class="n">MS_INLINE</span><span class="p">,</span> <span class="n">MS_SHAPEFILE</span><span class="p">,</span> <span class="n">MS_TILED_SHAPEFILE</span><span class="p">,</span> <span class="n">MS_SDE</span><span class="p">,</span> <span class="n">MS_OGR</span><span class="p">,</span> <span class="n">MS_UNUSED_1</span><span class="p">,</span> <span class="n">MS_POSTGIS</span><span class="p">,</span> <span class="n">MS_WMS</span><span class="p">,</span>   <span class="n">MS_ORACLESPATIAL</span><span class="p">,</span> <span class="n">MS_WFS</span><span class="p">,</span> <span class="n">MS_GRATICULE</span><span class="p">,</span> <span class="n">MS_MYGIS</span><span class="p">,</span> <span class="n">MS_RASTER</span><span class="p">,</span> <span class="n">MS_PLUGIN</span><span class="p">,</span> <span class="n">MS_GEOMTRANS</span><span class="p">,</span> <span class="n">MS_LAYERFILTER</span><span class="p">,</span> <span class="n">MS_CACHE</span> <span class="p">};</span>
</pre></div>
</div>
<p>The lexer will be modified to interpret the new connection types.</p>
</section>
<section id="support-for-destroying-the-persistent-data-of-the-providers-map-h-maplayer-c">
<h2>5.4 Support for destroying the persistent data of the providers (map.h, maplayer.c)<a class="headerlink" href="#support-for-destroying-the-persistent-data-of-the-providers-map-h-maplayer-c" title="Link to this heading">¶</a></h2>
<p>The providers would keep persistent data between the various Connection/Close operations on that layer so we should establish a mechanism to destroy this provider specific data by adding a new method to the layervtable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="p">(</span><span class="o">*</span><span class="n">LayerDestroy</span><span class="p">)(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="vtable-initialization-for-the-new-data-providers-maplayer-c">
<h2>5.5 Vtable initialization for the new data providers (maplayer.c)<a class="headerlink" href="#vtable-initialization-for-the-new-data-providers-maplayer-c" title="Link to this heading">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span>
<span class="n">msInitializeVirtualTable</span><span class="p">(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">baselayer</span><span class="p">)</span>
      <span class="n">msInitializeVirtualTable</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">baselayer</span><span class="p">);</span>
  <span class="o">...</span>
  <span class="n">switch</span><span class="p">(</span><span class="n">layer</span><span class="o">-&gt;</span><span class="n">connectiontype</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span>
  <span class="k">case</span><span class="p">(</span><span class="n">MS_GEOMTRANS</span><span class="p">):</span>
          <span class="k">return</span><span class="p">(</span><span class="n">msGeomTransLayerInitializeVirtualTable</span><span class="p">(</span><span class="n">layer</span><span class="p">));</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span><span class="p">(</span><span class="n">MS_LAYERFILTER</span><span class="p">):</span>
          <span class="k">return</span><span class="p">(</span><span class="n">msFilterLayerInitializeVirtualTable</span><span class="p">(</span><span class="n">layer</span><span class="p">));</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span><span class="p">(</span><span class="n">MS_CACHE</span><span class="p">):</span>
          <span class="k">return</span><span class="p">(</span><span class="n">msCacheLayerInitializeVirtualTable</span><span class="p">(</span><span class="n">layer</span><span class="p">));</span>
          <span class="k">break</span><span class="p">;</span>
  <span class="o">...</span>
  <span class="p">}</span>
  <span class="o">..</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="files-affected">
<h2>6. Files affected<a class="headerlink" href="#files-affected" title="Link to this heading">¶</a></h2>
<p>The following files will be affected by this RFC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">maphash</span><span class="o">.</span><span class="n">c</span>
<span class="n">maphash</span><span class="o">.</span><span class="n">h</span>
<span class="n">maplayer</span><span class="o">.</span><span class="n">c</span>
<span class="n">maplexer</span><span class="o">.</span><span class="n">l</span>
<span class="n">mapfile</span><span class="o">.</span><span class="n">c</span>
<span class="nb">map</span><span class="o">.</span><span class="n">h</span>
<span class="n">Makefile</span><span class="o">.</span><span class="n">vc</span>
<span class="n">Makefile</span><span class="o">.</span><span class="ow">in</span>
<span class="n">mapcache</span><span class="o">.</span><span class="n">c</span>  <span class="p">(</span><span class="n">new</span><span class="p">)</span>
<span class="n">mapgeomtrans</span><span class="o">.</span><span class="n">c</span>  <span class="p">(</span><span class="n">new</span><span class="p">)</span>
<span class="n">mapfilter</span><span class="o">.</span><span class="n">c</span>  <span class="p">(</span><span class="n">new</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="backwards-compatibility-issues">
<h2>7. Backwards compatibility issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>These changes will retain mapfile and mapscript backward compatibility.</p>
</section>
<section id="bug-id">
<h2>8. Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<p>The ticket for RFC-22a can be found here.</p>
<p>Bug <a class="reference external" href="https://github.com/MapServer/MapServer/issues/2128">2128</a></p>
</section>
<section id="voting-history">
<h2>9. Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>None</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 22a: Feature cache for long running processes and query processing</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#purpose">2. Purpose</a></li>
<li><a class="reference internal" href="#general-principles-of-the-solution">3. General principles of the solution</a></li>
<li><a class="reference internal" href="#feature-caching-provider">3.1 Feature caching provider</a></li>
<li><a class="reference internal" href="#shape-retrieval-options">3.1.1 Shape retrieval options</a></li>
<li><a class="reference internal" href="#items-selection">3.1.2 Items selection</a></li>
<li><a class="reference internal" href="#support-for-the-styleitem-auto-option">3.1.3 Support for the STYLEITEM “AUTO” option</a></li>
<li><a class="reference internal" href="#support-for-the-attribute-filter">3.1.4 Support for the attribute filter</a></li>
<li><a class="reference internal" href="#geometry-transformation-provider">3.2 Geometry transformation provider</a></li>
<li><a class="reference internal" href="#id1">3.2.1 Items selection</a></li>
<li><a class="reference internal" href="#applying-the-transformations">3.2.2 Applying the transformations</a></li>
<li><a class="reference internal" href="#layer-filter-provider">3.3 Layer filter provider</a></li>
<li><a class="reference internal" href="#putting-the-things-together-example">4. Putting the things together (example)</a></li>
<li><a class="reference internal" href="#adding-the-feature-cache-for-the-layers">4.1 Adding the feature cache for the layers</a></li>
<li><a class="reference internal" href="#applying-transformations-on-the-counties">4.2 Applying transformations on the counties</a></li>
<li><a class="reference internal" href="#using-the-transformed-shape-as-the-selection-shape">4.3 Using the transformed shape as the selection shape</a></li>
<li><a class="reference internal" href="#modifying-the-mapserver-core">5. Modifying the mapserver core</a></li>
<li><a class="reference internal" href="#hashtable-implementation">5.1 Hashtable implementation</a></li>
<li><a class="reference internal" href="#extending-the-layerobj-structure-to-support-nesting-the-layers-map-h">5.2 Extending the layerObj structure to support nesting the layers (map.h)</a></li>
<li><a class="reference internal" href="#adding-a-new-built-in-data-connection-types-map-h">5.3 Adding a new built in data connection types (map.h)</a></li>
<li><a class="reference internal" href="#support-for-destroying-the-persistent-data-of-the-providers-map-h-maplayer-c">5.4 Support for destroying the persistent data of the providers (map.h, maplayer.c)</a></li>
<li><a class="reference internal" href="#vtable-initialization-for-the-new-data-providers-maplayer-c">5.5 Vtable initialization for the new data providers (maplayer.c)</a></li>
<li><a class="reference internal" href="#files-affected">6. Files affected</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">7. Backwards compatibility issues</a></li>
<li><a class="reference internal" href="#bug-id">8. Bug ID</a></li>
<li><a class="reference internal" href="#voting-history">9. Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-23.html" title="MS RFC 23: Technical Steering Committee Guidelines"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-21.html" title="MS RFC 21: MapServer Raster Color Correction"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 22a: Feature cache for long running processes and query processing</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>