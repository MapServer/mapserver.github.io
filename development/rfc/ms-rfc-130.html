<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 130: Add support to Z-top, a multi-SQLite, multi-pyramid cache structure &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 131: Allow file paths in MapCache second level dimension values" href="ms-rfc-131.html" />
    <link rel="prev" title="MS RFC 129: Update msautotest to use Pytest" href="ms-rfc-129.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-130.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-131.html" title="MS RFC 131: Allow file paths in MapCache second level dimension values"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-129.html" title="MS RFC 129: Update msautotest to use Pytest"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 130: Add support to Z-top, a multi-SQLite, multi-pyramid cache structure</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-130-add-support-to-z-top-a-multi-sqlite-multi-pyramid-cache-structure">
<span id="rfc130"></span><h1>MS RFC 130: Add support to Z-top, a multi-SQLite, multi-pyramid cache structure<a class="headerlink" href="#ms-rfc-130-add-support-to-z-top-a-multi-sqlite-multi-pyramid-cache-structure" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2020-01-30</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Jérome Boué</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="mailto:jbo-ads&#37;&#52;&#48;laposte&#46;net">jbo-ads<span>&#64;</span>laposte<span>&#46;</span>net</a></p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Adopted</p>
</dd>
<dt class="field-odd">Last update<span class="colon">:</span></dt>
<dd class="field-odd"><p>2020-01-30</p>
</dd>
<dt class="field-even">Version<span class="colon">:</span></dt>
<dd class="field-even"><p>MapCache 1.10</p>
</dd>
</dl>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>This RFC proposes to add to MapCache support to a new cache structure involving
multi-SQLite caches organized in multiple pyramids: one single pyramid on
lowest zoom levels, then as many pyramids as tiles at a given zoom level, e.g.
8, refered to as <em>top zoom level</em>. Each of these pyramids starts with one tile
at that top zoom level, then four tiles at next zoom level and so on. Of course
the top zoom level value is configurable.</p>
<p>Following is a figure illustrating this cache structure.</p>
<img alt="../../_images/mapcache-ztop.png" class="no-scaled-link align-center" src="../../_images/mapcache-ztop.png" style="width: 523.0px; height: 559.0px;" />
</section>
<section id="rationale">
<h2>Rationale<a class="headerlink" href="#rationale" title="Link to this heading">¶</a></h2>
<p>The main advantage of this structure is when a user wants to work offline with
only a subset of the World: Only two (relatively small) SQLite files have to be
copied.</p>
</section>
<section id="proposed-solution">
<h2>Proposed solution<a class="headerlink" href="#proposed-solution" title="Link to this heading">¶</a></h2>
<p>From a configuration point of view, a multi-SQLite cache of class <em>ztop</em> is
specified with a <cite>&lt;top&gt;</cite> tag defining the top zoom level. Templates keys are
needed to determine SQLite files to use.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- multi-pyramid, multi-SQLite, starting at zoom level 8 --&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;z8&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="hll"><span class="w">  </span><span class="nt">&lt;top&gt;</span>8<span class="nt">&lt;/top&gt;</span>
</span><span class="hll"><span class="w">  </span><span class="nt">&lt;dbfile</span><span class="w"> </span><span class="na">top_fmt=</span><span class="s">&quot;%02d&quot;</span><span class="nt">&gt;</span>/path/to/z{top}-{top_x}-{top_y}.sqlite3<span class="nt">&lt;/dbfile&gt;</span>
</span><span class="nt">&lt;/cache&gt;</span>

<span class="cm">&lt;!-- single cache from zoom levels 0 to 7 --&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;z1-7&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;dbfile&gt;</span>/path/to/z0-0-0.sqlite3<span class="nt">&lt;/dbfile&gt;</span>
<span class="nt">&lt;/cache&gt;</span>

<span class="cm">&lt;!-- Composite cache made of all caches to address all zoom levels --&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;zfull&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;composite&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">min-zoom=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">max-zoom=</span><span class="s">&quot;7&quot;</span><span class="nt">&gt;</span>z1-7<span class="nt">&lt;/cache&gt;</span>
<span class="w">  </span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">min-zoom=</span><span class="s">&quot;8&quot;</span><span class="nt">&gt;</span>z8<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>The following template keys will be made available:</p>
<ul class="simple">
<li><p><cite>{top}</cite> is replaced by the top zoom level.</p></li>
<li><p><cite>{top_x}</cite> is replaced by the x value of the tile index at top zoom level,
starting from left</p></li>
<li><p><cite>{top_y}</cite> is replaced by the y value of the tile index at top zoom level,
starting from bottom</p></li>
<li><p><cite>{inv_top_x}</cite> is replaced by the x value of the tile index at top zoom level,
starting from right</p></li>
<li><p><cite>{inv_top_y}</cite> is replaced by the y value of the tile index at top zoom level,
starting from top</p></li>
</ul>
<p>The following formatting attributes will be made available: <cite>top_fmt</cite>,
<cite>top_x_fmt</cite>, <cite>top_y_fmt</cite>, <cite>inv_top_x_fmt</cite>, <cite>inv_top_y_fmt</cite>. They
default to <cite>“%d”</cite>.</p>
</section>
<section id="backward-compatibility-issues">
<h2>Backward compatibility issues<a class="headerlink" href="#backward-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>None.</p>
</section>
<section id="documentation-needs">
<h2>Documentation needs<a class="headerlink" href="#documentation-needs" title="Link to this heading">¶</a></h2>
<p>MapCache <a class="reference internal" href="../../mapcache/caches.html#mapcache-caches"><span class="std std-ref">Cache Types</span></a> document will be updated.</p>
</section>
<section id="files">
<h2>Files<a class="headerlink" href="#files" title="Link to this heading">¶</a></h2>
<p>This new feature is implemented in:</p>
<ul class="simple">
<li><p><cite>lib/cache_sqlite.c</cite></p></li>
<li><p><cite>contrib/mapcache_detail/mapcache_detail.c</cite></p></li>
</ul>
</section>
<section id="ticket-id-and-reference">
<h2>Ticket ID and reference<a class="headerlink" href="#ticket-id-and-reference" title="Link to this heading">¶</a></h2>
<p>Associated pull request is <a class="reference external" href="https://github.com/MapServer/mapcache/pull/224">#224</a>.</p>
</section>
<section id="voting-history">
<h2>Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Adopted with +1 from PSC members JeffM, MikeS, JeromeB, JukkaR, EvenR, SethG, SteveL, StephanM</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 130: Add support to Z-top, a multi-SQLite, multi-pyramid cache structure</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#proposed-solution">Proposed solution</a></li>
<li><a class="reference internal" href="#backward-compatibility-issues">Backward compatibility issues</a></li>
<li><a class="reference internal" href="#documentation-needs">Documentation needs</a></li>
<li><a class="reference internal" href="#files">Files</a></li>
<li><a class="reference internal" href="#ticket-id-and-reference">Ticket ID and reference</a></li>
<li><a class="reference internal" href="#voting-history">Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-131.html" title="MS RFC 131: Allow file paths in MapCache second level dimension values"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-129.html" title="MS RFC 129: Update msautotest to use Pytest"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 130: Add support to Z-top, a multi-SQLite, multi-pyramid cache structure</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>