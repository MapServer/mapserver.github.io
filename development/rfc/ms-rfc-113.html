<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 113: Layer Compositing Pipeline &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 114: Faster retrieval of shape count" href="ms-rfc-114.html" />
    <link rel="prev" title="MS RFC 112: Retry “Follow” label positioning after maxoverlapangle colision" href="ms-rfc-112.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-113.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-114.html" title="MS RFC 114: Faster retrieval of shape count"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-112.html" title="MS RFC 112: Retry “Follow” label positioning after maxoverlapangle colision"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 113: Layer Compositing Pipeline</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-113-layer-compositing-pipeline">
<span id="rfc113"></span><h1>MS RFC 113: Layer Compositing Pipeline<a class="headerlink" href="#ms-rfc-113-layer-compositing-pipeline" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2015/02</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Thomas Bonfort</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="mailto:thomas&#46;bonfort&#37;&#52;&#48;gmail&#46;com">thomas<span>&#46;</span>bonfort<span>&#64;</span>gmail<span>&#46;</span>com</a></p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Implemented</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>MapServer 7.0</p>
</dd>
</dl>
<section id="motivation">
<h2>1. Motivation<a class="headerlink" href="#motivation" title="Link to this heading">¶</a></h2>
<p>Some cartographic renderings would benefit from the addition of advanced
blending modes, as can be explained in detail in
<a class="reference external" href="http://en.wikipedia.org/wiki/Blend_modes">http://en.wikipedia.org/wiki/Blend_modes</a> . In particular, this functionality is
essential for more pleasant renderings of raster hillshadings over vector
surfaces.</p>
</section>
<section id="proposed-enhancement">
<h2>2. Proposed enhancement<a class="headerlink" href="#proposed-enhancement" title="Link to this heading">¶</a></h2>
<p>The LAYER-&gt;OPACITY functionality will be replaced with one or more LAYER-&gt;COMPOSITE
blocks that will define which compositing mode should be used to blend the current
layer onto the pre-exisiting basemap. Similarly to when using the actual LAYER-&gt;OPACITY
mechanism, the addition of a LAYER-&gt;COMPOSITE block will instruct mapserver to render
the current layer in a temporary image buffer and composite it back onto the base image
in a final step.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
  <span class="n">COMPOSITE</span>
    <span class="n">COMPOP</span> <span class="s2">&quot;multiply&quot;</span>
    <span class="n">OPACITY</span> <span class="mi">70</span>
    <span class="n">COMPFILTER</span> <span class="s2">&quot;foo&quot;</span> <span class="c1">#reserved for future use</span>
  <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>The COMPFILTER keyword will allow to also apply some kind of filter to the pixels
before compositing them onto the base image (this would typically be used to apply
a blurring filter to the layer to obtain a halo effect around geometries). The syntax
and implementations for such features will be determined in a future release and RFC.
Supporting multiple COMPOSITE blocks inside a LAYER will only make real sense once these
COMPFILTERs are decided upon.</p>
<section id="supported-compositing-operations">
<h3>2.1 Supported Compositing Operations<a class="headerlink" href="#supported-compositing-operations" title="Link to this heading">¶</a></h3>
<p>The default compositing operator which is equivalent to the current
layer compositing operator is “src-over”. The COMPOP values that
can be used should be explicit and are listed here:</p>
<ul class="simple">
<li><p>clear</p></li>
<li><p>color-burn</p></li>
<li><p>color-dodge</p></li>
<li><p>contrast*</p></li>
<li><p>darken</p></li>
<li><p>difference</p></li>
<li><p>dst</p></li>
<li><p>dst-atop</p></li>
<li><p>dst-in</p></li>
<li><p>dst-out</p></li>
<li><p>dst-over</p></li>
<li><p>exclusion</p></li>
<li><p>hard-light</p></li>
<li><p>invert*</p></li>
<li><p>invert-rgb*</p></li>
<li><p>lighten</p></li>
<li><p>minus*</p></li>
<li><p>multiply</p></li>
<li><p>overlay</p></li>
<li><p>plus</p></li>
<li><p>screen</p></li>
<li><p>soft-light</p></li>
<li><p>src</p></li>
<li><p>src-atop</p></li>
<li><p>src-in</p></li>
<li><p>src-out</p></li>
<li><p>src-over</p></li>
<li><p>xor</p></li>
</ul>
<p>Operators marked with a star (*) will only be supported when using an AGG
backends <em>and</em> when pixman support is not enabled, and will fall back to
“src-over” when this is not the case.</p>
</section>
</section>
<section id="backwards-compatibility">
<h2>2.2 Backwards Compatibility<a class="headerlink" href="#backwards-compatibility" title="Link to this heading">¶</a></h2>
<p>LAYER-&gt;OPACITY will be deprecated and should be replaced by</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
  <span class="n">COMPOSITE</span>
    <span class="n">OPACITY</span> <span class="mi">70</span>
  <span class="n">END</span>
</pre></div>
</div>
<p>in new mapfiles. The mapfile parser and mapscript setters/getters will be updated
to work with LAYER-&gt;OPACITY but will produce unspecified results if used in
conjunction with COMPOSITE blocks.</p>
</section>
<section id="performance-implications">
<h2>2.3 Performance Implications<a class="headerlink" href="#performance-implications" title="Link to this heading">¶</a></h2>
<p>None if not explicitly enabled. Depending on the selected compositing operator
performance may be slightly degraded compared to when using “src-over”.</p>
</section>
<section id="limitations">
<h2>2.4 Limitations<a class="headerlink" href="#limitations" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>The Compositing pipeline is ony supported by pixel renderers, and as such will
not be functional for PDF and SVG backends.</p></li>
<li><p>Some compositing operators are not supported by the cairo backends or when pixman
support has been enabled.</p></li>
</ul>
</section>
<section id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
<section id="architecture">
<h3>3.1 Architecture<a class="headerlink" href="#architecture" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Renderers will have their vtable signature updated to include a
compositeRasterBuffer() function to be used when compositing has been
requested.</p></li>
<li><p>msDrawMap() will be modified to create a temporary image and then call
compositeRasterBuffer() once the layer rendering is over.</p></li>
<li><p>TBD: The current implementation can be configured to use pixman as an external
dependency to enable use of SSE optimized operations inside the AGG renderer.
Whether this will be kept in the long term should be decided upon depending on
the cost/benefit ratio (performance, features, dependencies)</p></li>
</ul>
</section>
<section id="affected-files">
<h3>3.1 Affected files<a class="headerlink" href="#affected-files" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>mapfile.c, maplexer.l: parser, keywords.</p></li>
<li><p>mapagg.cpp, mapcairo.c: actual compositing operations</p></li>
<li><p>mapcontext.c mapcopy.c, mapkml.c, maplegend.c, mapogcsld.c, maputil.c, mapscripts: housekeeping
and backwards compatibility</p></li>
<li><p>mapdraw.c: calls to compositing backends on drawing operations</p></li>
</ul>
</section>
<section id="tracking-issue">
<h3>3.2 Tracking Issue<a class="headerlink" href="#tracking-issue" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>code: <a class="reference external" href="https://github.com/tbonfort/mapserver/compare/compositing">https://github.com/tbonfort/mapserver/compare/compositing</a> (to be updated with PR#)</p></li>
<li><p>tests: TBD</p></li>
</ul>
</section>
</section>
<section id="voting-history">
<h2>4. Voting History<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>+1 from ThomasB, StephanM, MikeS, SteveW, DanielM, TomK and PerryN</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 113: Layer Compositing Pipeline</a><ul>
<li><a class="reference internal" href="#motivation">1. Motivation</a></li>
<li><a class="reference internal" href="#proposed-enhancement">2. Proposed enhancement</a><ul>
<li><a class="reference internal" href="#supported-compositing-operations">2.1 Supported Compositing Operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#backwards-compatibility">2.2 Backwards Compatibility</a></li>
<li><a class="reference internal" href="#performance-implications">2.3 Performance Implications</a></li>
<li><a class="reference internal" href="#limitations">2.4 Limitations</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a><ul>
<li><a class="reference internal" href="#architecture">3.1 Architecture</a></li>
<li><a class="reference internal" href="#affected-files">3.1 Affected files</a></li>
<li><a class="reference internal" href="#tracking-issue">3.2 Tracking Issue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#voting-history">4. Voting History</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-114.html" title="MS RFC 114: Faster retrieval of shape count"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-112.html" title="MS RFC 112: Retry “Follow” label positioning after maxoverlapangle colision"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 113: Layer Compositing Pipeline</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>