<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 101: Add Support for Content Dependent Legend Responses &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 102: Support of Styleitem JavaScript Plugin" href="ms-rfc-102.html" />
    <link rel="prev" title="MS RFC 100: Support for tile index with mixed SRS in raster layers" href="ms-rfc-100.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-101.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-102.html" title="MS RFC 102: Support of Styleitem JavaScript Plugin"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-100.html" title="MS RFC 100: Support for tile index with mixed SRS in raster layers"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 101: Add Support for Content Dependent Legend Responses</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-101-add-support-for-content-dependent-legend-responses">
<span id="rfc101"></span><h1>MS RFC 101: Add Support for Content Dependent Legend Responses<a class="headerlink" href="#ms-rfc-101-add-support-for-content-dependent-legend-responses" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2013-07-19</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Thomas Bonfort</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="mailto:thomas&#46;bonfort&#37;&#52;&#48;gmail&#46;com">thomas<span>&#46;</span>bonfort<span>&#64;</span>gmail<span>&#46;</span>com</a></p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Adopted</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>MapServer 6.4</p>
</dd>
</dl>
<section id="summary">
<h2>1. Summary<a class="headerlink" href="#summary" title="Link to this heading">¶</a></h2>
<p>The WMS GetLegendGraphic currently returns a legend image whose content matches
the classes that are defined in the mapfile (which may also be overridden by an
SLD), as specified by the WMS specification. This RFC proposes an extension to
the GetLegendGraphic response by returning a legend that corresponds to the
features that are actually present/rendered in the requested extent.</p>
<p>The use-case of this RFC is to be able to display a legend alongside a mapview,
with the content of the legend that only matches features that are actually
present in the mapview.</p>
<section id="example">
<h3>1.1 Example<a class="headerlink" href="#example" title="Link to this heading">¶</a></h3>
<p>Let us suppose we have a legend for a road network, comprising three classes
for motorways, major roads and minor roads.</p>
<ul class="simple">
<li><p>When fully zoomed out, a GetLegendGraphic call will return an image
containing the 3 road legend icons, one for each class.</p></li>
<li><p>When zooming into a remote rural area (i.e. with only small roads), a
GetLegendGraphic call will return an image with a single road icon, for minor
roads.</p></li>
<li><p>When zooming into the ocean, a GetLegendGraphic will return an image with no
icons for road features.</p></li>
</ul>
</section>
</section>
<section id="implementation-details">
<h2>2. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
<section id="activating-the-feature">
<h3>2.1 Activating the feature<a class="headerlink" href="#activating-the-feature" title="Link to this heading">¶</a></h3>
<p>Support for content dependent legends will be supported for WMS
GetLegendGraphic calls on POINT, LINE and POLYGON layers, when the client
includes the (non-standard) BBOX, SRS/CRS and WIDTH/HEIGHT parameters (i.e. like for
a GetMap request) in the request URL. If these parameters are not present, the
classical legend rendering will occur.</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://server/wms?SERVICE=WMS&amp;VERSION=1.1.0
&amp;REQUEST=GetLegendGraphic&amp;SRS=EPSG:3978
&amp;WIDTH=560&amp;HEIGHT=350&amp;LAYER=layer1&amp;FORMAT=image/png
&amp;BBOX=2258982,-70747,2615354,495480
</pre></div>
</div>
</div></blockquote>
</section>
<section id="code-impacts">
<h3>2.2 Code Impacts<a class="headerlink" href="#code-impacts" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Inside msWMSDispatch(), if the BBOX parameter is detected during a
GetLegendGraphic request, then the processing will skip the current
GetLegendGraphic codepath, and instead pass through the initialization phases
of GetMap requests (setting up layer groups, applying SLDs, etc…)</p></li>
<li><p>Once the GetMap initialization phases have occurred without error, go through
msHitTestMap() instead of msDrawMap(). This new function mimics msDrawMap in
the sense that it loops through active layers and calls
msLayerWhichShapes/msLayerNextShape on them, but instead of rendering the
features it marks their LAYER/CLASS/STYLE/LABEL as being activated or not by
the map draw.</p></li>
<li><p>msDrawLegend/msDrawLegenIcon get passed a new parameter that corresponds to
the hit-test result and will draw the map’s legend icons or not depending if
they are activated in the hit-test or not.</p></li>
<li><p>mode=maplegend and mode=maplegendicon are added to the traditional mapserver
cgi. The mapserverObj struct gets an added map_hittest member that is used by
the legend templating code to produce content dependent html legends.</p></li>
</ul>
</section>
<section id="quirks-and-backwards-incompatibility-issues">
<h3>2.3 Quirks and Backwards Incompatibility Issues<a class="headerlink" href="#quirks-and-backwards-incompatibility-issues" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Clients that send BBOX, SRS and WIDTH/HEIGHT parameters expecting to obtain a non
content dependent legend will be returned erroneous results. It can be argued
that these clients should not be sending out-of-spec parameters in the first
place.</p></li>
<li><p>MapServer currently treats WIDTH and HEIGHT as the size to use for the legend
icons. For content dependent legends these two parameters are used along with
BBOX to compute the scale at which the current mapview is being rendered, and
not for the size of the returned legend icons. While other parameter names
might have been chosen to avoid this overlap, the implementation sticks with
WIDTH and HEIGHT as on the one hand they permit an implementation that reuses
the current GetMap codepaths, and on the second hand these are the parameters
that are already being used by the (only?) other WMS implementation to
support this extension, namely Cubewerx.</p></li>
<li><p>RULE is ignored for content-dependant legend requests</p></li>
<li><p>GetLegendGraphic uses a LAYER= parameter to specify which layer to use
(MapServer has the extension to support multiple layers, by using
LAYER=layer1,layer2), whereas GetMap requests use the plural LAYERS= . For
content dependent GetLegendGraphic calls the code will duplicate the LAYER
parameter into the LAYERS parameter in order to use the GetMap codepaths. The
GetLegendGraphic response will be undefined if the client has included a
LAYERS parameter in the URL that does not coincide with the LAYER parameter.</p></li>
</ul>
</section>
<section id="performance-impacts-mapscripts">
<h3>2.4 Performance impacts, mapscripts<a class="headerlink" href="#performance-impacts-mapscripts" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>No performance impacts (aside from the fact that content dependent legend
rendering will be obviously slower than traditional legend rendering)</p></li>
<li><p>No user visible mapscript impacts (the mapscript code itself will need a few
tweaks when calling the msDrawLegend() and msDrawLegenIcon() functions.</p></li>
<li><p>The result of a hittest will not be available to mapscripts. Work in this
direction may be accomplished in the longer run once the APIs and hittest
structs have stabilized.</p></li>
</ul>
</section>
</section>
<section id="miscellaneous">
<h2>3. Miscellaneous<a class="headerlink" href="#miscellaneous" title="Link to this heading">¶</a></h2>
<section id="issue-tracking-id">
<h3>3.1 Issue Tracking ID<a class="headerlink" href="#issue-tracking-id" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/4713">https://github.com/MapServer/MapServer/issues/4713</a></p>
</section>
<section id="voting-history">
<h3>3.2 Voting History<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h3>
<p>+1 from ThomasB, MikeS, TomK, StephanM, PerryN, SteveL, SteveW and JeffM</p>
</section>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 101: Add Support for Content Dependent Legend Responses</a><ul>
<li><a class="reference internal" href="#summary">1. Summary</a><ul>
<li><a class="reference internal" href="#example">1.1 Example</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-details">2. Implementation Details</a><ul>
<li><a class="reference internal" href="#activating-the-feature">2.1 Activating the feature</a></li>
<li><a class="reference internal" href="#code-impacts">2.2 Code Impacts</a></li>
<li><a class="reference internal" href="#quirks-and-backwards-incompatibility-issues">2.3 Quirks and Backwards Incompatibility Issues</a></li>
<li><a class="reference internal" href="#performance-impacts-mapscripts">2.4 Performance impacts, mapscripts</a></li>
</ul>
</li>
<li><a class="reference internal" href="#miscellaneous">3. Miscellaneous</a><ul>
<li><a class="reference internal" href="#issue-tracking-id">3.1 Issue Tracking ID</a></li>
<li><a class="reference internal" href="#voting-history">3.2 Voting History</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-102.html" title="MS RFC 102: Support of Styleitem JavaScript Plugin"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-100.html" title="MS RFC 100: Support for tile index with mixed SRS in raster layers"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 101: Add Support for Content Dependent Legend Responses</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>