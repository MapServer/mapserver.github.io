<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 60: Labeling enhancement: ability to skip ANGLE FOLLOW labels with too much character overlap &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 61: Enhance MapServer Feature Style Support" href="ms-rfc-61.html" />
    <link rel="prev" title="MS RFC 59: Add Variable Binding to Database Connection Types" href="ms-rfc-59.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-60.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-61.html" title="MS RFC 61: Enhance MapServer Feature Style Support"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-59.html" title="MS RFC 59: Add Variable Binding to Database Connection Types"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 60: Labeling enhancement: ability to skip ANGLE FOLLOW labels with too much character overlap</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-60-labeling-enhancement-ability-to-skip-angle-follow-labels-with-too-much-character-overlap">
<span id="rfc60"></span><h1>MS RFC 60: Labeling enhancement: ability to skip ANGLE FOLLOW labels with too much character overlap<a class="headerlink" href="#ms-rfc-60-labeling-enhancement-ability-to-skip-angle-follow-labels-with-too-much-character-overlap" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2009/06/26</p>
</dd>
<dt class="field-even">Authors<span class="colon">:</span></dt>
<dd class="field-even"><p>Daniel Morissette (dmorissette at mapgears.com)</p>
</dd>
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Alan Boudreault (aboudreault at mapgears.com)</p>
</dd>
<dt class="field-even">Last Edited<span class="colon">:</span></dt>
<dd class="field-even"><p>2010-09-02</p>
</dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><p>Adopted on 2010-09-23</p>
</dd>
<dt class="field-even">Version<span class="colon">:</span></dt>
<dd class="field-even"><p>MapServer 6.0</p>
</dd>
</dl>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>At the moment, ANGLE FOLLOW labels on very sharp curved lines can result
in labels on which some characters overlap, resulting in either bad looking or
sometimes completely unreadable labels.</p>
<p>This RFC proposes a mechanism to detect overlapping characters in ANGLE FOLLOW
labels and simply skip the labels, leaving room for other/better labels to fall
around the same spot, leading to better looking maps.</p>
<p>In ticket <a class="reference external" href="https://github.com/MapServer/MapServer/issues/2221">#2221</a>, several
options were discussed to improve problematic ANGLE FOLLOW labels, including
line smoothing, or increasing the spacing between the characters when
overlaps are detected, those approaches may have potential but will be
dealt with separately (i.e. in their own RFCs).</p>
<p>This RFC deals specifically with skipping bad labels with too much character
overlap and ticket <a class="reference external" href="https://github.com/MapServer/MapServer/issues/3523">#3523</a>
has been created for it.</p>
</section>
<section id="background">
<h2>Background<a class="headerlink" href="#background" title="Link to this heading">¶</a></h2>
<p>This issue was found as part of the FOSS4G 2010 Benchmarking exercise where one
of the layers to render was contours with labels. We’ve seen that MapServer
did a poor job of labeling some contours with sharp curves using ANGLE FOLLOW,
resulting in overlapping characters and unreadable labels.</p>
<p>OTOH, we found that GeoServer for instance didn’t have this type of
problematic labels because it simply detected the overlapping chars and
skipped those labels. This is the approach we propose to implement here.</p>
<p>Here are two maps of the same area, the first produced by MapServer with the
bad labels and the second by GeoServer without the bad labels:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-wms.png">http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-wms.png</a></p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/3523/geoserver-wms.png">http://trac.osgeo.org/mapserver/attachment/ticket/3523/geoserver-wms.png</a></p>
</section>
<section id="experiments">
<h2>Experiments<a class="headerlink" href="#experiments" title="Link to this heading">¶</a></h2>
<p>We have found that it is of no use to test the character bboxes for
overlap since most of them overlap in normal situations as we can see in
the following images:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-label-boxes.png">http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-label-boxes.png</a></p>
<p>OTOH we found that we could compare the angles of consecutive characters
within a given label and use that as a better indicator of
possible overlap. In most cases, a overlap of more than 22.5 degrees
is a good threshold to use to decide to skip a given label.</p>
<p>The following image shows the same contours in which labels with character
overlap larger than 22.5 degrees are skipped:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-label-with-fix.png">http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-label-with-fix.png</a></p>
<p>Here is another example with a street map:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/3523/maxoverlapangle-2.png">http://trac.osgeo.org/mapserver/attachment/ticket/3523/maxoverlapangle-2.png</a></p>
</section>
<section id="technical-solution">
<h2>Technical Solution<a class="headerlink" href="#technical-solution" title="Link to this heading">¶</a></h2>
<p>A new MAXOVERLAPANGLE keyword will be added to the LABEL object, whose
value is the angle threshold to use in filtering out ANGLE FOLLOW labels in
which characters overlap (floating point value in degrees).</p>
<p>This filtering will be enabled by default starting with MapServer 6.0. The
default MAXOVERLAPANGLE value will be 22.5 degrees, which also matches the
default in GeoServer. Users will be free to tune the value up or down
depending on the type of data they are dealing with and their tolerance
to bad overlap in labels.</p>
<p>Setting MAXOVERLAPANGLE == 0 will completely disable filtering of labels
based on this criteria, restoring the pre-6.0 behavior.</p>
</section>
<section id="usage-example">
<h2>Usage example<a class="headerlink" href="#usage-example" title="Link to this heading">¶</a></h2>
<p>This feature is enabled by default with a default value of 22.5 degrees,
so no mapfile changes are required to enable it.</p>
<p>This example will increase the MAXOVERLAPANGLE to 30 degrees, resulting in
less labels being skipped:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MAP</span>
  <span class="o">...</span>
  <span class="n">LABEL</span>
     <span class="n">ANGLE</span> <span class="n">FOLLOW</span>
     <span class="o">...</span>
     <span class="n">MAXOVERLAPANGLE</span> <span class="mi">30</span>
  <span class="n">END</span>
  <span class="o">...</span>
<span class="n">END</span>
</pre></div>
</div>
<p>Keep in mind that this option can be combined with REPEATDISTANCE and
MINDISTANCE to produce maps with even more labels. Here is an example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MAP</span>
  <span class="o">...</span>
  <span class="n">LABEL</span>
     <span class="n">ANGLE</span> <span class="n">FOLLOW</span>
     <span class="o">...</span>
     <span class="n">MAXOVERLAPANGLE</span> <span class="mf">22.5</span>
     <span class="n">REPEATDISTANCE</span> <span class="mi">400</span>
     <span class="n">MINDISTANCE</span> <span class="mi">100</span>
  <span class="n">END</span>
  <span class="o">...</span>
<span class="n">END</span>
</pre></div>
</div>
<p>… and here is the resulting contour map with the above settings:</p>
<p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-collisions-repeatdistance-400-min-100.png">http://trac.osgeo.org/mapserver/attachment/ticket/3523/mapserver-collisions-repeatdistance-400-min-100.png</a></p>
</section>
<section id="backwards-compatibility-issues">
<h2>Backwards Compatibility Issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>This new feature will be enabled by default with a default MAXOVERLAPANGLE
value of 22.5 degreees. Existing mapfiles will work without any change, but
may end up producing maps with less labels if they contain several bad labels
with overlapping characters. It is always possible to come back to the old
behavior (disabling filtering) using MAXOVERLAPANGLE 0 or to tune the value
up or down to get better results.</p>
<p>There is no other backwards compatibility issue.</p>
</section>
<section id="files-impacted">
<h2>Files Impacted<a class="headerlink" href="#files-impacted" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>mapfile.c</p></li>
<li><p>mapfile.h</p></li>
<li><p>mapserver.h</p></li>
<li><p>maplexer.c</p></li>
<li><p>maplexer.l</p></li>
<li><p>mapprimitive.c</p></li>
</ul>
</section>
<section id="ticket-id">
<h2>Ticket Id<a class="headerlink" href="#ticket-id" title="Link to this heading">¶</a></h2>
<p>Main ticket:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/3523">http://trac.osgeo.org/mapserver/attachment/ticket/3523</a></p></li>
</ul>
<p>See also:</p>
<ul class="simple">
<li><p><a class="reference external" href="http://trac.osgeo.org/mapserver/attachment/ticket/2221">http://trac.osgeo.org/mapserver/attachment/ticket/2221</a></p></li>
</ul>
</section>
<section id="voting-history">
<h2>Voting History<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Adopted on 2010-09-23 with +1 from DanielM, SteveL, FrankW, TomK, PericlesN, ThomasB, SteveW, HowardB, AssefaY, JeffM and TamasS.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 60: Labeling enhancement: ability to skip ANGLE FOLLOW labels with too much character overlap</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#experiments">Experiments</a></li>
<li><a class="reference internal" href="#technical-solution">Technical Solution</a></li>
<li><a class="reference internal" href="#usage-example">Usage example</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">Backwards Compatibility Issues</a></li>
<li><a class="reference internal" href="#files-impacted">Files Impacted</a></li>
<li><a class="reference internal" href="#ticket-id">Ticket Id</a></li>
<li><a class="reference internal" href="#voting-history">Voting History</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-61.html" title="MS RFC 61: Enhance MapServer Feature Style Support"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-59.html" title="MS RFC 59: Add Variable Binding to Database Connection Types"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 60: Labeling enhancement: ability to skip ANGLE FOLLOW labels with too much character overlap</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>