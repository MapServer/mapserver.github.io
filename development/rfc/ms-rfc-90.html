<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 91: Layer Filter Normalization" href="ms-rfc-91.html" />
    <link rel="prev" title="MS RFC 89: Layer Geomtransforms" href="ms-rfc-89.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-90.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-91.html" title="MS RFC 91: Layer Filter Normalization"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-89.html" title="MS RFC 89: Layer Geomtransforms"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-90-enable-disable-layers-in-ogc-web-services-by-ip-lists">
<span id="rfc90"></span><h1>MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists<a class="headerlink" href="#ms-rfc-90-enable-disable-layers-in-ogc-web-services-by-ip-lists" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2013/02/14</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Tamas Szekeres</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p>szekerest at gmail.com</p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Accepted (2013/03/02), Implemented</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>MapServer 6.3-dev</p>
</dd>
</dl>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>This RFC provides the option to enable or disable OWS layers by IP lists. The aim is to let
the admin to define list of users, identified through their IPs to allow or deny access to
one or more specific WxS layers.</p>
</section>
<section id="proposed-solution">
<h2>2. Proposed Solution<a class="headerlink" href="#proposed-solution" title="Link to this heading">¶</a></h2>
<p>This addition will provide 2 more parameters in the WEB/METADATA section of the mapfile and/or in
the METADATA section of every single layer.</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>ows_allowed_ip_list</strong>: contains the list of the allowed ip addresses or ranges</p></li>
<li><p><strong>ows_denied_ip_list</strong>: contains the list of the denied ip addresses or ranges</p></li>
</ul>
</div></blockquote>
<p>These parameters support both a list of addresses from a file, or the ability to provide the
values directly in the mapfile, in the cases where there are only a couple of IPs or ranges to be specified.</p>
<p>When setting the IP list inline, we can use spaces as separators, like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
  <span class="n">METADATA</span>
    <span class="s2">&quot;ows_allowed_ip_list&quot;</span> <span class="s2">&quot;123.45.67.89 11.22.33.44&quot;</span>
  <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>Or we can specify a file containing the list of the IP addresses (IPs and ranges in the file are separated
by spaces or newlines)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LAYER</span>
  <span class="n">METADATA</span>
    <span class="s2">&quot;ows_allowed_ip_list&quot;</span> <span class="s2">&quot;file:/path/to/list_of_ips.txt&quot;</span>
  <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>We can also specify IP ranges using the <a class="reference external" href="http://en.wikipedia.org/wiki/CIDR_notation">CIDR notation</a> , like: “192.168.1.0/24”</p>
<p>Setting ows_allowed_ip_list will deny all other IPs not specified in the list, and setting ows_denied_ip_list will allow all other IPs not specified in the list. When we both allow and deny a given IP the denial will take precedence.</p>
<p>The setting of <strong>ows_enable_request</strong> (added in <a class="reference internal" href="ms-rfc-67.html#rfc67"><span class="std std-ref">MS RFC 67</span></a>) will also be taken into account.
Disabled requests cannot be re-enabled by IP lists, however we can restrict the access to a subset of layes
by IP lists within the enabled OGC web services.</p>
<p>We will also be able to use the corresponding service specific settings (like <strong>wms_allowed_ip_list</strong>
or <strong>wfs_allowed_ip_list</strong>)</p>
<p>This addition will support using both ipv4 and ipv6 IP addresses.</p>
</section>
<section id="disable-the-stock-cgi-operations">
<h2>3. Disable the stock CGI operations<a class="headerlink" href="#disable-the-stock-cgi-operations" title="Link to this heading">¶</a></h2>
<p>We also require to prevent the clients to work around the IP restrictions by using the stock CGI operations
(mode=…). For this reason we add a new parameter to the WEB section of the mapfile (<strong>ms_enable_modes</strong>) to
control which modes should be enabled.
The <strong>ms_enable_modes</strong> will rely on the current implementetion of enable_request, so can use the asterisk ‘*’
to specify all modes and a preceding exclamation sign ‘!’ can be used to negate a given condition.</p>
<p>To retain the backwards compatibility, if we don’t specify the <strong>ms_enable_modes</strong> then all of the modes
are enabled and dispatched.</p>
<p>When using OGC Web services, we don’t require to specify modes by the URL, so we can block all
CGI modes by using the following setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WEB</span>
  <span class="n">METADATA</span>
        <span class="c1"># Block all CGI modes by default for this mapfile</span>
    <span class="s2">&quot;ms_enable_modes&quot;</span>  <span class="s2">&quot;!*&quot;</span>
  <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>This will dispatch only those requests where explicit mode is not set by URL. It is suggested for all
existing users to include this setting in the mapfiles if they intend to provide just OGC web services.</p>
<p>We’ll also be able to enable the modes selectively, as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WEB</span>
  <span class="n">METADATA</span>
    <span class="c1"># Enable Only MAP and LEGEND modes for this mapfile</span>
    <span class="s2">&quot;ms_enable_modes&quot;</span> <span class="s2">&quot;!* MAP LEGEND&quot;</span>
      <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>To enable all modes except MAP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WEB</span>
  <span class="n">METADATA</span>
    <span class="c1"># Enable all modes except MAP for this mapfile</span>
    <span class="s2">&quot;ms_enable_modes&quot;</span> <span class="s2">&quot;!MAP&quot;</span>
      <span class="n">END</span>
<span class="n">END</span>
</pre></div>
</div>
<p>Given the mode specified by URL is disabled, MapServer will provide the following error message:</p>
<blockquote>
<div><p>“The specified mode … is not supported by the current map configuration”</p>
</div></blockquote>
<p>Within the scope of this RFC we don’t intend to support LAYER level setting of <strong>ms_enable_modes</strong>.</p>
</section>
<section id="implementation-details">
<h2>4. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
<p>This change will utilize the mechanism established in <a class="reference internal" href="ms-rfc-67.html#rfc67"><span class="std std-ref">MS RFC 67</span></a>, which makes the implementation
fairly straightforward. Most of the functionality is provided by adding a new functions
(msOWSIpDisabled, msOWSIpInMetadata, msOWSIpInList, msOWSIpParse)
to mapows.c, to check whether a particular IP is disabled or not.
The msOWSIpDisabled function is invoked from msOWSRequestIsEnabled and msOWSRequestLayersEnabled
to prevent from adding the disabled layer to the enabled_layers list.</p>
<p>msOWSIpParse will parse the sting representation and the subnet into byte arrays. To test whether
the IPs match, we make sure the following condition is true for each byte position</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">ip1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="p">(</span><span class="n">ip2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
<p>The length of the byte array can be 4 (ipv4) or 16 (ipv6).</p>
<p>With regards to ipv6 we support both upper and lowercases in hex digits and support omitting the trailing zeros
for each segment. We’ll also support te shorthand of subsequent segmens containing zeros by using double colons ‘::’
like: 2001:0db8::ff00:0042:8329
When parsing ipv6 we write each segment of the IPs and masks as unsigned shorts, which should work with both the big
endian and little endian memory representations.</p>
<p>The setting <strong>ms_enable_modes</strong> will be implemented in msCGISetMode directly
(in mapservutil.c). The implementation will explicitly call the current msOWSParseRequestMetadata function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if (mapserv-&gt;Mode &gt;= 0)
{
  int disabled = MS_FALSE;
  const char* enable_modes = msLookupHashTable(&amp;mapserv-&gt;map-&gt;web.metadata, &quot;ms_enable_modes&quot;);

  if (!msOWSParseRequestMetadata(enable_modes, mode, &amp;disabled) &amp;&amp; disabled) {
    /* the current mode is disabled */
    msSetError(MS_WEBERR, &quot;The specified mode &#39;%s&#39; is not supported by the current map configuration&quot;, &quot;msCGISetMode()&quot;, mode);
    return MS_FAILURE;
  }
}
</pre></div>
</div>
</section>
<section id="files-affected">
<h2>5. Files Affected<a class="headerlink" href="#files-affected" title="Link to this heading">¶</a></h2>
<blockquote>
<div><ul class="simple">
<li><p>mapows.c: Implement and call msOWSIpDisabled, msOWSIpInMetadata, msOWSIpInList, msOWSIpParse methods</p></li>
<li><p>mapservutil.c: Implement and <strong>ms_enable_modes</strong> logic</p></li>
</ul>
</div></blockquote>
</section>
<section id="bug-id">
<h2>6. Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/4588">https://github.com/MapServer/MapServer/issues/4588</a></p>
</section>
<section id="backwards-compatibility-issues">
<h2>7. Backwards compatibility issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>None expected, new functionality.</p>
</section>
<section id="documentation">
<h2>8. Documentation<a class="headerlink" href="#documentation" title="Link to this heading">¶</a></h2>
<p>Within the scope of this addition we will also update the following documents:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://mapserver.org/ogc/sos_server.html">SOS Server</a> : Adding <strong>sos_allowed_ip_list</strong>, <strong>sos_denied_ip_list</strong></p></li>
<li><p><a class="reference external" href="https://mapserver.org/ogc/wcs_server.html">WCS Server</a> : Adding <strong>wcs_allowed_ip_list</strong>, <strong>wcs_denied_ip_list</strong></p></li>
<li><p><a class="reference external" href="https://mapserver.org/ogc/wfs_server.html">WFS Server</a> : Adding <strong>wfs_allowed_ip_list</strong>, <strong>wfs_denied_ip_list</strong></p></li>
<li><p><a class="reference external" href="https://mapserver.org/ogc/wms_server.html">WMS Server</a> : Adding <strong>wms_allowed_ip_list</strong>, <strong>wms_denied_ip_list</strong></p></li>
<li><p><a class="reference external" href="https://mapserver.org/mapfile/web.html">MapFile/WEB</a> : Adding <strong>ms_enable_modes</strong> in the WEB METADATA section</p></li>
</ul>
</div></blockquote>
</section>
<section id="sponsorship">
<h2>9. Sponsorship<a class="headerlink" href="#sponsorship" title="Link to this heading">¶</a></h2>
<p>Developed for Faunalia (<a class="reference external" href="http://www.faunalia.it">http://www.faunalia.it</a>) with funding from Regione Toscana -
Settore SISTEMA INFORMATIVO TERRITORIALE ED AMBIENTALE”. For the project: “Sviluppo
strumenti software per il trattamento di dati geografici basati su QuantumGIS e
Postgis (CIG 0494241492)”</p>
</section>
<section id="voting-history">
<h2>10. Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Thomas Bonfort  -0
Tom Kralidis +1
Daniel Morissette +1
Tamas Szekeres +1
Stephen Woodbridge +1</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-solution">2. Proposed Solution</a></li>
<li><a class="reference internal" href="#disable-the-stock-cgi-operations">3. Disable the stock CGI operations</a></li>
<li><a class="reference internal" href="#implementation-details">4. Implementation Details</a></li>
<li><a class="reference internal" href="#files-affected">5. Files Affected</a></li>
<li><a class="reference internal" href="#bug-id">6. Bug ID</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">7. Backwards compatibility issues</a></li>
<li><a class="reference internal" href="#documentation">8. Documentation</a></li>
<li><a class="reference internal" href="#sponsorship">9. Sponsorship</a></li>
<li><a class="reference internal" href="#voting-history">10. Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-91.html" title="MS RFC 91: Layer Filter Normalization"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-89.html" title="MS RFC 89: Layer Geomtransforms"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>