<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 114: Faster retrieval of shape count &mdash; MapServer 7.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.0.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 115: Upgrade and cleanup of Tutorial and Demo datasets" href="ms-rfc-115.html" />
    <link rel="prev" title="MS RFC 113: Layer Compositing Pipeline" href="ms-rfc-113.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../faq.html" title="FAQ">FAQ</a> |
      <a href="../../download.html" title="Download">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        
        
          <a href="../../uk/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/uk.png" alt="uk" title="uk" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-115.html" title="MS RFC 115: Upgrade and cleanup of Tutorial and Demo datasets"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-113.html" title="MS RFC 113: Layer Compositing Pipeline"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &raquo;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &raquo;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-114-faster-retrieval-of-shape-count">
<span id="rfc114"></span><h1>MS RFC 114: Faster retrieval of shape count<a class="headerlink" href="#ms-rfc-114-faster-retrieval-of-shape-count" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2016/02</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Even Rouault</td>
</tr>
<tr class="field-odd field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:even&#46;rouault&#37;&#52;&#48;spatialys&#46;com">even<span>&#46;</span>rouault<span>&#64;</span>spatialys<span>&#46;</span>com</a></td>
</tr>
<tr class="field-even field"><th class="field-name">Status:</th><td class="field-body">Adopted</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapServer 7.2</td>
</tr>
<tr class="field-even field"><th class="field-name">Funding:</th><td class="field-body">Meteorological Service of Canada</td>
</tr>
</tbody>
</table>
<div class="section" id="motivation">
<h2>1. Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h2>
<p>The WFS protocol has a resultType=hits query to return only the number
of features of the specified layer(s), taking into account an optional bounding
box and/or filter.</p>
<p>See &#8220;resultType parameter&#8221; chapter (<a class="reference external" href="http://portal.opengeospatial.org/files/?artifact_id=39967">OGC WFS 2.0 specification</a>, sect. 7.6.3.6)</p>
<p>Currently MapServer implements such requests by retrieving
all individual matching features and counting them, as in a full GetFeature
response, which is suboptimal in term of speed and bandwidth with the server
instance in case of RDBMS data provider.</p>
</div>
<div class="section" id="proposed-enhancement">
<h2>2. Proposed enhancement<a class="headerlink" href="#proposed-enhancement" title="Permalink to this headline">¶</a></h2>
<p>A new virtual method is added to the vtable of MapServer layers</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">LayerGetShapeCount</span><span class="p">)(</span><span class="n">layerObj</span> <span class="o">*</span><span class="n">layer</span><span class="p">,</span> <span class="n">rectObj</span> <span class="n">rect</span><span class="p">,</span> <span class="n">projectionObj</span> <span class="o">*</span><span class="n">rectProjection</span><span class="p">);</span>
</pre></div>
</div>
<p>Its semantics is to return the number of shapes that match the potential filter and extent.
rectProjection is the projection in which rect is expressed, or can be NULL if
rect should be considered in the layer projection.
This should be equivalent to calling msLayerWhichShapes() and counting the
number of shapes returned by msLayerNextShape(), honouring layer-&gt;maxfeatures
limitation if layer-&gt;maxfeatures&gt;=0, and honouring layer-&gt;startindex if
layer-&gt;startindex &gt;= 1 and paging is enabled.
It should returns -1 in case of failure.</p>
<p>This method will be called by msQueryByRect() and msQueryByFilter() when only
feature count is requested (i.e. map-&gt;query.only_cache_result_count == 1), and
that a layer template is defined (the WFS code has traditionnaly set a fake
layer template &#8216;ttt.html&#8217; if none was defined, so as to disable any class template).
Such query is only done by the WFS server code.</p>
<p>A default implementation of LayerGetShapeCount() using msLayerWhichShapes()
and msLayerNextShape() is provided, and a specialized implementation is done in
the PostGIS driver. This implementation consists in calling
SELECT COUNT(*) FROM (the_normal_sql_query).</p>
<p>Why specifying the rectProjection in LayerGetShapeCount(), and not assuming that
rect is in the layer projection instead ?
The reason is to be completely conformant with the
current semantics of msQueryByRect() that checks that the retrieved features
intersect the bounding box in the map projection (the map projection being the
one specified by SRSNAME in the case of a WFS query). In the case of the PostGIS
provider, this can be translated in the following query to do a fast BBOX filtering,
followed by a more precision intersection for candidate records :
(the_geometry &amp;&amp; the_bbox_in_layer_projection) AND
( NOT ST_Disjoint(ST_Transform(the_geometry, rectProjectionSRID), rectProjection) )</p>
</div>
<div class="section" id="backwards-compatibility">
<h2>2.2 Backwards Compatibility<a class="headerlink" href="#backwards-compatibility" title="Permalink to this headline">¶</a></h2>
<p>This change has no backwards compatibility effect, keeping the same semantics
as the current implementation.</p>
</div>
<div class="section" id="performance-implications">
<h2>2.3 Performance Implications<a class="headerlink" href="#performance-implications" title="Permalink to this headline">¶</a></h2>
<p>Should result in performance increase for drivers that can implement efficiently
LayerGetShapeCount()</p>
<p>Currently, resultType=hits honours the server side limit defined by the wfs_maxfeatures
WEB metadata item, i.e. that the maximum number of features returned is limited to
wfs_maxfeatures when it is defined. The reason was to limit the number of
features retrieved by MapServer. This behaviour can now be controlled with a new
WEB metadata item : &#8220;wfs_maxfeatures_ignore_for_resulttype_hits&#8221; &#8220;true&#8221; (or &#8220;false&#8221;). When
it is set to true, hits operations are no longer limited by wfs_maxfeatures. The
default value of the item depends on the queried layers: if they have all an
efficient LayerGetShapeCount() operation (i.e. are PostGIS layers currently),
then the default is &#8220;true&#8221;. Otherwise it is &#8220;false&#8221;.</p>
<p>Note: of course, any client specified MAXFEATURES / COUNT parameter overrides those server
side settings, while the number of features asked by the client is no greater than
the server side limit.</p>
</div>
<div class="section" id="limitations">
<h2>2.4 Limitations<a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>A specialized implementation of LayerGetShapeCount() is only done in PostGIS
driver for the scope of this work. Could be extended similarly to providers that
have SQL semantics and implement LayerTranslateFilter(): Oracle, MSSQL Spatial</p>
</div>
<div class="section" id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<div class="section" id="affected-files">
<h3>3.1 Affected files<a class="headerlink" href="#affected-files" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>mapquery.c: to use msLayerGetFeatureCount() in msQueryByRect() and msQueryByFilter()</li>
<li>maplayer.c: defines msLayerGetFeatureCount() and LayerDefaultGetFeatureCount()</li>
<li>mapwfs.c: to take into account &#8220;wfs_maxfeatures_ignore_for_resulttype_hits&#8221;</li>
<li>mappostgis.c: implement LayerGetFeatureCount()</li>
<li>other providers: add comment that LayerGetFeatureCount uses the default implementation</li>
</ul>
</div>
<div class="section" id="tracking-issue">
<h3>3.2 Tracking Issue<a class="headerlink" href="#tracking-issue" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>code: <a class="reference external" href="https://github.com/rouault/mapserver/tree/wfs_fast_hits">https://github.com/rouault/mapserver/tree/wfs_fast_hits</a></li>
<li>tests: 4 new test cases have been added (<a class="reference external" href="https://github.com/mapserver/msautotest/commit/05e8264ce737a795d81f1a87614fa5c87399de91">https://github.com/mapserver/msautotest/commit/05e8264ce737a795d81f1a87614fa5c87399de91</a>)
to test the behaviour of resultType=hits with filters, and already existing WFS tests pass.</li>
</ul>
</div>
<div class="section" id="documentation">
<h3>3.3 Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h3>
<p>Documentation of the WFS server will be updated to document the
&#8220;wfs_maxfeatures_ignore_for_resulttype_hits&#8221; metadata item.</p>
</div>
</div>
<div class="section" id="voting-history">
<h2>4. Voting History<a class="headerlink" href="#voting-history" title="Permalink to this headline">¶</a></h2>
<p>+1 from TomK, JeffM, MichaelS, StephenW, ThomasB, DanielM, SteveL, JukkaR, StephanM, PerryN and TamasS.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 114: Faster retrieval of shape count</a><ul>
<li><a class="reference internal" href="#motivation">1. Motivation</a></li>
<li><a class="reference internal" href="#proposed-enhancement">2. Proposed enhancement</a></li>
<li><a class="reference internal" href="#backwards-compatibility">2.2 Backwards Compatibility</a></li>
<li><a class="reference internal" href="#performance-implications">2.3 Performance Implications</a></li>
<li><a class="reference internal" href="#limitations">2.4 Limitations</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a><ul>
<li><a class="reference internal" href="#affected-files">3.1 Affected files</a></li>
<li><a class="reference internal" href="#tracking-issue">3.2 Tracking Issue</a></li>
<li><a class="reference internal" href="#documentation">3.3 Documentation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#voting-history">4. Voting History</a></li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Open Source Geospatial Foundation.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.4</a>
      
    </div>

    

    
  </body>
</html>