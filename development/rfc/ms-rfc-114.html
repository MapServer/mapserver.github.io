<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 114: Faster retrieval of shape count &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 115: Upgrade and cleanup of Tutorial and Demo datasets" href="ms-rfc-115.html" />
    <link rel="prev" title="MS RFC 113: Layer Compositing Pipeline" href="ms-rfc-113.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-114.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-115.html" title="MS RFC 115: Upgrade and cleanup of Tutorial and Demo datasets"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-113.html" title="MS RFC 113: Layer Compositing Pipeline"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 114: Faster retrieval of shape count</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-114-faster-retrieval-of-shape-count">
<span id="rfc114"></span><h1>MS RFC 114: Faster retrieval of shape count<a class="headerlink" href="#ms-rfc-114-faster-retrieval-of-shape-count" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2016/02</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Even Rouault</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="mailto:even&#46;rouault&#37;&#52;&#48;spatialys&#46;com">even<span>&#46;</span>rouault<span>&#64;</span>spatialys<span>&#46;</span>com</a></p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Adopted</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>MapServer 7.2</p>
</dd>
<dt class="field-even">Funding<span class="colon">:</span></dt>
<dd class="field-even"><p>Meteorological Service of Canada</p>
</dd>
</dl>
<section id="motivation">
<h2>1. Motivation<a class="headerlink" href="#motivation" title="Link to this heading">¶</a></h2>
<p>The WFS protocol has a resultType=hits query to return only the number
of features of the specified layer(s), taking into account an optional bounding
box and/or filter.</p>
<p>See “resultType parameter” chapter (<a class="reference external" href="https://portal.ogc.org/files/?artifact_id=39967">OGC WFS 2.0 specification</a>, sect. 7.6.3.6)</p>
<p>Currently MapServer implements such requests by retrieving
all individual matching features and counting them, as in a full GetFeature
response, which is suboptimal in term of speed and bandwidth with the server
instance in case of RDBMS data provider.</p>
</section>
<section id="proposed-enhancement">
<h2>2. Proposed enhancement<a class="headerlink" href="#proposed-enhancement" title="Link to this heading">¶</a></h2>
<p>A new virtual method is added to the vtable of MapServer layers</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">LayerGetShapeCount</span><span class="p">)(</span><span class="n">layerObj</span><span class="w"> </span><span class="o">*</span><span class="n">layer</span><span class="p">,</span><span class="w"> </span><span class="n">rectObj</span><span class="w"> </span><span class="n">rect</span><span class="p">,</span><span class="w"> </span><span class="n">projectionObj</span><span class="w"> </span><span class="o">*</span><span class="n">rectProjection</span><span class="p">);</span>
</pre></div>
</div>
<p>Its semantics is to return the number of shapes that match the potential filter and extent.
rectProjection is the projection in which rect is expressed, or can be NULL if
rect should be considered in the layer projection.
This should be equivalent to calling msLayerWhichShapes() and counting the
number of shapes returned by msLayerNextShape(), honouring layer-&gt;maxfeatures
limitation if layer-&gt;maxfeatures&gt;=0, and honouring layer-&gt;startindex if
layer-&gt;startindex &gt;= 1 and paging is enabled.
It should returns -1 in case of failure.</p>
<p>This method will be called by msQueryByRect() and msQueryByFilter() when only
feature count is requested (i.e. map-&gt;query.only_cache_result_count == 1), and
that a layer template is defined (the WFS code has traditionnaly set a fake
layer template ‘ttt.html’ if none was defined, so as to disable any class template).
Such query is only done by the WFS server code.</p>
<p>A default implementation of LayerGetShapeCount() using msLayerWhichShapes()
and msLayerNextShape() is provided, and a specialized implementation is done in
the PostGIS driver. This implementation consists in calling
SELECT COUNT(*) FROM (the_normal_sql_query).</p>
<p>Why specifying the rectProjection in LayerGetShapeCount(), and not assuming that
rect is in the layer projection instead ?
The reason is to be completely conformant with the
current semantics of msQueryByRect() that checks that the retrieved features
intersect the bounding box in the map projection (the map projection being the
one specified by SRSNAME in the case of a WFS query). In the case of the PostGIS
provider, this can be translated in the following query to do a fast BBOX filtering,
followed by a more precision intersection for candidate records :
(the_geometry &amp;&amp; the_bbox_in_layer_projection) AND
( NOT ST_Disjoint(ST_Transform(the_geometry, rectProjectionSRID), rectProjection) )</p>
</section>
<section id="backwards-compatibility">
<h2>2.2 Backwards Compatibility<a class="headerlink" href="#backwards-compatibility" title="Link to this heading">¶</a></h2>
<p>This change has no backwards compatibility effect, keeping the same semantics
as the current implementation.</p>
</section>
<section id="performance-implications">
<h2>2.3 Performance Implications<a class="headerlink" href="#performance-implications" title="Link to this heading">¶</a></h2>
<p>Should result in performance increase for drivers that can implement efficiently
LayerGetShapeCount()</p>
<p>Currently, resultType=hits honours the server side limit defined by the wfs_maxfeatures
WEB metadata item, i.e. that the maximum number of features returned is limited to
wfs_maxfeatures when it is defined. The reason was to limit the number of
features retrieved by MapServer. This behaviour can now be controlled with a new
WEB metadata item : “wfs_maxfeatures_ignore_for_resulttype_hits” “true” (or “false”). When
it is set to true, hits operations are no longer limited by wfs_maxfeatures. The
default value of the item depends on the queried layers: if they have all an
efficient LayerGetShapeCount() operation (i.e. are PostGIS layers currently),
then the default is “true”. Otherwise it is “false”.</p>
<p>Note: of course, any client specified MAXFEATURES / COUNT parameter overrides those server
side settings, while the number of features asked by the client is no greater than
the server side limit.</p>
</section>
<section id="limitations">
<h2>2.4 Limitations<a class="headerlink" href="#limitations" title="Link to this heading">¶</a></h2>
<p>A specialized implementation of LayerGetShapeCount() is only done in PostGIS
driver for the scope of this work. Could be extended similarly to providers that
have SQL semantics and implement LayerTranslateFilter(): Oracle, MSSQL Spatial</p>
</section>
<section id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
<section id="affected-files">
<h3>3.1 Affected files<a class="headerlink" href="#affected-files" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>mapquery.c: to use msLayerGetFeatureCount() in msQueryByRect() and msQueryByFilter()</p></li>
<li><p>maplayer.c: defines msLayerGetFeatureCount() and LayerDefaultGetFeatureCount()</p></li>
<li><p>mapwfs.c: to take into account “wfs_maxfeatures_ignore_for_resulttype_hits”</p></li>
<li><p>mappostgis.c: implement LayerGetFeatureCount()</p></li>
<li><p>other providers: add comment that LayerGetFeatureCount uses the default implementation</p></li>
</ul>
</section>
<section id="tracking-issue">
<h3>3.2 Tracking Issue<a class="headerlink" href="#tracking-issue" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>code: <a class="reference external" href="https://github.com/rouault/mapserver/tree/wfs_fast_hits">https://github.com/rouault/mapserver/tree/wfs_fast_hits</a></p></li>
<li><p>tests: 4 new test cases have been added (<a class="reference external" href="https://github.com/MapServer/msautotest/commit/05e8264ce737a795d81f1a87614fa5c87399de91">https://github.com/MapServer/msautotest/commit/05e8264ce737a795d81f1a87614fa5c87399de91</a>)
to test the behaviour of resultType=hits with filters, and already existing WFS tests pass.</p></li>
</ul>
</section>
<section id="documentation">
<h3>3.3 Documentation<a class="headerlink" href="#documentation" title="Link to this heading">¶</a></h3>
<p>Documentation of the WFS server will be updated to document the
“wfs_maxfeatures_ignore_for_resulttype_hits” metadata item.</p>
</section>
</section>
<section id="voting-history">
<h2>4. Voting History<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>+1 from TomK, JeffM, MichaelS, StephenW, ThomasB, DanielM, SteveL, JukkaR, StephanM, PerryN and TamasS.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 114: Faster retrieval of shape count</a><ul>
<li><a class="reference internal" href="#motivation">1. Motivation</a></li>
<li><a class="reference internal" href="#proposed-enhancement">2. Proposed enhancement</a></li>
<li><a class="reference internal" href="#backwards-compatibility">2.2 Backwards Compatibility</a></li>
<li><a class="reference internal" href="#performance-implications">2.3 Performance Implications</a></li>
<li><a class="reference internal" href="#limitations">2.4 Limitations</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a><ul>
<li><a class="reference internal" href="#affected-files">3.1 Affected files</a></li>
<li><a class="reference internal" href="#tracking-issue">3.2 Tracking Issue</a></li>
<li><a class="reference internal" href="#documentation">3.3 Documentation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#voting-history">4. Voting History</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-115.html" title="MS RFC 115: Upgrade and cleanup of Tutorial and Demo datasets"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-113.html" title="MS RFC 113: Layer Compositing Pipeline"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 114: Faster retrieval of shape count</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>