<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 56: Tighten control of access to mapfiles and templates &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 57: Labeling enhancements: ability to repeat labels along a line/multiline" href="ms-rfc-57.html" />
    <link rel="prev" title="MS RFC 55: Improve control of output resolution" href="ms-rfc-55.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-56.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-57.html" title="MS RFC 57: Labeling enhancements: ability to repeat labels along a line/multiline"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-55.html" title="MS RFC 55: Improve control of output resolution"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 56: Tighten control of access to mapfiles and templates</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-56-tighten-control-of-access-to-mapfiles-and-templates">
<span id="rfc56"></span><h1>MS RFC 56: Tighten control of access to mapfiles and templates<a class="headerlink" href="#ms-rfc-56-tighten-control-of-access-to-mapfiles-and-templates" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Daniel Morissette</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>dmorissette at mapgears.com</p>
</dd>
<dt class="field-odd">Authors<span class="colon">:</span></dt>
<dd class="field-odd"><p>Steve Lime</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>steve.lime at dnr.state.mn.us</p>
</dd>
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Jeff McKenna</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>jmckenna at gatewaygeomatics.com</p>
</dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><p>Adopted and implemented on 2009-03-26</p>
</dd>
<dt class="field-even">Version<span class="colon">:</span></dt>
<dd class="field-even"><p>MapServer 5.4.0, 5.2.2, and 4.10.4.</p>
</dd>
<dt class="field-odd">Last Updated<span class="colon">:</span></dt>
<dd class="field-odd"><p>2021-03-27</p>
</dd>
</dl>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>MapServer versions 5.2.1 and older could potentially be used to access
arbitrary files via the creation of mapfiles or templates in untrusted
directories.</p>
<p>This RFC proposes a mechanism to tighten access control on mapfiles and
templates and limit the risk of leaking arbitrary file contents.</p>
<p>The new access control mechanisms will be implemented and released in
MapServer 5.4.0, 5.2.2 and 4.10.4.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All available environment variables, including <em>MS_MAPFILE</em> and those
described here, which can be optionally set to hide the <em>MAP=</em> parameter,
are listed in the document: <a class="reference internal" href="../../optimization/environment_variables.html#environment-variables"><span class="std std-ref">Environment Variables</span></a>.</p>
</div>
</section>
<section id="technical-solution">
<h2>Technical Solution<a class="headerlink" href="#technical-solution" title="Link to this heading">¶</a></h2>
<p>The following mechanisms will be put in place:</p>
<ul class="simple">
<li><p>Enforce the requirement for the MAP keyword at the beginning of mapfiles
and for the SYMBOLSET keyword at the beginning of SYMBOLSETs.</p></li>
<li><p>Require a Magic String at the beginning of all MapServer templates</p></li>
<li><p>Use of environment variables to control and restrict access to mapfiles
by the mapserv CGI:</p>
<ul>
<li><p>MS_MAP_PATTERN</p></li>
<li><p>MS_MAP_NO_PATH</p></li>
</ul>
</li>
</ul>
<p>Each of the points above are described in more details in the following
sections.</p>
</section>
<section id="enforce-the-requirement-for-the-map-and-symbolset-keywords">
<h2>Enforce the requirement for the MAP and SYMBOLSET keywords<a class="headerlink" href="#enforce-the-requirement-for-the-map-and-symbolset-keywords" title="Link to this heading">¶</a></h2>
<p>The MAP and SYMBOLSET keywords used to be optional at the beginning of
mapfiles and symbolsets respectively.</p>
<p>With this change, the MAP keyword will be required on the first line of
mapfiles and the SYMBOLSET keyword required on the first line of symbolset
files.</p>
<p>If the keyword is missing then the parser will reject the file.</p>
</section>
<section id="require-a-magic-string-at-the-beginning-of-all-mapserver-templates">
<h2>Require a Magic String at the beginning of all MapServer templates<a class="headerlink" href="#require-a-magic-string-at-the-beginning-of-all-mapserver-templates" title="Link to this heading">¶</a></h2>
<p>With this change, the first line of a template must contain the “MapServer
Template” magic string which can be surrounded by comment delimiters in the
format of the template to facilitate template editing (see examples below).
The first line of the template file will automatically be stripped from
the template and will not be included in the MapServer output.</p>
<p>If the magic string is not found then the template will be rejected by
MapServer.</p>
<p>HTML template example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!-- MapServer Template --&gt;
&lt;html&gt;
 &lt;head&gt;...&lt;/head&gt;
 &lt;body&gt;
 ...
 &lt;/body&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>XML template example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!-- MapServer Template --&gt;
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;
&lt;rootElement&gt;
  ...
&lt;/rootElement&gt;
</pre></div>
</div>
<p>GeoJSON template example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">MapServer</span> <span class="n">Template</span>
  <span class="p">[</span><span class="n">resultset</span> <span class="n">layer</span><span class="o">=</span><span class="n">foo</span><span class="p">]</span> <span class="p">{</span>
<span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;FeatureCollection&quot;</span><span class="p">,</span>
<span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[</span>
 <span class="p">[</span><span class="n">feature</span> <span class="n">trim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">]</span>
 <span class="p">{</span>
  <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Feature&quot;</span><span class="p">,</span>
  <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;[id]&quot;</span><span class="p">,</span>
  <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;PointLineString&quot;</span><span class="p">,</span>
   <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
     <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
     <span class="s2">&quot;coordinates&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">]]</span>
    <span class="p">}</span>
   <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
   <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;[description]&quot;</span><span class="p">,</span>
   <span class="s2">&quot;venue&quot;</span><span class="p">:</span> <span class="s2">&quot;[venue]&quot;</span><span class="p">,</span>
   <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;[year]&quot;</span>
  <span class="p">}</span>
 <span class="p">},</span>
 <span class="p">[</span><span class="o">/</span><span class="n">feature</span><span class="p">]</span>
 <span class="p">]</span>
<span class="p">}</span>
<span class="p">[</span><span class="o">/</span><span class="n">resultset</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="ms-map-pattern-environment-variable">
<h2>MS_MAP_PATTERN Environment Variable<a class="headerlink" href="#ms-map-pattern-environment-variable" title="Link to this heading">¶</a></h2>
<p>The optional <em>MS_MAP_PATTERN</em> environment variable, set via mod_env or other
web server equivalents, can be used to specify a Regular Expression that
must be matched by all mapfile paths passed to the mapserv CGI.</p>
<p>If <em>MS_MAP_PATTERN</em> is not set then any .map file can be loaded.</p>
<p>Apache’s SetEnv directive can be used to restrict mapfiles to a
specific directory and subdirectories.</p>
<ul>
<li><p><em>Unix users</em> may set the following expression in Apache to restrict
mapfiles to the <em>/opt/mapserver</em> directory and subdirectories:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SetEnv</span> <span class="n">MS_MAP_PATTERN</span> <span class="s2">&quot;^\/opt\/mapserver\/([^\.][_A-Za-z0-9\-\.]+\/</span><span class="si">{1}</span><span class="s2">)*([_A-Za-z0-9\-\.]+\.(map))$&quot;</span>
</pre></div>
</div>
</li>
<li><p><em>Windows Apache/MS4W users</em> can set the following expression in the Apache
conf file, to limit the possible MAP= paths to the common
<em>C:/ms4w/apps/</em> directory (where all MS4W mapfiles and applications live),
allow encoded urls, allow “.” or “_” or “-” in MAP= paths but disallow “..”
directory traversing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SetEnv</span> <span class="n">MS_MAP_PATTERN</span> <span class="s2">&quot;^(C:)?\/ms4w\/apps\/((?!\.</span><span class="si">{2}</span><span class="s2">)[_A-Za-z0-9\-\.]+\/</span><span class="si">{1}</span><span class="s2">)*([_A-Za-z0-9\-\.]+\.(map))$&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>MS4W users can see specific examples at: <a class="reference external" href="https://ms4w.com/README_INSTALL.html#securing-your-ms4w-installation">https://ms4w.com/README_INSTALL.html#securing-your-ms4w-installation</a></p>
</div>
</li>
</ul>
</section>
<section id="ms-map-no-path-environment-variable">
<h2>MS_MAP_NO_PATH Environment Variable<a class="headerlink" href="#ms-map-no-path-environment-variable" title="Link to this heading">¶</a></h2>
<p>The optional <em>MS_MAP_NO_PATH</em> environment variable can be set to any value
via mod_env or other web server equivalents to forbid the use of explicit
paths in the map=… URL parameter. Setting <em>MS_MAP_NO_PATH</em> to <strong>any value</strong>
forces the use of the map=&lt;env_variable_name&gt; mechanism in mapserv CGI URLs.</p>
<p>If this variable is not set then nothing changes and the mapserv CGI still
accepts explicit file paths via the map=… URL parameter.</p>
<p>Example, set set MS_MAP_NOPATH and some mapfile paths in Apache’s httpd.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SetEnv</span> <span class="n">MS_MAP_NO_PATH</span> <span class="s2">&quot;foo&quot;</span>
<span class="n">SetEnv</span> <span class="n">MY_MAPFILE</span> <span class="s2">&quot;/opt/mapserver/map1/mymapfile.map&quot;</span>
</pre></div>
</div>
<p>… and then calls the mapserv CGI must use environment variables for the
map=… parameter:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>http://localhost/cgi-bin/mapserv?map=MY_MAPFILE&amp;mode=...
</pre></div>
</div>
</section>
<section id="backwards-compatibility-issues">
<h2>Backwards Compatibility Issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>The MAP and SYMBOLSET keywords must be added to any mapfile and
symbolset that did not contain them already.</p>
<p>All MapServer templates must be updated to contain the “MapServer
Template” magic string on the first line.</p>
<p>The new environment variables are optional and will have no impact on
existing applications that don’t use them.</p>
</section>
<section id="files-impacted">
<h2>Files Impacted<a class="headerlink" href="#files-impacted" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>mapserver.h</p></li>
<li><p>maptemplate.c</p></li>
<li><p>mapserv.c</p></li>
</ul>
</section>
<section id="ticket-id">
<h2>Ticket Id<a class="headerlink" href="#ticket-id" title="Link to this heading">¶</a></h2>
<p>Related security tickets:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/2939">https://github.com/MapServer/MapServer/issues/2939</a></p></li>
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/2941">https://github.com/MapServer/MapServer/issues/2941</a></p></li>
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/2942">https://github.com/MapServer/MapServer/issues/2942</a></p></li>
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/2943">https://github.com/MapServer/MapServer/issues/2943</a></p></li>
<li><p><a class="reference external" href="https://github.com/MapServer/MapServer/issues/2944">https://github.com/MapServer/MapServer/issues/2944</a></p></li>
</ul>
</section>
<section id="voting-history">
<h2>Voting History<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Adopted on 2009-03-26 with +1 from DanielM, TomK, PericlesN, JeffM, SteveW, AssefaY, SteveL and TamasS.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 56: Tighten control of access to mapfiles and templates</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#technical-solution">Technical Solution</a></li>
<li><a class="reference internal" href="#enforce-the-requirement-for-the-map-and-symbolset-keywords">Enforce the requirement for the MAP and SYMBOLSET keywords</a></li>
<li><a class="reference internal" href="#require-a-magic-string-at-the-beginning-of-all-mapserver-templates">Require a Magic String at the beginning of all MapServer templates</a></li>
<li><a class="reference internal" href="#ms-map-pattern-environment-variable">MS_MAP_PATTERN Environment Variable</a></li>
<li><a class="reference internal" href="#ms-map-no-path-environment-variable">MS_MAP_NO_PATH Environment Variable</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">Backwards Compatibility Issues</a></li>
<li><a class="reference internal" href="#files-impacted">Files Impacted</a></li>
<li><a class="reference internal" href="#ticket-id">Ticket Id</a></li>
<li><a class="reference internal" href="#voting-history">Voting History</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-57.html" title="MS RFC 57: Labeling enhancements: ability to repeat labels along a line/multiline"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-55.html" title="MS RFC 55: Improve control of output resolution"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 56: Tighten control of access to mapfiles and templates</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>