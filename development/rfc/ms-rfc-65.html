<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 65 - Single-pass Query Changes for 6.0 &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 66: Better handling of temporary files" href="ms-rfc-66.html" />
    <link rel="prev" title="MS RFC 64 - MapServer Expression Parser Overhaul" href="ms-rfc-64.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-65.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-66.html" title="MS RFC 66: Better handling of temporary files"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-64.html" title="MS RFC 64 - MapServer Expression Parser Overhaul"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 65 - Single-pass Query Changes for 6.0</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-65-single-pass-query-changes-for-6-0">
<span id="rfc65"></span><h1>MS RFC 65 - Single-pass Query Changes for 6.0<a class="headerlink" href="#ms-rfc-65-single-pass-query-changes-for-6-0" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2010/11/18</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Steve Lime</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p>sdlime at comcast.net</p>
</dd>
<dt class="field-even">Last Edited<span class="colon">:</span></dt>
<dd class="field-even"><p>2010-11-18</p>
</dd>
<dt class="field-odd">Status<span class="colon">:</span></dt>
<dd class="field-odd"><p>Adopted</p>
</dd>
</dl>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>This is a proposal to straighten out issues introduced in 5.6 with the single-pass query support. We probably introduced more
change than necessary in hindsight. This RFC represents a simplification of both the C and MapScript APIs.</p>
<p>Single-pass query is really a misnomer. Pre-5.6 we would do an initial query (by point, bbox or whatever) to identify candidate
shapes and then n small queries to retrieve each result. This was obviously very slow in some cases, particular with the RDBMS
drivers. In 5.6 we switched things to basically hold a result set open post query and retain index values to the result set. We
still make 2 passes through the results but this is much more efficient than before.</p>
<p>Initially we stuck the result set id in the shapeindex attribute of a result (of type resultCacheMemberObj). This index was later
used to retrieve the feature. Long story short, at the NYC sprint we discovered that some drivers were doing things differently.
For Oracle, the result set ID was being passed in the tileindex and the shapeindex contained the global shape id. This was a
reasonable thing to do and the PostGIS driver was changed at the sprint to behave the same way. So, the shapeindex contains the
overall record index and the tileindex contains the index relative to the query result set. This re-use of the tileindex takes
advantage of a an attribute that otherwise would go unused and saves us from further complicating things. Layers that use
tile indexes are always file-based and don’t suffer (generally) from the performance problems what caused the changes in the
first place.</p>
</section>
<section id="drivers-that-implement-mslayerresultsgetshape">
<h2>Drivers that Implement msLayerResultsGetShape()<a class="headerlink" href="#drivers-that-implement-mslayerresultsgetshape" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>Oracle Spatial as msOracleSpatialLayerResultGetShape()</p></li>
<li><p>PostGIS as msPostGISLayerResultsGetShape()</p></li>
<li><p>OGR as msOGRLayerResultGetShape() (is identical to msOGRLayerGetShape())</p></li>
</ul>
</section>
<section id="proposed-techincal-changes">
<h2>Proposed Techincal Changes<a class="headerlink" href="#proposed-techincal-changes" title="Link to this heading">¶</a></h2>
<p>Cleaning up the query result portion of the code.</p>
<ol class="arabic simple">
<li><p>Drop the layer API function msLayerResultsGetShape() in favor of msLayerGetShape().</p></li>
<li><p>Edit the msLayerGetShape() for drivers that support the result set indexes (now passed as a tile index value) to look for the
tile index and if present work of the existing result set. If not, then work of the global id. That is, merge msLayerResultsGetShape()
and msLayerGetShape() into a new msLayerGetShape().</p></li>
<li><p>Remove resultsGetShape() and getFeature() methods from MapScript.</p></li>
<li><p>Refactor getShape() MapScript method to a) return a shapeObj * like getFeature() does and to b) take a resultCacheMemberObj as input
instead of the shape and tile indexes. That simplifies the inferface and abstracts the indexes so that we have more flexibility moving
forward. We wouldn’t necessarily have to change the driver implementations to take a resultCacheMemberObj at this point, that could
be done later.</p></li>
</ol>
<p>The refactored getShape() signature would like so (in layer.i for SWIG):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="n">newobject</span> <span class="n">getShape</span><span class="p">;</span>
<span class="n">shapeObj</span> <span class="o">*</span><span class="n">getShape</span><span class="p">(</span><span class="n">resultCacheMemberObj</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
<p>I’d also like to consider adding another query saving function to MapScript, something like saveQueryFeatures(). This function would write
a pre-5.6 query file which consisted of a series of shape and tile indexes. We wouldn’t write tile indexes for layers that weren’t tiled
(e.g. layers that didn’t have a TILEINDEX). This would restore some useful funcitonallity that was removed with the 5.6 changes.</p>
<ol class="arabic simple">
<li><p>Add signatures to the two styles of query files (query parameters and query results). This will allow us to write a single loader function
and improve security.</p></li>
<li><p>Add an optional flag to saveQuery() method in MapScript to save the actual query results (e.g. all the resultCacheMemberObj’s) instead
of just the query parameters.</p></li>
</ol>
<p>Post RFC a query action in MapScript would look like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>...
my $rect = new mapscript::rectObj(420000, 5120000, 582000, 5200000);
$layer-&gt;queryByRect($map, $rect); # layer is left open after this operation

for(my $i=0; $i&lt;$layer-&gt;getNumResults(); $i++) {
       my $shape = $layer-&gt;getShape($layer-&gt;getResult($)); # much simpler
       ...
}

# save query
$map-&gt;saveQuery(&#39;myquery.qy&#39;); # new style (query parameters)
$map-&gt;saveQuery(&#39;myquery.qy&#39;, 1); # old style (query feature indexes)
</pre></div>
</div>
<p>The changes are relatively technically mild. The changes in MapScript are big in that scripts that process query results will need
an update. In the end I think that’s worth it and this will be more intuitive for users.</p>
</section>
<section id="bug-id">
<h2>Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<p>#3647</p>
</section>
<section id="voting-history">
<h2>Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Passed with a +1 from Steve L., Tom, Jeff, Steve W., Perry.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 65 - Single-pass Query Changes for 6.0</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#drivers-that-implement-mslayerresultsgetshape">Drivers that Implement msLayerResultsGetShape()</a></li>
<li><a class="reference internal" href="#proposed-techincal-changes">Proposed Techincal Changes</a></li>
<li><a class="reference internal" href="#bug-id">Bug ID</a></li>
<li><a class="reference internal" href="#voting-history">Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-66.html" title="MS RFC 66: Better handling of temporary files"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-64.html" title="MS RFC 64 - MapServer Expression Parser Overhaul"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 65 - Single-pass Query Changes for 6.0</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>