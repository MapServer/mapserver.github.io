<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>MS RFC 91: Layer Filter Normalization &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="next" title="MS RFC 92: Migrating from Autotools to CMake" href="ms-rfc-92.html" />
    <link rel="prev" title="MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists" href="ms-rfc-90.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../../ar/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../../de/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../../el/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../../es/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../../fr/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../../id/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../../it/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../../ja/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../../nl_NL/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../../pl/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../../ru/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../../sq/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../../tr/development/rfc/ms-rfc-91.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-92.html" title="MS RFC 92: Migrating from Autotools to CMake"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-90.html" title="MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 91: Layer Filter Normalization</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="ms-rfc-91-layer-filter-normalization">
<span id="rfc91"></span><h1>MS RFC 91: Layer Filter Normalization<a class="headerlink" href="#ms-rfc-91-layer-filter-normalization" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Date<span class="colon">:</span></dt>
<dd class="field-odd"><p>2014/7/14</p>
</dd>
<dt class="field-even">Author<span class="colon">:</span></dt>
<dd class="field-even"><p>Steve Lime</p>
</dd>
<dt class="field-odd">Contact<span class="colon">:</span></dt>
<dd class="field-odd"><p><a class="reference external" href="mailto:sdlime&#37;&#52;&#48;comcast&#46;net">sdlime<span>&#64;</span>comcast<span>&#46;</span>net</a></p>
</dd>
<dt class="field-even">Status<span class="colon">:</span></dt>
<dd class="field-even"><p>Draft</p>
</dd>
<dt class="field-odd">Version<span class="colon">:</span></dt>
<dd class="field-odd"><p>TBD</p>
</dd>
</dl>
<section id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Layer filters are driver specific expressions that are used within MapServer in a couple of ways:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>to define feature subsets for rendering (independent of classes)</p></li>
<li><p>to define feature subsets for selected query operations</p></li>
</ol>
</div></blockquote>
<p>The first use case generally applies to drivers that don’t support some sort expression language (e.g. SQL). While
supported for PostGIS and Oracle Spatial there is little reason to use filters since the necessary SQL is better expressed
in the layer data statement. For non-RDMS drivers filters are defined either by a item/value combination or a using
MapServer’s standard expression syntax.</p>
<p>The second use case applies to all drivers where filters are defined using driver specific syntax to extract features from
a data source. This leads to a number of issues:</p>
<blockquote>
<div><ul class="simple">
<li><p>confusion and inconsistencies in mapfile syntax</p></li>
<li><p>lack of portabilty of filters between drivers</p></li>
<li><p>performance limitations because only the simplest filters are easy to represent and secure</p></li>
</ul>
</div></blockquote>
<p>Furthermore, the above two use cases are mutually excluseive which again can lead to user confusion. Existing query
operations that rely on filters (by attribute, by operator) cache the existing filter before defining and applying a new one.
While this limitation could be addressed independently it becomes a much more manageable task when using a
standardized filter definition.</p>
</section>
<section id="proposed-solution">
<h2>2. Proposed solution<a class="headerlink" href="#proposed-solution" title="Link to this heading">¶</a></h2>
<p>This SLA proposed standardizing filter definitions using the common expression syntax implemented as part of RFC XX.
Driverscapable of handling complex expressions will translate MapServer expressions to an internal representation which
should lead to <em>very</em> significant performance improvements. Drivers that don’t have that capability would apply filtering
to features much the same way as the native MapServer shapefile and tiled shapefiles already do (via msXXXLayerNextShape())</p>
</section>
<section id="driver-filter-translation">
<h2>2.1 Driver Filter Translation<a class="headerlink" href="#driver-filter-translation" title="Link to this heading">¶</a></h2>
<p>Drivers that support complex expressions (e.g. PostGIS and Oracle Spatial) will need to implement a new layer API function
(propose msXXXLayerTranslateFilter(layerObj *layer, expressionObj *filter, char *filteritem)) to translate both simple filters
amd MapServer logical expressions to a native representation. MapServer logical exressions consist of a series of tokens that
are processed from from left to right. It should be possible then to convert these tokens to a native representation of
that the driver will handle independently of MapServer– typically some flavor of SQL.</p>
</section>
<section id="filter-merging">
<h2>2.2 Filter Merging<a class="headerlink" href="#filter-merging" title="Link to this heading">¶</a></h2>
<p>Filter merging is the process of creating one expression from two and it will only be needed with MapServer query functions
that utilize filters as part of their stock processing, specifically msQueryByFilter() and msQueryByAttributes(). If an existing
filter exists it will be merged with the <em>new</em> filter. The existing filter will be cached as it always has been. Because this
operation is will result in a filter expressed using the <em>common</em> syntax this operation can be done in a general way:</p>
<blockquote>
<div><p>expressionObj *msMergeFilters(expressionObj *filter1, expressionObj *filter2)</p>
</div></blockquote>
<p>The resulting filter will then be translated to native representation if applicable later.</p>
</section>
<section id="filter-merging-examples">
<h2>2.3 Filter Merging Examples<a class="headerlink" href="#filter-merging-examples" title="Link to this heading">¶</a></h2>
<p>Case 1: FILTERITEM and FILTER “string” (or case-insensitive)</p>
<blockquote>
<div><p>New FILTER becomes a logical expression: (([FILTERITEM] = “string”) AND (new filter))</p>
</div></blockquote>
<p>Case 2: FILTERITEM and FILTER /string/ (or case-insensitive)</p>
<blockquote>
<div><p>New FILTER becomes a logical expression: (([FILTERITEM] ~ “string”) AND (new filter))</p>
</div></blockquote>
<p>Case 3: FILTER (string) with no FILTERITEM</p>
<blockquote>
<div><p>New FILTER becomes a logical expression: ((string) AND (new filter))</p>
</div></blockquote>
<p>In the case where the old filter is already native filter and the translation fails we will leave the old filter in place
so the driver can at least process that portion and then fall back to MapServer for the new filter.</p>
</section>
<section id="query-function-simplification">
<h2>2.4 Query Function Simplification<a class="headerlink" href="#query-function-simplification" title="Link to this heading">¶</a></h2>
<p>The msQueryByAttribute() function can be turned into an alias for the msQueryByFilter() function. They do basically the
same thing: define a new filter and execute a query using it. This simplifies the code base. A few functional changes will
need to be made within msQueryByFilter(), specifically handling the case when only 1 result is returned (mode=itemquery)
but that is a simple check at the bottom of the result processing loop.</p>
<p>This does not impact the CGi or MapScript APIs although we could choose to simplify those at a later date.</p>
</section>
<section id="future-enhancements">
<h2>2.5 Future Enhancements<a class="headerlink" href="#future-enhancements" title="Link to this heading">¶</a></h2>
<p>Work on this RFC indicates that the linked-list of tokens, while optimal for Bison/Yacc grammars, can be difficult to
translate in some cases. For example, if a driver needs to add an argument to a function call: buffer([shape], 500) needs
to translate to buffer(the_geom, 500, 1) if is difficult to know when to output the 1 in complex filter. It may be
beneficial rewrite the token handling to use tree storage instead of a list. That change doesn’t affect the larger
implementation approach, instead it offers an opportunity for more complete translations. Time will tell.</p>
</section>
<section id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h2>
</section>
<section id="summary-of-current-behaviour-by-driver">
<h2>3.1 Summary of Current Behaviour (by driver)<a class="headerlink" href="#summary-of-current-behaviour-by-driver" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>shapefile: supports FILTERITEM and FILTERs -&gt; string, regular, logical expression</p></li>
<li><p>OGR: supports FILTERTITEM and FILTERs -&gt; string, regular, logical expressions and native (starting with “WHERE “)</p></li>
<li><p>PostGIS: supports FILTER -&gt; native SQL snippet</p></li>
<li><p>Oracle Spatial: supports FILTERITEM and FILTERs -&gt; string and native (constructs native)</p></li>
<li><p>SDE: supports FILTER -&gt; native SQL snippet</p></li>
<li><p>MS SQL Server: supports FILTER -&gt; native SQL snippet</p></li>
</ul>
</section>
<section id="id1">
<h2>3.2 Overview<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>limited additions to logial expression syntax are recommended:</p>
<ul>
<li><p>spatial operator syntax (e.g. A INTERSECTS B) will be deprecated in favor of a functional notation (e.g. INTERSECTS(A, B) = TRUE). This is more consistent with spatialally enabled SQL syntax and easer to translate.</p></li>
<li><p>BEYOND/DWITHIN operators will <em>only</em> exist in the functional form, they are useless in logical expressions as they site now</p></li>
</ul>
</li>
<li><p>there are no changes to the MapScript API</p></li>
<li><p>drivers that support complex expressions (e.g. PostGIS, Oracle, SDE, MS SQL Server, OGR) need to implement a translation
function to construct a partial “WHERE” clause from a set of expression/filter tokens</p></li>
</ul>
</section>
<section id="files-affected">
<h2>3.2 Files affected<a class="headerlink" href="#files-affected" title="Link to this heading">¶</a></h2>
<p>The following files will be modified by this RFC:</p>
<ul class="simple">
<li><p>mapserver.h: extend expressionObj to contain a native_string (char *). This will hold a the native expression of the filter.</p></li>
<li><p>mapquery.c: call merging function in msQueryByAttribute() and msQueryByFilter(), call translation function in all query functions.</p></li>
<li><p>mapdraw.c: call filter translation function in msDrawVectorLayer()</p></li>
<li><p>maplayer.c: changes/additions to layer API function</p></li>
<li><p>mapshape.c, mappostgis.c, mapogr.c…. : changes/additions to driver functions</p></li>
<li><p>mapparser.y: add function-based versions of spatial operators, add BOOLEAN token type</p></li>
<li><p>maplexer.l: recognize TRUE/FALSE as boolean tokens (store in token-&gt;dblval) in expression context</p></li>
<li><p>mapogcfilter.c/mapogccommonfilter.c: update expression writing to use functional notation, fix dwithin/beyond processing</p></li>
</ul>
<p>Notes:</p>
<p>Drivers: This can be implemented incrementally within drivers. At a minimum all drivers <em>must</em> implement the
msXXXLayerTranslateFilter() and the function should at least detect the case where a native filter is already supplied
(for backwards compatibility). For relational databases this is the case where the filter is a plain old string expression.
For OGR this is where the plain old string expression starts with “WHERE “. In these cases the new native_string should
be populated with the filter string contents.</p>
<p>msLayerNextShape(): Evaluation of the common syntax (e.g. pure-MapServer) filter can happen here rather than within the driver
code. The OGR, Shapefile and Tiled Shapefile drivers all do this now and would need to be changed. The filter would only be
executed if the filter’s native_string is NULL (this is checked in msEvalExpression().</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>do {
  rv = layer-&gt;vtable-&gt;LayerNextShape(layer, shape);
  if(rv != MS_SUCCESS) return rv;

  filter_passed = MS_TRUE;  /* By default accept ANY shape */
  if(layer-&gt;numitems &gt; 0 &amp;&amp; layer-&gt;iteminfo) {
    filter_passed = msEvalExpression(layer, shape, &amp;(layer-&gt;filter), layer-&gt;filteritemindex);
  }

  if(!filter_passed) msFreeShape(shape);
} while(!filter_passed);
</pre></div>
</div>
<p>msLayerSupportsCommonFilters(): This function can be removed from the layer API in favor of checking the filter-&gt;native_string
after a call to msXXXLayerTranslateFilter().</p>
</section>
<section id="mapscript">
<h2>3.3 MapScript<a class="headerlink" href="#mapscript" title="Link to this heading">¶</a></h2>
<p>No changes necessary.</p>
</section>
<section id="backwards-compatibility-issues">
<h2>3.4 Backwards Compatibility Issues<a class="headerlink" href="#backwards-compatibility-issues" title="Link to this heading">¶</a></h2>
<p>By respecting a pre-defined FILTER with attribute and OGC filter queries it’s possible that users could get confused and/or
have to re-architect certain aspects of an application. For example, they may have actually already build filter merging into their
process.</p>
</section>
<section id="security-implications">
<h2>4. Security implications<a class="headerlink" href="#security-implications" title="Link to this heading">¶</a></h2>
<p>This RFC should make things more robust in this regard by forcing expressions through multiple levels of translation. The process
for WFS getFeature filters would be OGC Filter (XML) =&gt; MapServer common expression =&gt; native expression. All token conversion
for attribute bindings, string and date literals will be escaped using whatever mechanism the driver provides. For example, PostGIS
provides msPostGISEscapeSQLParam().</p>
</section>
<section id="performance-implications">
<h2>5. Performance implications<a class="headerlink" href="#performance-implications" title="Link to this heading">¶</a></h2>
<p>The token replacement is only done in msLayerOpen(), the performance impact should be negligeable as this happens
only once per rendered layer. Performance will improve greatly in some cases where operations are offloaded to the
database - less network traffic, more efficient algorithms.</p>
<p>With WFS-based dwithin/beyond operators we currently apply the distance values as buffers and then hand off to MapServer.
The suggested changes would remove that step and improve performane in <em>all</em> cases.</p>
</section>
<section id="bug-id">
<h2>6. Bug ID<a class="headerlink" href="#bug-id" title="Link to this heading">¶</a></h2>
<p>#4974: <a class="reference external" href="https://github.com/MapServer/MapServer/issues/4974">https://github.com/MapServer/MapServer/issues/4974</a></p>
</section>
<section id="voting-history">
<h2>7. Voting history<a class="headerlink" href="#voting-history" title="Link to this heading">¶</a></h2>
<p>Passed on 8/19/2014 with +1’s from Steve L, Thomas B, Mike S, Stephan M, Daniel M, Perry N, Stephen W, Jeff M, Tom K, Tamas S</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 91: Layer Filter Normalization</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-solution">2. Proposed solution</a></li>
<li><a class="reference internal" href="#driver-filter-translation">2.1 Driver Filter Translation</a></li>
<li><a class="reference internal" href="#filter-merging">2.2 Filter Merging</a></li>
<li><a class="reference internal" href="#filter-merging-examples">2.3 Filter Merging Examples</a></li>
<li><a class="reference internal" href="#query-function-simplification">2.4 Query Function Simplification</a></li>
<li><a class="reference internal" href="#future-enhancements">2.5 Future Enhancements</a></li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a></li>
<li><a class="reference internal" href="#summary-of-current-behaviour-by-driver">3.1 Summary of Current Behaviour (by driver)</a></li>
<li><a class="reference internal" href="#id1">3.2 Overview</a></li>
<li><a class="reference internal" href="#files-affected">3.2 Files affected</a></li>
<li><a class="reference internal" href="#mapscript">3.3 MapScript</a></li>
<li><a class="reference internal" href="#backwards-compatibility-issues">3.4 Backwards Compatibility Issues</a></li>
<li><a class="reference internal" href="#security-implications">4. Security implications</a></li>
<li><a class="reference internal" href="#performance-implications">5. Performance implications</a></li>
<li><a class="reference internal" href="#bug-id">6. Bug ID</a></li>
<li><a class="reference internal" href="#voting-history">7. Voting history</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-92.html" title="MS RFC 92: Migrating from Autotools to CMake"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-90.html" title="MS RFC 90: Enable/Disable Layers in OGC Web Services by IP Lists"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">MS RFC 91: Layer Filter Normalization</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>