<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Limit Mapfile Access &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="Mapfile Tuning &amp; Management" href="mapfile.html" />
    <link rel="prev" title="FastCGI" href="fastcgi.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../index.html" title="Home"><img src="../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../index.html" title="Home">Home</a> |
      <a href="../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../ar/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../de/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../el/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../es/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../fr/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../id/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../it/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../ja/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../nl_NL/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../pl/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../ru/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../sq/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../tr/optimization/limit_mapfile_access.html"><img src="../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="mapfile.html" title="Mapfile Tuning &amp; Management"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="fastcgi.html" title="FastCGI"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >MapServer 8.0.1 Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Optimization</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Limit Mapfile Access</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="limit-mapfile-access">
<span id="index-0"></span><span id="id1"></span><h1>Limit Mapfile Access<a class="headerlink" href="#limit-mapfile-access" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Stephen Lime</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>sdlime at gmail.com</p>
</dd>
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Jeff McKenna</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>jmckenna at gatewaygeomatics.com</p>
</dd>
<dt class="field-odd">Last Updated<span class="colon">:</span></dt>
<dd class="field-odd"><p>2022-08-16</p>
</dd>
</dl>
<p>The MapServer CGI, by default, will happily attempt to process any mapfile it is
asked to. While this might be desireable in a development environment, it is not
acceptable for public-facing installations. MapServer supports the use of specific
<strong>environment variables</strong>, set at the web server tier, to limit access. Since
the MapServer 7.6.3 release, you are <strong>required</strong> to use (a combination of)
these environment variables to secure your installation; for earlier MapServer
versions these environment variables are <strong>strongly recommended</strong>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The vulnerability <a class="reference external" href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-32062">CVE-2021-32062</a>
was fixed through the MapServer 7.6.3 release, through requiring the use of
the environment variables described in this MapServer document.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Environment variables are only referenced by the MapServer CGI and are not
used by MapScript in any way.</p>
</div>
<section id="key-environment-variables">
<h2>Key Environment Variables<a class="headerlink" href="#key-environment-variables" title="Link to this heading">¶</a></h2>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="environment_variables.html#environment-variables"><span class="std std-ref">Environment Variables</span></a></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="../development/rfc/ms-rfc-56.html#rfc56"><span class="std std-ref">MS RFC 56: Tighten control of access to mapfiles and templates</span></a></p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Associated <a class="reference external" href="https://github.com/MapServer/MapServer/pull/6314">Pull Request</a> for the 7.6.3 release</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The online tools <a class="reference external" href="https://regexr.com/">RegExr</a> &amp; <a class="reference external" href="https://regex101.com/">RegEx101</a>
are great for testing regular expressions.</p>
</div>
<p><strong>MS_MAP_BAD_PATTERN</strong></p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 7.6.3.</span></p>
</div>
<p>If set, this environment variable is interpreted as regular expression that is used
to test the value of the CGI map parameter, by specifying which problematic
character sequences to avoid. If the value matches then an error is
generated.  By default all MapServer installations (since 7.6.3) set a
hardcoded value for <em>MS_MAP_BAD_PATTERN</em> of:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[/\\]{2}|[/\\]?\\.+[/\\]|,
</pre></div>
</div>
<p>which will therefore not allow “/../” or “//” in the map value.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For Windows users, MS4W uses the PCRE regex library (which requires a
slightly different regex syntax), so all future MS4W releases will
contain the following default <em>MS_MAP_BAD_PATTERN</em> enabled
(to not allow “/../” or “//” in the map value) :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[\/\\\\]{2}|[\/\\\\]?\.{2,}[\/\\\\]|,
</pre></div>
</div>
<p>For more information see <a class="reference external" href="https://ms4w.com/README_INSTALL.html#securing-your-ms4w-installation">Securing your MS4W Installation</a></p>
</div>
<p><strong>MS_CONTEXT_BAD_PATTERN</strong></p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 8.0.1.</span></p>
</div>
<p>Regular Expression to catch &amp; not allow problematic character sequences
in any map context paths passed to the mapserv CGI in the context=… URL parameter.</p>
<p>See <a class="reference internal" href="environment_variables.html#ms-context-bad-pattern"><span class="std std-ref">MS_CONTEXT_BAD_PATTERN</span></a></p>
<p><strong>MS_CONTEXT_PATTERN</strong></p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 8.0.1.</span></p>
</div>
<p>Regular Expression that must be matched by all file paths passed to the mapserv
CGI in the context=… URL parameter.</p>
<p>See <a class="reference internal" href="environment_variables.html#ms-context-pattern"><span class="std std-ref">MS_CONTEXT_PATTERN</span></a></p>
<p><strong>MS_MAP_NO_PATH</strong></p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 5.4.0.</span></p>
</div>
<p>If set, this environment variable limits values for the CGI map parameter to a
curated (prepared) set of mapfiles explicitly defined by additional environment
variables. This is the recommended way to secure mapfile access if at all possible.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Mapfile-based environment variables (such as <em>MS_MAPFILE</em>) can be used without
setting MS_MAP_NO_PATH.</p>
</div>
<p><strong>MS_MAP_PATTERN</strong></p>
<div class="versionadded">
<p><span class="versionmodified added">New in version 5.4.0.</span></p>
</div>
<p>If set, this environment variable is interpreted as regular expression that is used
to test the value of the CGI map parameter. If the value does not match then
an error is generated.</p>
<p>Care must be taken to craft regular expressions that limit access to specific,
trusted directories and limit path traversal:. See the <a class="reference internal" href="environment_variables.html#environment-variables"><span class="std std-ref">Environment Variables</span></a>
guide for examples.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If defined, the MS_MAP_PATTERN variable only applies to mapfiles not
already defined through an environment variable.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>As of the MapServer 8.0 release, there are 2 scenarios where you won’t have to
specify <em>MS_MAP_PATTERN</em> :</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>If using a map alias (set in the <em>MAPS</em> section of the MapServer <a class="reference internal" href="../mapfile/config.html#config"><span class="std std-ref">CONFIG</span></a> file).</p></li>
<li><p>If MS_MAP_PATTERN is set in the underlying environment - that is, by
the Web server. MapServer will fall back to the environment variables
if they exist for any of the <a class="reference internal" href="environment_variables.html#environment-variables"><span class="std std-ref">MS* variables</span></a>.</p></li>
</ol>
</div></blockquote>
</div>
</section>
<section id="setting-environment-variables">
<h2>Setting Environment Variables<a class="headerlink" href="#setting-environment-variables" title="Link to this heading">¶</a></h2>
<p>Mechanisms to set environment variables vary from web server to web server, but all
provide the capability. (regular expression feature sets can vary by operating system
and version)</p>
<ul>
<li><p><strong>Apache</strong> - <a class="reference external" href="https://httpd.apache.org/docs/current/env.html">https://httpd.apache.org/docs/current/env.html</a></p>
<p>Apache’s <a class="reference external" href="https://httpd.apache.org/docs/current/mod/mod_env.html#setenv">SetEnv</a>
directive (available through the <em>mod_env</em> module) allows you to set
environment variables in the Apache conf file with a single command:</p>
<ul>
<li><p><em>Unix users</em> may set the following expression in Apache to restrict
mapfiles to the <em>/opt/mapserver</em> directory and subdirectories:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SetEnv</span> <span class="n">MS_MAP_PATTERN</span> <span class="s2">&quot;^\/opt\/mapserver\/([^\.][_A-Za-z0-9\-\.]+\/</span><span class="si">{1}</span><span class="s2">)*([_A-Za-z0-9\-\.]+\.(map))$&quot;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>During testing during this documentation process, the above MS_MAP_PATTERN failed
on an old Debian Wheezy server, on a valid path such as <em>MAP=/opt/mapserver/ogc-demos/wms.map</em>
(the dash in the ‘ogr-demos’ folder caused much grief) even though the dash
was escaped in the provided character set of the expression.</p>
<p>Therefore those running older regex libs should use the following instead, which
puts the dash at the beginning of the character set of the expression, avoiding the
escaping issue:</p>
<p>SetEnv MS_MAP_PATTERN “^/osgeo/mapserver/([^.][-_A-Za-z0-9.]+/{1})*([-_A-Za-z0-9.]+.(map))$”</p>
</div>
</li>
<li><p><em>Windows Apache/MS4W users</em> can set the following expression in the Apache
conf file, to limit the possible MAP= paths to the common
<em>C:/ms4w/apps/</em> directory (where all MS4W mapfiles and applications live),
allow encoded urls, allow “.” or “_” or “-” in MAP= paths but disallow “..”
directory traversing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SetEnv</span> <span class="n">MS_MAP_PATTERN</span> <span class="s2">&quot;^(C:)?\/ms4w\/apps\/((?!\.</span><span class="si">{2}</span><span class="s2">)[_A-Za-z0-9\-\.]+\/</span><span class="si">{1}</span><span class="s2">)*([_A-Za-z0-9\-\.]+\.(map))$&quot;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Nginx</strong> - <a class="reference external" href="http://nginx.org/en/docs/ngx_core_module.html#env">http://nginx.org/en/docs/ngx_core_module.html#env</a></p></li>
<li><p><strong>IIS</strong> - <a class="reference external" href="https://docs.microsoft.com/en-us/iis/configuration/system.applicationhost/applicationpools/add/environmentvariables/">https://docs.microsoft.com/en-us/iis/configuration/system.applicationhost/applicationpools/add/environmentvariables/</a></p></li>
</ul>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../about.html" title="About">About</a><br>
<a href="../products.html" title="Products">Products</a><br>
<a href="../community/index.html" title="Community">Community</a><br>
<a href="../development/index.html" title="Development">Development</a><br>
<a href="../download.html" title="Downloads">Downloads</a><br>
<a href="../documentation.html" title="Documentation">Documentation</a><br>
<a href="../faq.html" title="FAQ">FAQ</a><br>
<a href="../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">Limit Mapfile Access</a><ul>
<li><a class="reference internal" href="#key-environment-variables">Key Environment Variables</a></li>
<li><a class="reference internal" href="#setting-environment-variables">Setting Environment Variables</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="mapfile.html" title="Mapfile Tuning &amp; Management"
             >next</a> |</li>
        <li class="right" >
          <a href="fastcgi.html" title="FastCGI"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >MapServer 8.0.1 Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Optimization</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Limit Mapfile Access</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>