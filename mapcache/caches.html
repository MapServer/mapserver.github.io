<!DOCTYPE html>

<html lang="en" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Cache Types &#8212; MapServer 8.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx.css?v=6c7b17ac" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=dd298242" />
    <link rel="stylesheet" type="text/css" href="../_static/ribbon.css?v=ea091bf4" />
    
    <script src="../_static/documentation_options.js?v=521b6f53"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="icon" href="../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="Image Formats" href="formats.html" />
    <link rel="prev" title="Seeder" href="seed.html" /> 
  </head><body>


<!-- for main branch only, do not backport this -->

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../index.html" title="Home"><img src="../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../index.html" title="Home">Home</a> |
      <a href="../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter" target="_blank">Twitter</a> |
      <a href="../download.html" title="Download Source or Binaries">Download </a> |
      <a class="badge" href="https://www.paypal.com/cgi-bin/webscr?cmd=_s-xclick&hosted_button_id=KRJ2X44N3HA6U&source=url" target="_blank">
        <img src="https://img.shields.io/badge/donate-%E2%9D%A4%C2%A0-ff69b4.svg?style=flat" alt="Donate to MapServer">
      </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        <img src="../_static/flagicons/en.png" alt="en" title="en" border="0" width="18px" height="13px"/>
        
          <a href="../ar/mapcache/caches.html"><img src="../_static/flagicons/ar.png" alt="ar" title="ar" border="0" /></a>
        
        
          <a href="../de/mapcache/caches.html"><img src="../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
        
        
          <a href="../el/mapcache/caches.html"><img src="../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
        
        
          <a href="../es/mapcache/caches.html"><img src="../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
        
        
          <a href="../fr/mapcache/caches.html"><img src="../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
        
        
          <a href="../id/mapcache/caches.html"><img src="../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
        
        
          <a href="../it/mapcache/caches.html"><img src="../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
        
        
          <a href="../ja/mapcache/caches.html"><img src="../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
        
        
          <a href="../nl_NL/mapcache/caches.html"><img src="../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
        
        
          <a href="../pl/mapcache/caches.html"><img src="../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
        
        
          <a href="../ru/mapcache/caches.html"><img src="../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
        
        
          <a href="../sq/mapcache/caches.html"><img src="../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
        
        
          <a href="../tr/mapcache/caches.html"><img src="../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="formats.html" title="Image Formats"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="seed.html" title="Seeder"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >MapServer 8.0.1 Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">MapCache 1.14.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Cache Types</a></li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="cache-types">
<span id="mapcache-caches"></span><h1><a class="toc-backref" href="#table-of-contents" role="doc-backlink">Cache Types</a><a class="headerlink" href="#cache-types" title="Link to this heading">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author<span class="colon">:</span></dt>
<dd class="field-odd"><p>Thomas Bonfort</p>
</dd>
<dt class="field-even">Contact<span class="colon">:</span></dt>
<dd class="field-even"><p>tbonfort at terriscope.fr</p>
</dd>
</dl>
<nav class="contents" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#cache-types" id="id1">Cache Types</a></p>
<ul>
<li><p><a class="reference internal" href="#disk-caches" id="id2">Disk Caches</a></p></li>
<li><p><a class="reference internal" href="#berkeley-db-caches" id="id3">Berkeley DB Caches</a></p></li>
<li><p><a class="reference internal" href="#lightning-memory-mapped-database-caches" id="id4">Lightning Memory-Mapped Database Caches</a></p></li>
<li><p><a class="reference internal" href="#sqlite-caches" id="id5">SQLite Caches</a></p></li>
<li><p><a class="reference internal" href="#mbtiles-caches" id="id6">MBTiles Caches</a></p></li>
<li><p><a class="reference internal" href="#memcache-caches" id="id7">Memcache Caches</a></p></li>
<li><p><a class="reference internal" href="#geo-tiff-caches" id="id8">(Geo)TIFF Caches</a></p></li>
<li><p><a class="reference internal" href="#rest-caches" id="id9">REST Caches</a></p></li>
<li><p><a class="reference internal" href="#meta-caches" id="id10">Meta Caches</a></p></li>
<li><p><a class="reference internal" href="#riak-caches" id="id11">Riak Caches</a></p></li>
</ul>
</li>
</ul>
</nav>
<p>This document details the different cache backends that can be used to store tiles.</p>
<section id="disk-caches">
<span id="mapcache-cache-disk"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">Disk Caches</a><a class="headerlink" href="#disk-caches" title="Link to this heading">¶</a></h2>
<p>The disk based cache is the simplest cache to configure, and the one with the
the fastest access to existing tiles. It is ideal for small tile repositories,
but will often cause trouble for sites hosting millions of tiles, as the number of
files or directories may rapidly overcome the capabilities of the underlying
filesystem. Additionally, the block size chosen for the filesystem must closely
match the mean size of a stored tile: ideally, any given tile should just fit
inside a filesystem block, so as not to waste storage space inside each block,
and not have to use up multiple blocks per tile.</p>
<p>The location of the files/directories has to be readable and writable by the
user running the tile server.</p>
<section id="common-configuration">
<h3>Common Configuration<a class="headerlink" href="#common-configuration" title="Link to this heading">¶</a></h3>
<p>Disk caches are added via</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;disk_cache&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;disk&quot;</span><span class="w"> </span><span class="na">layout=</span><span class="s">&quot;...&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span>...
<span class="w">  </span><span class="nt">&lt;symlink_blank/&gt;</span>
<span class="w">  </span><span class="nt">&lt;creation_retry&gt;</span>3<span class="nt">&lt;/creation_retry&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>All caches except the “template” one support the &lt;symlink_blank/&gt; option which
(depending on platform availability) will detect tiles of uniform color and
create a symbolic link to a single uniform color tile instead of storing the
actual blank data in the tile’s file.</p>
<p>All caches support the &lt;creation_retry&gt; option, which specifies the number of
times MapCache should retry if it failed to create a tile’s file or symlink. The
default is to fail immediately: You may want to set this to a positive value
if using a network mounted filesystem where transient errors are common.</p>
</section>
<section id="default-structure">
<h3>Default Structure<a class="headerlink" href="#default-structure" title="Link to this heading">¶</a></h3>
<p>The default disk cache stores tiles in a structure nearly identical to the
file/directory hierarchy used by TileCache. The only change is that a top level
directory structure corresponding to the name of the grid and the eventual value
of the tileset’s dimensions is added.</p>
<p>This cache is capable of detecting blank (i.e. uniform color) tiles and using
a symbolic link to a single blank tile to gain disk space.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;disk&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;disk&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;base&gt;</span>/tmp<span class="nt">&lt;/base&gt;</span>
<span class="w">   </span><span class="nt">&lt;symlink_blank/&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>The only two configuration keys are the root directory where the tiles will be
stored, and a key to activate the symbolic linking of blank tiles.</p>
</section>
<section id="arcgis-compatible-structure">
<h3>Arcgis Compatible Structure<a class="headerlink" href="#arcgis-compatible-structure" title="Link to this heading">¶</a></h3>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;arcgis&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;disk&quot;</span><span class="w"> </span><span class="na">layout=</span><span class="s">&quot;arcgis&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;base&gt;</span>/tmp<span class="nt">&lt;/base&gt;</span>
<span class="w">   </span><span class="nt">&lt;symlink_blank/&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>This layout creates a tile structure compatible with an arcgis exploded cache. Tiles
will be stored in files that resemble <cite>/tmp/{tileset}/{grid}/{dimension}/L{z}/R{y}/C{x}.{ext}</cite></p>
</section>
<section id="worldwind-compatible-structure">
<h3>Worldwind Compatible Structure<a class="headerlink" href="#worldwind-compatible-structure" title="Link to this heading">¶</a></h3>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;worldwind&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;disk&quot;</span><span class="w"> </span><span class="na">layout=</span><span class="s">&quot;worldwind&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;base&gt;</span>/tmp<span class="nt">&lt;/base&gt;</span>
<span class="w">   </span><span class="nt">&lt;symlink_blank/&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>This layout creates a tile structure compatible with a worldwind cache. Tiles
will be stored in files that resemble <cite>/tmp/{tileset}/{grid}/{dimension}/{z}/{y}/{y}_{x}.ext</cite></p>
</section>
<section id="template-structure">
<h3>Template Structure<a class="headerlink" href="#template-structure" title="Link to this heading">¶</a></h3>
<p>The template based disk cache allows you to create (or reuse an existing) tile
structure that you define in advance. The &lt;template&gt; parameter takes a string
argument where various template entries will be replaced at runtime by the correct
value for each tile to store.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tmpl&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;disk&quot;</span><span class="w"> </span><span class="na">layout=</span><span class="s">&quot;template&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="cm">&lt;!-- template</span>

<span class="cm">       string template that will be used to map a tile (by tileset, grid name, dimension,</span>
<span class="cm">       format, x, y, and z) to a filename on the filesystem</span>
<span class="cm">       the following replacements are performed:</span>
<span class="cm">       - {tileset} : the tileset name</span>
<span class="cm">       - {grid} : the grid name</span>
<span class="cm">       - {dim} : a string that concatenates the tile&#39;s dimension</span>
<span class="cm">       - {dim:dimname}: use the dimension value for dimname e.g. {dim:year} for year=2021 would</span>
<span class="cm">            use the string 2021</span>
<span class="cm">       - {ext} : the filename extension for the tile&#39;s image format</span>
<span class="cm">       - {x},{y},{z} : the tile x,y,z values</span>
<span class="cm">       - {inv_x}, {inv_y}, {inv_z} : inverted x,y,z values (inv_x = level-&gt;maxx - x - 1). This</span>
<span class="cm">            is mainly used to support grids where one axis is inverted (e.g. the google schema)</span>
<span class="cm">            and you want to create on offline cache.</span>

<span class="cm">      * Note that this type of cache does not support blank-tile detection and symlinking.</span>

<span class="cm">      * Warning: It is up to you to make sure that the template you chose creates a unique</span>
<span class="cm">        filename for your given tilesets. e.g. do not omit the {grid} parameter if your</span>
<span class="cm">        tilesets reference multiple grids. Failure to do so will result in filename</span>
<span class="cm">        collisions !</span>

<span class="cm">   --&gt;</span>
<span class="w">   </span><span class="nt">&lt;template&gt;</span>/tmp/template-test/{tileset}#{grid}#{dim}/{z}/{x}/{y}.{ext}<span class="nt">&lt;/template&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="berkeley-db-caches">
<span id="mapcache-cache-bdb"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">Berkeley DB Caches</a><a class="headerlink" href="#berkeley-db-caches" title="Link to this heading">¶</a></h2>
<p>The Berkeley DB cache backend stores tiles in a key-value flat-file database,
and therefore does not have the disadvantages of disk caches with regards to
the number of files stored on the filesystem. As the image blobs are stored
contiguously, the block size chosen for the filesystem has no influence on the
storage capacity of the volume.</p>
<p>Note that for a given bdb cache, only a single database file is created, which
will store the tiles of its associated tilesets (i.e. there is not a database
file created per tileset, grid, and/or dimension). If you need to store different
tilesets to different files, then use multiple dbd cache entries. It is not
possible to use multiple database files for tileset grids or dimensions.</p>
<p>The Berkeley DB based caches are a bit faster than the disk based caches during
reads, but may be a bit slower during concurrent writes if a high number of
threads all try to insert new tiles concurrently.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;bdb&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;bdb&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="cm">&lt;!-- base (required)</span>
<span class="cm">      absolute filesystem path where the Berkeley DB database file is to be stored.</span>
<span class="cm">      this directory must exist, and be writable</span>
<span class="cm">   --&gt;</span>
<span class="w">   </span><span class="nt">&lt;base&gt;</span>/tmp/foo/<span class="nt">&lt;/base&gt;</span>

<span class="w">   </span><span class="cm">&lt;!-- key_template (optional)</span>
<span class="cm">      string template used to create the key for a tile entry in the database.</span>
<span class="cm">      defaults to the value below. you should include {tileset}, {grid} and {dim} here</span>
<span class="cm">      unless you know what you are doing, or you will end up with mixed tiles</span>
<span class="cm">   &lt;key_template&gt;{tileset}-{grid}-{dim}-{z}-{y}-{x}.{ext}&lt;/key_template&gt;</span>
<span class="cm">   --&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="lightning-memory-mapped-database-caches">
<span id="mapcache-cache-lmdb"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">Lightning Memory-Mapped Database Caches</a><a class="headerlink" href="#lightning-memory-mapped-database-caches" title="Link to this heading">¶</a></h2>
<div class="versionadded">
<p><span class="versionmodified added">New in version 1.14.0.</span></p>
</div>
<p>The Lightning Memory-Mapped Database (LMDB) cache backend is similar to the Berkeley
DB backend. It stores tiles in a key-value flat-file database, and therefore
does not have the disadvantages of disk caches with regards to the number of
files stored on the filesystem.</p>
<p>Note that for a given LMDB cache, only a single database file is created, which
will store the tiles of its associated tilesets (i.e. there is not a database
file created per tileset, grid, and/or dimension). If you need to store different
tilesets to different files, then use multiple LMDB cache entries. It is not
possible to use multiple database files for tileset grids or dimensions.</p>
<p>LMDB is a memory-mapped database thus it will show up as a memory used by
the process. Note that LMDB might not work with remote file systems as they
must support flock(), memory map sync etc. and should not be accessed from
multiple hosts.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;lmdb&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;lmdb&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="cm">&lt;!-- base (required)</span>
<span class="cm">      absolute filesystem path where the LMDB database file is to be stored.</span>
<span class="cm">      this directory must exist, and be writable</span>
<span class="cm">   --&gt;</span>
<span class="w">   </span><span class="nt">&lt;base&gt;</span>/tmp/foo/<span class="nt">&lt;/base&gt;</span>

<span class="w">   </span><span class="cm">&lt;!-- key_template (optional)</span>
<span class="cm">      string template used to create the key for a tile entry in the database.</span>
<span class="cm">      defaults to the value below. you should include {tileset}, {grid} and {dim} here</span>
<span class="cm">      unless you know what you are doing, or you will end up with mixed tiles</span>
<span class="cm">   &lt;key_template&gt;{tileset}-{grid}-{dim}-{z}-{y}-{x}.{ext}&lt;/key_template&gt;</span>
<span class="cm">   --&gt;</span>
<span class="w">   </span><span class="cm">&lt;!-- max_size (optional)</span>
<span class="cm">      maximum size of database in thousands of _SC_PAGESIZE.</span>
<span class="cm">      defaults to 64 that equals 250MiB on most of systems with 4k pagesize.</span>
<span class="cm">      database can only be grown larger (requires a restart).</span>
<span class="cm">      when db size will reach the max_size setting, any write attempt will</span>
<span class="cm">      result in an error message.</span>
<span class="cm">   &lt;max_size&gt;64&lt;/max_size&gt;</span>
<span class="cm">   --&gt;</span>
<span class="w">   </span><span class="cm">&lt;!-- max_readers (optional)</span>
<span class="cm">      maximum simultaneous reader count. should be higher than web server</span>
<span class="cm">      process / thread count.</span>
<span class="cm">      defaults to 126.</span>
<span class="cm">   &lt;max_readers&gt;126&lt;/max_readers&gt;</span>
<span class="cm">   --&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="sqlite-caches">
<span id="mapcache-cache-sqlite"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">SQLite Caches</a><a class="headerlink" href="#sqlite-caches" title="Link to this heading">¶</a></h2>
<p>There are two different SQLite caches that vary by the database schema they
create and query. SQLite caches have the advantage that they store tiles as
blobs inside a single database file, and therefore do not have the
disadvantages of disk caches with regards to the number of files stored. As the
image blobs are stored contiguously, the block size chosen for the filesystem
has no influence on the storage capacity of the volume.</p>
<p>The SQLite based caches are a bit slower than the disk based caches, and may
have write-locking issues at seed time if a high number of threads all try to
insert new tiles concurrently.</p>
<section id="default-schema">
<h3>Default Schema<a class="headerlink" href="#default-schema" title="Link to this heading">¶</a></h3>
<p>Tiles are stored in the configured SQLite file created by MapCache with</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">tiles</span><span class="p">(</span>
<span class="w">   </span><span class="n">tileset</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">   </span><span class="n">grid</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">   </span><span class="n">x</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">   </span><span class="n">y</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">   </span><span class="n">z</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">   </span><span class="k">data</span><span class="w"> </span><span class="nb">blob</span><span class="p">,</span>
<span class="w">   </span><span class="n">dim</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">   </span><span class="n">ctime</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span>
<span class="w">   </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">tileset</span><span class="p">,</span><span class="n">grid</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
<span class="p">);</span>
</pre></div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlite&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile&gt;</span>/path/to/dbfile.sqlite3<span class="nt">&lt;/dbfile&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>You may also add custom SQLite pragmas that will be executed when first
connecting to a SQLite db, e.g. to override some compiled-in SQLite
defaults</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlite&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile&gt;</span>/tmp/sqlitefile.db<span class="nt">&lt;/dbfile&gt;</span>
<span class="w">   </span><span class="nt">&lt;pragma</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;max_page_count&quot;</span><span class="nt">&gt;</span>10000000<span class="nt">&lt;/pragma&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>&lt;pragma&gt; entries will result in a call to</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">max_page_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="custom-schema">
<h3>Custom Schema<a class="headerlink" href="#custom-schema" title="Link to this heading">¶</a></h3>
<p>This cache can use any database schema: It is up to you to supply the SQL that
will be executed to select or insert a new tile.</p>
<p>In order to use such functionality you should supply the SQL queries that will
be used against your custom schema. It is up to you to make sure your queries are
correct and will return the correct data for a given tileset, dimension, grid, x,
y and z.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlitecustom&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile&gt;</span>/tmp/sqlitefile.db<span class="nt">&lt;/dbfile&gt;</span>
<span class="w">   </span><span class="nt">&lt;queries&gt;</span>
<span class="w">     </span><span class="nt">&lt;create&gt;</span>create<span class="w"> </span>table<span class="w"> </span>if<span class="w"> </span>not<span class="w"> </span>exists<span class="w"> </span>tiles(tileset<span class="w"> </span>text,<span class="w"> </span>grid<span class="w"> </span>text,<span class="w"> </span>x<span class="w"> </span>integer,<span class="w"> </span>y<span class="w"> </span>integer,<span class="w"> </span>z<span class="w"> </span>integer,<span class="w"> </span>data<span class="w"> </span>blob,<span class="w"> </span>dim<span class="w"> </span>text,<span class="w"> </span>ctime<span class="w"> </span>datetime,<span class="w"> </span>primary<span class="w"> </span>key(tileset,grid,x,y,z,dim))<span class="nt">&lt;/create&gt;</span>
<span class="w">     </span><span class="nt">&lt;exists&gt;</span>select<span class="w"> </span>1<span class="w"> </span>from<span class="w"> </span>tiles<span class="w"> </span>where<span class="w"> </span>x=:x<span class="w"> </span>and<span class="w"> </span>y=:y<span class="w"> </span>and<span class="w"> </span>z=:z<span class="w"> </span>and<span class="w"> </span>dim=:dim<span class="w"> </span>and<span class="w"> </span>tileset=:tileset<span class="w"> </span>and<span class="w"> </span>grid=:grid<span class="nt">&lt;/exists&gt;</span>
<span class="w">     </span><span class="nt">&lt;get&gt;</span>select<span class="w"> </span>data,strftime(&quot;%s&quot;,ctime)<span class="w"> </span>from<span class="w"> </span>tiles<span class="w"> </span>where<span class="w"> </span>tileset=:tileset<span class="w"> </span>and<span class="w"> </span>grid=:grid<span class="w"> </span>and<span class="w"> </span>x=:x<span class="w"> </span>and<span class="w"> </span>y=:y<span class="w"> </span>and<span class="w"> </span>z=:z<span class="w"> </span>and<span class="w"> </span>dim=:dim<span class="nt">&lt;/get&gt;</span>
<span class="w">     </span><span class="nt">&lt;set&gt;</span>insert<span class="w"> </span>or<span class="w"> </span>replace<span class="w"> </span>into<span class="w"> </span>tiles(tileset,grid,x,y,z,data,dim,ctime)<span class="w"> </span>values<span class="w"> </span>(:tileset,:grid,:x,:y,:z,:data,:dim,datetime(&#39;now&#39;))<span class="nt">&lt;/set&gt;</span>
<span class="w">     </span><span class="nt">&lt;delete&gt;</span>delete<span class="w"> </span>from<span class="w"> </span>tiles<span class="w"> </span>where<span class="w"> </span>x=:x<span class="w"> </span>and<span class="w"> </span>y=:y<span class="w"> </span>and<span class="w"> </span>z=:z<span class="w"> </span>and<span class="w"> </span>dim=:dim<span class="w"> </span>and<span class="w"> </span>tileset=:tileset<span class="w"> </span>and<span class="w"> </span>grid=:grid<span class="nt">&lt;/delete&gt;</span>
<span class="w">   </span><span class="nt">&lt;/queries&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>Note that for the &lt;get&gt; query that returns data for a given tile, the first returned argument
is considered to be the image blob, and the second optional one a timestamp representing the
creation timestamp for that tile.</p>
</section>
<section id="blank-tile-detection">
<h3>Blank Tile Detection<a class="headerlink" href="#blank-tile-detection" title="Link to this heading">¶</a></h3>
<p>MapCache’s SQLite caches support the detection and storage of blank (i.e. uniform
color) tiles, and will store a quadruplet of the rgba color component in the data
blob instead of the compressed image data itself. That quadruplet will be
transformed on-the-fly to a 1-bit palleted PNG before being returned to the client.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqliteblank&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile&gt;</span>/tmp/sqlitefile.db<span class="nt">&lt;/dbfile&gt;</span>
<span class="w">   </span><span class="nt">&lt;detect_blank/&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SQLite files created with this option will only be fully understood by
MapCache as each tile blob may contain a #rgba quadruplet instead of
the expected PNG or JPEG data.</p>
</div>
</section>
<section id="using-multiple-sqlite-database-files">
<span id="mapcache-cache-multisqlite"></span><h3>Using Multiple SQLite Database Files<a class="headerlink" href="#using-multiple-sqlite-database-files" title="Link to this heading">¶</a></h3>
<p>You may want to split an SQLite cache into multiple files, for organisational
purposes, or to keep the size of each file to a reasonable limit if caching
large amounts of data.</p>
<p>In order to do so you may use a template to determine which file should be
used for a given file:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlite&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile&gt;</span>/path/to/{grid}/{dim}/{tileset}.sqlite3<span class="nt">&lt;/dbfile&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>You may also limit the x and y number of tiles to be stored inside a single database
file:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;sqlite&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile&gt;</span>/path/to/{grid}/{dim}/{tileset}/{z}/{x}-{y}.sqlite3<span class="nt">&lt;/dbfile&gt;</span>
<span class="w">   </span><span class="nt">&lt;xcount&gt;</span>1000<span class="nt">&lt;/xcount&gt;</span>
<span class="w">   </span><span class="nt">&lt;ycount&gt;</span>1000<span class="nt">&lt;/ycount&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>In this case you <strong>should</strong> include the {x}, {y} and {z} replacements in the
template determining the file to use.
In the previous example, tile (z,x,y)=(15,3024,1534) would be stored in a file
named /path/to/g/mytileset/15/3000-1000.sqlite3 and tile (5,2,8) would be stored
in a file named /path/to/g/mytileset/5/0-0.sqlite3</p>
<p>The following template keys are available for operating on the given tile’s
x,y, and z:</p>
<ul class="simple">
<li><p><cite>{z}</cite> is replaced by the zoom level.</p></li>
<li><p><cite>{x}</cite> is replaced by the x value of the leftmost tile inside the SQLite file
containing the requested tile.</p></li>
<li><p><cite>{inv_x}</cite> is replaced by the x value of the rightmost tile.</p></li>
<li><p><cite>{y}</cite> is replaced by the y value of the bottommost tile.</p></li>
<li><p><cite>{inv_y}</cite> is replaced by the y value of the topmost tile.</p></li>
<li><p><cite>{div_x}</cite> is replaced by the index of the SQLite file starting from the left
of the grid (i.e. <cite>{div_x} = {x}/&lt;xcount&gt;</cite>).</p></li>
<li><p><cite>{inv_div_x}</cite> same as {div_x} but starting from the right.</p></li>
<li><p><cite>{div_y}</cite> is replaced by the index of the SQLite file starting from the bottom
of the grid (i.e. <cite>{div_y} = {y}/&lt;ycount&gt;</cite>).</p></li>
<li><p><cite>{inv_div_y}</cite> same as <cite>{div_y}</cite> but starting from the top.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>{inv_x} and {inv_div_x} will probably be rarely used, whereas
{inv_y} and {inv_div_y} will find some usage by people who prefer to index
their dbfiles files from top to bottom rather than bottom to top.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Dimension values, replacing {dim} template, can’t hold multiple directory
names (i.e. can’t contain ‘/’ separator). This constraint can be bypassed
under specific conditions that are further detailed in <a class="reference internal" href="../development/rfc/ms-rfc-131.html"><span class="doc">MS RFC 131: Allow file paths in MapCache second level dimension values</span></a>.</p>
</div>
<p>In some cases, it may be desirable to have a precise hand on the
filename to use for a given x,y,z tile lookup, e.g. to look for a file
named <cite>Z03-R00003-C000009.sqlite3</cite> instead of just <cite>Z3-R3-C9.sqlite3</cite>. The
&lt;dbfile&gt; entry supports formatting attributes, following the Unix
printf syntax ( c.f.: <a class="reference external" href="http://linux.die.net/man/3/printf">http://linux.die.net/man/3/printf</a> ), by suffixing
each template key with “_fmt”, e.g.:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mysqlite&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile</span>
<span class="w">      </span><span class="na">x_fmt=</span><span class="s">&quot;%08d&quot;</span>
<span class="w">      </span><span class="na">inv_y_fmt=</span><span class="s">&quot;%08d&quot;</span>
<span class="w">   </span><span class="nt">&gt;</span>/data/{tileset}/{grid}/L{z}/R{inv_y}/C{x}.sqlite<span class="nt">&lt;/template&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If not specified, the default behavior is to use “%d” for formatting.</p>
</div>
</section>
<section id="using-multiple-pyramids-in-multiple-sqlite-database-files-z-top">
<h3>Using Multiple pyramids in multiple SQLite database files (Z-top)<a class="headerlink" href="#using-multiple-pyramids-in-multiple-sqlite-database-files-z-top" title="Link to this heading">¶</a></h3>
<p>Another way of structuring SQLite caches consists in organizing them in
multiple pyramids: one single pyramid on lowest zoom levels, then as many
pyramids as tiles at a given zoom level, e.g. 8, referred to as <em>top zoom
level</em>. Each of these pyramids starts with one tile at that top zoom level,
then four tiles at next zoom level and so on. Of course the top zoom level
value is configurable.</p>
<p>The main advantage of this structure is when a user wants to work offline with
only a subset of the World: Only two (relatively small) SQLite files have to be
copied.</p>
<p>Following is a figure illustrating this cache structure.</p>
<img alt="../_images/mapcache-ztop.png" class="no-scaled-link align-center" src="../_images/mapcache-ztop.png" style="width: 523.0px; height: 559.0px;" />
<p>From a configuration point of view, a multi-SQLite cache of class <em>ztop</em> is
specified with a <cite>&lt;top&gt;</cite> tag defining the top zoom level. Templates keys are
needed to determine SQLite files to use.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- multi-pyramid, multi-SQLite, starting at zoom level 8 --&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;z8&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="hll"><span class="w">  </span><span class="nt">&lt;top&gt;</span>8<span class="nt">&lt;/top&gt;</span>
</span><span class="hll"><span class="w">  </span><span class="nt">&lt;dbfile</span><span class="w"> </span><span class="na">top_fmt=</span><span class="s">&quot;%02d&quot;</span><span class="nt">&gt;</span>/path/to/z{top}-{top_x}-{top_y}.sqlite3<span class="nt">&lt;/dbfile&gt;</span>
</span><span class="nt">&lt;/cache&gt;</span>

<span class="cm">&lt;!-- single cache from zoom levels 0 to 7 --&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;z1-7&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite3&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;dbfile&gt;</span>/path/to/z0-0-0.sqlite3<span class="nt">&lt;/dbfile&gt;</span>
<span class="nt">&lt;/cache&gt;</span>

<span class="cm">&lt;!-- Composite cache made of all caches to address all zoom levels --&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;zfull&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;composite&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">min-zoom=</span><span class="s">&quot;0&quot;</span><span class="w"> </span><span class="na">max-zoom=</span><span class="s">&quot;7&quot;</span><span class="nt">&gt;</span>z1-7<span class="nt">&lt;/cache&gt;</span>
<span class="w">  </span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">min-zoom=</span><span class="s">&quot;8&quot;</span><span class="nt">&gt;</span>z8<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>The following template keys are available:</p>
<ul class="simple">
<li><p><cite>{top}</cite> is replaced by the top zoom level.</p></li>
<li><p><cite>{top_x}</cite> is replaced by the x value of the tile index at top zoom level,
starting from left</p></li>
<li><p><cite>{top_y}</cite> is replaced by the y value of the tile index at top zoom level,
starting from bottom</p></li>
<li><p><cite>{inv_top_x}</cite> is replaced by the x value of the tile index at top zoom level,
starting from right</p></li>
<li><p><cite>{inv_top_y}</cite> is replaced by the y value of the tile index at top zoom level,
starting from top</p></li>
</ul>
<p>The following formatting attributes are available: <cite>top_fmt</cite>, <cite>top_x_fmt</cite>,
<cite>top_y_fmt</cite>, <cite>inv_top_x_fmt</cite>, <cite>inv_top_y_fmt</cite>. They default to <cite>“%d”</cite>.</p>
</section>
</section>
<section id="mbtiles-caches">
<span id="mapcache-cache-mbtiles"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">MBTiles Caches</a><a class="headerlink" href="#mbtiles-caches" title="Link to this heading">¶</a></h2>
<p>This cache type is a shortcut to the previous custom schema SQLite cache, with
pre-populated SQL queries that correspond to the MBTiles specification.</p>
<p>Although the default MBTiles schema is very simple, MapCache uses the same multi-
table schema found in most downloadable MBTiles files, notably to enable storing
blank (i.e. uniform) tiles without duplicating the encoded image data (in the
same way the disk cache supports tile symlinking).</p>
<p>The MBTiles schema is created with:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">images</span><span class="p">(</span>
<span class="w">  </span><span class="n">tile_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">tile_data</span><span class="w"> </span><span class="nb">blob</span><span class="p">,</span>
<span class="w">  </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">tile_id</span><span class="p">));</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="k">map</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">zoom_level</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">tile_column</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">tile_row</span><span class="w"> </span><span class="nb">integer</span><span class="p">,</span>
<span class="w">  </span><span class="n">tile_id</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="k">foreign</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">tile_id</span><span class="p">)</span><span class="w"> </span><span class="k">references</span><span class="w"> </span><span class="n">images</span><span class="p">(</span><span class="n">tile_id</span><span class="p">),</span>
<span class="w">  </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">(</span><span class="n">tile_row</span><span class="p">,</span><span class="n">tile_column</span><span class="p">,</span><span class="n">zoom_level</span><span class="p">));</span>
<span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">metadata</span><span class="p">(</span>
<span class="w">  </span><span class="n">name</span><span class="w"> </span><span class="nb">text</span><span class="p">,</span>
<span class="w">  </span><span class="n">value</span><span class="w"> </span><span class="nb">text</span><span class="p">);</span><span class="w"> </span><span class="c1">-- not used or populated yet</span>
<span class="k">create</span><span class="w"> </span><span class="k">view</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="n">tiles</span>
<span class="w">  </span><span class="k">as</span><span class="w"> </span><span class="k">select</span>
<span class="w">     </span><span class="k">map</span><span class="p">.</span><span class="n">zoom_level</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">zoom_level</span><span class="p">,</span>
<span class="w">     </span><span class="k">map</span><span class="p">.</span><span class="n">tile_column</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tile_column</span><span class="p">,</span>
<span class="w">     </span><span class="k">map</span><span class="p">.</span><span class="n">tile_row</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tile_row</span><span class="p">,</span>
<span class="w">     </span><span class="n">images</span><span class="p">.</span><span class="n">tile_data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">tile_data</span>
<span class="w">  </span><span class="k">from</span><span class="w"> </span><span class="k">map</span>
<span class="w">     </span><span class="k">join</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">images</span><span class="p">.</span><span class="n">tile_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">map</span><span class="p">.</span><span class="n">tile_id</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mbtiles&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;mbtiles&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;dbfile&gt;</span>/Users/XXX/Documents/MapBox/tiles/natural-earth-1.mbtiles<span class="nt">&lt;/dbfile&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Contrarily to the standard SQLite MapCache schema, the MBTiles db file only
supports a single tileset per cache. The behavior if multiple tilesets are
associated to the same MBTiles cache is undefined, and will definitely
produce incorrect results.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>When working with multiple processes (-p switch) and SQLite cache
backends, some errors may appear under high concurrency when writing to the
SQLite database (error: SQL logic error or missing database (1)).
Upgrading to SQLite &gt;= 3.7.15 seems to resolve this issue.</p>
</div>
</section>
<section id="memcache-caches">
<span id="mapcache-cache-memcache"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">Memcache Caches</a><a class="headerlink" href="#memcache-caches" title="Link to this heading">¶</a></h2>
<p>This cache type stores tiles to an external memcached server running on the local
machine or accessible on the network. This cache type has the advantage that
memcached takes care of expiring tiles, so the size of the cache will never
exceed what has been configured in the memcache instance.</p>
<p>Memcache support requires a rather recent version of the apr-util library. Note
that under very high loads (usually only attainable on synthetic benchmarks on
localhost), the memcache implementation of apr-util may fail and start dropping
connections for some intervals of time before coming back online afterwards.</p>
<p>You can add multiple &lt;server&gt; entries.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;memcache&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;memcache&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;server&gt;</span>
<span class="w">      </span><span class="nt">&lt;host&gt;</span>localhost<span class="nt">&lt;/host&gt;</span>
<span class="w">      </span><span class="nt">&lt;port&gt;</span>11211<span class="nt">&lt;/port&gt;</span>
<span class="w">   </span><span class="nt">&lt;/server&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Tiles stored in memcache backends are configured to expire in 1 day by
default. This can be overridden at the tileset level with the &lt;auto_expire&gt;
keyword.</p>
</div>
<p>To limit the memory used by blank tiles inside the memcache instance, you
may enable blank tile detection, in which case a <cite>#rgba</cite> quadruplet will
be stored to the cache instead of the actual image data. MapCache will convert
that on-the-fly to a 1-bit palleted PNG image before returning it to the client.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;memcache&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;memcache&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;detect_blank/&gt;</span>
<span class="w">   </span>...
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="geo-tiff-caches">
<span id="mapcache-cache-tiff"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">(Geo)TIFF Caches</a><a class="headerlink" href="#geo-tiff-caches" title="Link to this heading">¶</a></h2>
<p>TIFF caches are the most recent addition to the family of caches, and use the
internal tile structure of the TIFF specification to access tile data. Tiles can
be stored in JPEG only (TIFF does not support PNG tiles).</p>
<p>As a single TIFF file may contain many tiles, there is a drastic reduction in
the number of files that have to be stored on the filesystem, which solves the
major shortcomings of the disk cache. Another advantage is that the same TIFF
files can be used by programs or WMS servers that only understand regular GIS
raster formats, and be served up with high performance for tile access.</p>
<p>The TIFF cache should be considered read-only for the time being. Write access
is already possible but should be considered experimental as there might be
some file corruption issues, notably on network filesystems. Note that until
all the tiles in a given TIFF file have been seeded/created, the TIFF file is
said to be “sparse” in the sense that it is missing a number of JPEG tiles. As
such, most non-GDAL based programs will have problems opening these incomplete
files.</p>
<p>Note that the TIFF tile structure must
exactly match the structure of the grid used by the tileset, and the TIFF file
names must follow strict naming rules.</p>
<section id="defining-the-tiff-file-sizes">
<h3>Defining the TIFF File Sizes<a class="headerlink" href="#defining-the-tiff-file-sizes" title="Link to this heading">¶</a></h3>
<p>The number of tiles stored in each of the horizontal and vertical directions
must be defined:</p>
<ul class="simple">
<li><p>&lt;xcount&gt; the number of tiles stored along the x (horizontal) direction of
the TIFF file</p></li>
<li><p>&lt;ycount&gt; the number of tiles stored along the y (vertical) direction of
the TIFF file</p></li>
</ul>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tiff&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;tiff&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;xcount&gt;</span>64<span class="nt">&lt;/xcount&gt;</span>
<span class="w">   </span><span class="nt">&lt;ycount&gt;</span>64<span class="nt">&lt;/ycount&gt;</span>
<span class="w">   </span>...
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="setting-up-the-file-naming-convention">
<h3>Setting Up the File Naming Convention<a class="headerlink" href="#setting-up-the-file-naming-convention" title="Link to this heading">¶</a></h3>
<p>The &lt;template&gt; tag sets the template to use when looking up a TIFF file
name given the x,y,z of the requested tile</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tiff&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;tiff&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;template&gt;</span>/data/tiffs/{tileset}/{grid}/L{z}/R{inv_y}/C{x}.tif<span class="nt">&lt;/template&gt;</span>
<span class="w">   </span>...
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>The following template keys are available for operating on the given tile’s
x,y, and z:</p>
<ul class="simple">
<li><p>{x} is replaced by the x value of the leftmost tile inside the TIFF file
containing the requested tile.</p></li>
<li><p>{inv_x} is replaced by the x value of the rightmost tile.</p></li>
<li><p>{y} is replaced by the y value of the bottommost tile.</p></li>
<li><p>{inv_y} is replaced by the y value of the topmost tile.</p></li>
<li><p>{div_x} is replaced by the index of the TIFF file starting from the left
of the grid (i.e. {div_x} = {x}/&lt;xcount&gt;).</p></li>
<li><p>{inv_div_x} same as {div_x} but starting from the right.</p></li>
<li><p>{div_y} is replaced by the index of the TIFF file starting from the bottom
of the grid (i.e. {div_y} = {y}/&lt;ycount&gt;).</p></li>
<li><p>{inv_div_y} same as {div_y} but starting from the top.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>{inv_x} and {inv_div_x} will probably be rarely used, whereas
{inv_y} and {inv_div_y} will find some usage by people who prefer to index
their TIFF files from top to bottom rather than bottom to top.</p>
</div>
</section>
<section id="customizing-the-template-keys">
<h3>Customizing the Template Keys<a class="headerlink" href="#customizing-the-template-keys" title="Link to this heading">¶</a></h3>
<p>In some cases, it may be desirable to have a precise hand on the
filename to use for a given x,y,z tile lookup, e.g. to look for a file
named “Z03-R00003-C000009.tif” instead of just “Z3-R3-C9.tif”. The
&lt;template&gt; entry supports formatting attributes, following the Unix
printf syntax ( c.f.: <a class="reference external" href="http://linux.die.net/man/3/printf">http://linux.die.net/man/3/printf</a> ), by suffixing
each template key with “_fmt”, e.g.:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tiff&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;tiff&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;template</span>
<span class="w">      </span><span class="na">x_fmt=</span><span class="s">&quot;%08d&quot;</span>
<span class="w">      </span><span class="na">inv_y_fmt=</span><span class="s">&quot;%08d&quot;</span>
<span class="w">   </span><span class="nt">&gt;</span>/data/tiffs/{tileset}/{grid}/L{z}/R{inv_y}/C{x}.tif<span class="nt">&lt;/template&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If not specified, the default behavior is to use “%d” for formatting.</p>
</div>
</section>
<section id="setting-jpeg-compression-options">
<h3>Setting JPEG Compression Options<a class="headerlink" href="#setting-jpeg-compression-options" title="Link to this heading">¶</a></h3>
<p>An additional optional parameter defines which JPEG compression should be
applied to the tiles when saved into the TIFF file:</p>
<ul class="simple">
<li><p>&lt;format&gt; the name of the (JPEG) format to use</p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="formats.html#mapcache-jpeg-format"><span class="std std-ref">JPEG Format</span></a></p>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tiff&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;tiff&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span>...
<span class="w">   </span><span class="nt">&lt;format&gt;</span>myjpeg<span class="nt">&lt;/format&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>In this example, assuming a grid using 256x256 tiles, the files that are read
to load the tiles are tiled TIFFs with JPEG compression, whose size are
16384x16384. The number of files to store on disk is thus reduced 4096 times
compared to the basic disk cache.</p>
</section>
<section id="using-a-specific-locker">
<h3>Using a Specific Locker<a class="headerlink" href="#using-a-specific-locker" title="Link to this heading">¶</a></h3>
<p>MapCache needs to create a <a class="reference internal" href="locks.html#mapcache-locks"><span class="std std-ref">lock</span></a> when writing inside a
TIFF file to ensure that no two instances are updating the same file
concurrently. By default the global MapCache locker will be used; you can,
however, configure a different locking mechanism or behavior by configuring it
inside the TIFF cache itself.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p><a class="reference internal" href="locks.html#mapcache-locks"><span class="std std-ref">Locking Mechanisms</span></a></p>
</div>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;tiff&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;tiff&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span>...
<span class="w">   </span><span class="nt">&lt;locker&gt;</span><span class="w"> </span>....<span class="w"> </span><span class="nt">&lt;/locker&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="geotiff-support">
<h3>GeoTIFF Support<a class="headerlink" href="#geotiff-support" title="Link to this heading">¶</a></h3>
<p>If compiled with GeoTIFF and write support, MapCache will add referencing
information to the TIFF files it creates, so that the TIFF files can be used
in any GeoTIFF-enabled software. Write support does not produce full GeoTIFFs
with the definition of the projection used, but only the pixel scale and
tie-points, i.e. what is usually found in .tfw files.</p>
<p>For reference, here is the gdalinfo output on a TIFF file created by MapCache
when compiled with GeoTIFF support:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOCAL_CS</span><span class="p">[</span><span class="s2">&quot;unnamed&quot;</span><span class="p">,</span>
    <span class="n">UNIT</span><span class="p">[</span><span class="s2">&quot;metre&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">AUTHORITY</span><span class="p">[</span><span class="s2">&quot;EPSG&quot;</span><span class="p">,</span><span class="s2">&quot;9001&quot;</span><span class="p">]]]</span>
<span class="n">Origin</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">20037508.342789247632027</span><span class="p">,</span><span class="mf">20037508.342789247632027</span><span class="p">)</span>
<span class="n">Pixel</span> <span class="n">Size</span> <span class="o">=</span> <span class="p">(</span><span class="mf">156543.033928040997125</span><span class="p">,</span><span class="o">-</span><span class="mf">156543.033928040997125</span><span class="p">)</span>
<span class="n">Metadata</span><span class="p">:</span>
  <span class="n">AREA_OR_POINT</span><span class="o">=</span><span class="n">Area</span>
<span class="n">Image</span> <span class="n">Structure</span> <span class="n">Metadata</span><span class="p">:</span>
  <span class="n">COMPRESSION</span><span class="o">=</span><span class="n">YCbCr</span> <span class="n">JPEG</span>
  <span class="n">INTERLEAVE</span><span class="o">=</span><span class="n">PIXEL</span>
  <span class="n">SOURCE_COLOR_SPACE</span><span class="o">=</span><span class="n">YCbCr</span>
<span class="n">Corner</span> <span class="n">Coordinates</span><span class="p">:</span>
<span class="n">Upper</span> <span class="n">Left</span>  <span class="p">(</span><span class="o">-</span><span class="mf">20037508.343</span><span class="p">,</span><span class="mf">20037508.343</span><span class="p">)</span>
<span class="n">Lower</span> <span class="n">Left</span>  <span class="p">(</span><span class="o">-</span><span class="mf">20037508.343</span><span class="p">,</span><span class="o">-</span><span class="mf">20037508.343</span><span class="p">)</span>
<span class="n">Upper</span> <span class="n">Right</span> <span class="p">(</span><span class="mf">20037508.343</span><span class="p">,</span><span class="mf">20037508.343</span><span class="p">)</span>
<span class="n">Lower</span> <span class="n">Right</span> <span class="p">(</span><span class="mf">20037508.343</span><span class="p">,</span><span class="o">-</span><span class="mf">20037508.343</span><span class="p">)</span>
<span class="n">Center</span>      <span class="p">(</span>   <span class="mf">0.0000000</span><span class="p">,</span>   <span class="mf">0.0000000</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="rest-caches">
<span id="mapcache-cache-rest"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">REST Caches</a><a class="headerlink" href="#rest-caches" title="Link to this heading">¶</a></h2>
<p>The following cache types store and retrieve tiles through standard HTTP GET
and PUT operations, and can be used to store tiles in popular cloud storage
providers.</p>
<section id="pure-rest-cache">
<h3>Pure REST Cache<a class="headerlink" href="#pure-rest-cache" title="Link to this heading">¶</a></h3>
<p>This cache type can be used to store tiles to a WebDAV enabled server. You
must provide a template URL that should be used when accessing a tile with
a given x,y,z, etc…</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;myrestcache&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;rest&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;url&gt;</span>https://myserver/webdav/{tileset}/{grid}/{z}/{x}/{y}.{ext}<span class="nt">&lt;/url&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="specifying-http-headers">
<h3>Specifying HTTP Headers<a class="headerlink" href="#specifying-http-headers" title="Link to this heading">¶</a></h3>
<p>You can customize which headers get added to the HTTP request, either
globally for every HTTP request, or specifically for a given type of request
(i.e. when getting, setting or deleting a tile):</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;myrestcache&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;rest&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;url&gt;</span>https://myserver/webdav/{tileset}/{grid}/{z}/{x}/{y}.{ext}<span class="nt">&lt;/url&gt;</span>
<span class="w">  </span><span class="nt">&lt;headers&gt;</span>
<span class="w">    </span><span class="nt">&lt;Host&gt;</span>my-virtualhost-alias.domain.com<span class="nt">&lt;/Host&gt;</span>
<span class="w">  </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;operation</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;put&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;headers&gt;</span>
<span class="w">      </span><span class="nt">&lt;X-my-specific-put-header&gt;</span>foo<span class="nt">&lt;/X-my-specific-put-header&gt;</span>
<span class="w">    </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;/operation&gt;</span>
<span class="w">  </span><span class="nt">&lt;operation</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;get&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;headers&gt;</span>
<span class="w">      </span><span class="nt">&lt;X-my-specific-get-header&gt;</span>foo<span class="nt">&lt;/X-my-specific-get-header&gt;</span>
<span class="w">    </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;/operation&gt;</span>
<span class="w">  </span><span class="nt">&lt;operation</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;head&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;headers&gt;</span>
<span class="w">      </span><span class="nt">&lt;X-my-specific-head-header&gt;</span>foo<span class="nt">&lt;/X-my-specific-head-header&gt;</span>
<span class="w">    </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;/operation&gt;</span>
<span class="w">  </span><span class="nt">&lt;operation</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;delete&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;headers&gt;</span>
<span class="w">      </span><span class="nt">&lt;X-my-specific-delete-header&gt;</span>foo<span class="nt">&lt;/X-my-specific-delete-header&gt;</span>
<span class="w">    </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;/operation&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="amazon-s3-rest-caches">
<span id="mapcache-cache-rest-s3"></span><h3>Amazon S3 REST Caches<a class="headerlink" href="#amazon-s3-rest-caches" title="Link to this heading">¶</a></h3>
<p>The REST cache has been specialized to enable access to Amazon S3, in order
to add the layer of authentication/authorization needed for that platform.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;s3&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;s3&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;url&gt;</span>https://foo.s3.amazonaws.com/tiles/{tileset}/{grid}/{z}/{x}/{y}/{ext}<span class="nt">&lt;/url&gt;</span>
<span class="w">  </span><span class="nt">&lt;headers&gt;</span>
<span class="w">    </span><span class="nt">&lt;Host&gt;</span>foo.s3.amazonaws.com<span class="nt">&lt;/Host&gt;</span>
<span class="w">  </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;id&gt;</span>AKIE3SDEIT6TUG8DXEQI<span class="nt">&lt;/id&gt;</span>
<span class="w">  </span><span class="nt">&lt;secret&gt;</span>5F+dGsTfsdfkjdsfSDdasf4555d/sSff56sd/RDS<span class="nt">&lt;/secret&gt;</span>
<span class="w">  </span><span class="nt">&lt;region&gt;</span>eu-west-1<span class="nt">&lt;/region&gt;</span>
<span class="w">  </span><span class="nt">&lt;operation</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;put&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;headers&gt;</span>
<span class="w">      </span><span class="nt">&lt;x-amz-storage-class&gt;</span>REDUCED_REDUNDANCY<span class="nt">&lt;/x-amz-storage-class&gt;</span>
<span class="w">      </span><span class="nt">&lt;x-amz-acl&gt;</span>public-read<span class="nt">&lt;/x-amz-acl&gt;</span>
<span class="w">    </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;/operation&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>The &lt;id&gt; &lt;secret&gt; and &lt;region&gt; tags are required and are obtained and configured
through your Amazon management console. You should read the documentation as to
what headers you want to be adding to your requests depending on your use case (the
supplied example hosts tiles on cheaper storage, and allows them to be publicly
accessible).</p>
</section>
<section id="microsoft-azure-rest-caches">
<span id="mapcache-cache-rest-azure"></span><h3>Microsoft Azure REST Caches<a class="headerlink" href="#microsoft-azure-rest-caches" title="Link to this heading">¶</a></h3>
<p>The REST cache has been specialized to enable access to Azure storage, in order
to add the layer of authentication/authorization needed for that platform.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;azure&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;azure&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;url&gt;</span>https://foo.blob.core.windows.net/tiles/{tileset}/{grid}/{z}/{x}/{y}/{ext}<span class="nt">&lt;/url&gt;</span>
<span class="w">  </span><span class="nt">&lt;headers&gt;</span>
<span class="w">    </span><span class="nt">&lt;Host&gt;</span>foo.blob.core.windows.net<span class="nt">&lt;/Host&gt;</span>
<span class="w">  </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;id&gt;</span>foo<span class="nt">&lt;/id&gt;</span>
<span class="w">  </span><span class="nt">&lt;secret&gt;</span>foobarcccccccccccccccccccccyA==<span class="nt">&lt;/secret&gt;</span>
<span class="w">  </span><span class="nt">&lt;container&gt;</span>tiles<span class="nt">&lt;/container&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>The &lt;id&gt; &lt;secret&gt; and &lt;container&gt; tags are required and are obtained and configured
through your management console. You should read the documentation as to
what headers you want to be adding to your requests depending on your use case.</p>
</section>
<section id="google-cloud-storage-rest-caches">
<span id="mapcache-cache-rest-google"></span><h3>Google Cloud Storage REST Caches<a class="headerlink" href="#google-cloud-storage-rest-caches" title="Link to this heading">¶</a></h3>
<p>The REST cache has been specialized to enable access to Google Cloud Storage, in order
to add the layer of authentication/authorization needed for that platform.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;google&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;google&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;url&gt;</span>https://storage.googleapis.com/mytiles-mapcache/{tileset}/{grid}/{z}/{x}/{y}.{ext}<span class="nt">&lt;/url&gt;</span>
<span class="w">  </span><span class="nt">&lt;access&gt;</span>GOOGPGDWFDG345SDFGSD<span class="nt">&lt;/access&gt;</span>
<span class="w">  </span><span class="nt">&lt;secret&gt;</span>sdfgsdSDFwedfwefr2345324dfsGdsfgs<span class="nt">&lt;/secret&gt;</span>
<span class="w">  </span><span class="nt">&lt;operation</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;put&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;headers&gt;</span>
<span class="w">      </span><span class="nt">&lt;x-amz-acl&gt;</span>public-read<span class="nt">&lt;/x-amz-acl&gt;</span>
<span class="w">    </span><span class="nt">&lt;/headers&gt;</span>
<span class="w">  </span><span class="nt">&lt;/operation&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>The &lt;access&gt; and &lt;secret&gt; tags are required and are obtained and configured
through your management console. You should read the documentation as to
what headers you want to be adding to your requests depending on your use case.
Note that support for Google Cloud Storage uses its Amazon compatibility layer.</p>
</section>
</section>
<section id="meta-caches">
<span id="mapcache-cache-meta"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">Meta Caches</a><a class="headerlink" href="#meta-caches" title="Link to this heading">¶</a></h2>
<p>These cache types do not store tiles themselves, but rather delegate the
storage of a tile to a number of child caches based on a set of rules or
behaviors. These caches are mostly useful for large MapCache deployments
across multiple instances, with shared cache backends (i.e. dedicated memcache
servers, and network mounted filer filesystems).</p>
<section id="composite-caches">
<span id="mapcache-cache-composite"></span><h3>Composite Caches<a class="headerlink" href="#composite-caches" title="Link to this heading">¶</a></h3>
<p>This cache uses different child caches depending on the tile’s zoom level, and
can be used for example to store low zoom-level tiles to permanent storage, and
higher zoom-level tiles to a temporary (i.e. memcache) cache.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">cache</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mydisk&quot;</span> <span class="o">...&gt;</span> <span class="o">...</span> <span class="o">&lt;/</span><span class="n">cache</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">cache</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mymemcache&quot;</span> <span class="o">...&gt;</span> <span class="o">...</span> <span class="o">&lt;/</span><span class="n">cache</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">cache</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;composite&quot;</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;composite&quot;</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">cache</span> <span class="n">grids</span><span class="o">=</span><span class="s2">&quot;mygrid,g&quot;</span><span class="o">&gt;</span><span class="n">mycache</span><span class="o">&lt;/</span><span class="n">cache</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">cache</span> <span class="nb">min</span><span class="o">-</span><span class="n">zoom</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="nb">max</span><span class="o">-</span><span class="n">zoom</span><span class="o">=</span><span class="s2">&quot;8&quot;</span><span class="o">&gt;</span><span class="n">mydisk</span><span class="o">&lt;/</span><span class="n">cache</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">cache</span> <span class="nb">min</span><span class="o">-</span><span class="n">zoom</span><span class="o">=</span><span class="s2">&quot;9&quot;</span><span class="o">&gt;</span><span class="n">mymemcache</span><span class="o">&lt;/</span><span class="n">cache</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">cache</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">tileset</span> <span class="o">...&gt;</span>
   <span class="o">&lt;</span><span class="n">cache</span><span class="o">&gt;</span><span class="n">composite</span><span class="o">&lt;/</span><span class="n">cache</span><span class="o">&gt;</span>
   <span class="o">...</span>
<span class="o">&lt;/</span><span class="n">tileset</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>For each tile, the caches are tested in the order in which they have been
defined in the configuration file, and the first one to satisfy the min/max
zoom and grids constraints is used. It’s up to the user to make sure the
succession of min/max zoom values and grids makes sense, e.g.:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;composite&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;composite&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">min-zoom=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>cache1<span class="nt">&lt;/cache&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">min-zoom=</span><span class="s">&quot;9&quot;</span><span class="nt">&gt;</span>this_cache_will_never_be_used<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
<section id="fallback-caches">
<span id="mapcache-cache-fallback"></span><h3>Fallback Caches<a class="headerlink" href="#fallback-caches" title="Link to this heading">¶</a></h3>
<p>These cache types will return tiles from the first configured subcache that does
not return an error. They can be used when one of the caches is prone to error
conditions (e.g. remote REST caches, memcache)</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;fallback&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;fallback&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>mymemcache<span class="nt">&lt;/cache&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>mysqlitecache<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>When writing a tile to such a cache, it will be written to all the child caches.</p>
</section>
<section id="multitier-caches">
<span id="mapcache-cache-multitier"></span><h3>Multitier Caches<a class="headerlink" href="#multitier-caches" title="Link to this heading">¶</a></h3>
<p>These cache types can be used to combine fast/expensive caches with slow/cheap ones.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;multitier&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;multitier&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>fast<span class="nt">&lt;/cache&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>cheap<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
<p>If a given tile isn’t found in the first child cache, it will be read from the second
child cache <strong>and</strong> copied into the first child cache for subsequent accesses. This cache
type is meant to be used when the first cache does automatic pruning of the least recently
used tiles (i.e. a memcache one).</p>
<p>When writing a tile to such a cache, it will be written to the last child.</p>
</section>
<section id="cache-combinations">
<h3>Cache Combinations<a class="headerlink" href="#cache-combinations" title="Link to this heading">¶</a></h3>
<p>All these meta caches can be combined together to fine tune the availability and
performance depending on storage costs, time to recreate missing tiles, etc…</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;slow_and_permanent&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;sqlite&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;fast_and_transient&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;memcache&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;low_zooms&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;multitier&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>fast_and_transient<span class="nt">&lt;/cache&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>slow_and_permanent<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;cache&gt;</span>
<span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;mycache&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;composite&quot;</span><span class="nt">&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">maxzoom=</span><span class="s">&quot;12&quot;</span><span class="nt">&gt;</span>low_zooms<span class="nt">&lt;/cache&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>fast_and_transient<span class="nt">&lt;/cache&gt;</span>
<span class="nt">&lt;cache&gt;</span>
<span class="nt">&lt;tileset&gt;</span>
<span class="w">   </span><span class="nt">&lt;cache&gt;</span>mycache<span class="nt">&lt;/cache&gt;</span>
<span class="w">   </span>...
<span class="nt">&lt;/tileset&gt;</span>
</pre></div>
</div>
<p>In the previous example, all tiles are primarily accessed from a memcache instance, however
the lower zoom level tiles are backed up to a permanent SQLite cache which will be used to
populate the fast memcache cache e.g. on restarts.</p>
</section>
</section>
<section id="riak-caches">
<span id="mapcache-cache-riak"></span><h2><a class="toc-backref" href="#table-of-contents" role="doc-backlink">Riak Caches</a><a class="headerlink" href="#riak-caches" title="Link to this heading">¶</a></h2>
<p>requires <a class="reference external" href="https://github.com/trifork/riack">https://github.com/trifork/riack</a></p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;cache</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;myriak&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;riak&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;server&gt;</span>
<span class="w">    </span><span class="nt">&lt;host&gt;</span>riakhost<span class="nt">&lt;/host&gt;</span>
<span class="w">    </span><span class="nt">&lt;port&gt;</span>12345<span class="nt">&lt;/port&gt;</span>
<span class="w">    </span><span class="nt">&lt;bucket&gt;</span>mytiles<span class="nt">&lt;/bucket&gt;</span>
<span class="w">  </span><span class="nt">&lt;/server&gt;</span>
<span class="nt">&lt;/cache&gt;</span>
</pre></div>
</div>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p>
<a href="../about.html" title="About">About</a><br>
<a href="../products.html" title="Products">Products</a><br>
<a href="../community/index.html" title="Community">Community</a><br>
<a href="../development/index.html" title="Development">Development</a><br>
<a href="../download.html" title="Downloads">Downloads</a><br>
<a href="../documentation.html" title="Documentation">Documentation</a><br>
<a href="../faq.html" title="FAQ">FAQ</a><br>
<a href="../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</h3>
  <ul>
<li><a class="reference internal" href="#">Cache Types</a><ul>
<li><a class="reference internal" href="#disk-caches">Disk Caches</a><ul>
<li><a class="reference internal" href="#common-configuration">Common Configuration</a></li>
<li><a class="reference internal" href="#default-structure">Default Structure</a></li>
<li><a class="reference internal" href="#arcgis-compatible-structure">Arcgis Compatible Structure</a></li>
<li><a class="reference internal" href="#worldwind-compatible-structure">Worldwind Compatible Structure</a></li>
<li><a class="reference internal" href="#template-structure">Template Structure</a></li>
</ul>
</li>
<li><a class="reference internal" href="#berkeley-db-caches">Berkeley DB Caches</a></li>
<li><a class="reference internal" href="#lightning-memory-mapped-database-caches">Lightning Memory-Mapped Database Caches</a></li>
<li><a class="reference internal" href="#sqlite-caches">SQLite Caches</a><ul>
<li><a class="reference internal" href="#default-schema">Default Schema</a></li>
<li><a class="reference internal" href="#custom-schema">Custom Schema</a></li>
<li><a class="reference internal" href="#blank-tile-detection">Blank Tile Detection</a></li>
<li><a class="reference internal" href="#using-multiple-sqlite-database-files">Using Multiple SQLite Database Files</a></li>
<li><a class="reference internal" href="#using-multiple-pyramids-in-multiple-sqlite-database-files-z-top">Using Multiple pyramids in multiple SQLite database files (Z-top)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#mbtiles-caches">MBTiles Caches</a></li>
<li><a class="reference internal" href="#memcache-caches">Memcache Caches</a></li>
<li><a class="reference internal" href="#geo-tiff-caches">(Geo)TIFF Caches</a><ul>
<li><a class="reference internal" href="#defining-the-tiff-file-sizes">Defining the TIFF File Sizes</a></li>
<li><a class="reference internal" href="#setting-up-the-file-naming-convention">Setting Up the File Naming Convention</a></li>
<li><a class="reference internal" href="#customizing-the-template-keys">Customizing the Template Keys</a></li>
<li><a class="reference internal" href="#setting-jpeg-compression-options">Setting JPEG Compression Options</a></li>
<li><a class="reference internal" href="#using-a-specific-locker">Using a Specific Locker</a></li>
<li><a class="reference internal" href="#geotiff-support">GeoTIFF Support</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rest-caches">REST Caches</a><ul>
<li><a class="reference internal" href="#pure-rest-cache">Pure REST Cache</a></li>
<li><a class="reference internal" href="#specifying-http-headers">Specifying HTTP Headers</a></li>
<li><a class="reference internal" href="#amazon-s3-rest-caches">Amazon S3 REST Caches</a></li>
<li><a class="reference internal" href="#microsoft-azure-rest-caches">Microsoft Azure REST Caches</a></li>
<li><a class="reference internal" href="#google-cloud-storage-rest-caches">Google Cloud Storage REST Caches</a></li>
</ul>
</li>
<li><a class="reference internal" href="#meta-caches">Meta Caches</a><ul>
<li><a class="reference internal" href="#composite-caches">Composite Caches</a></li>
<li><a class="reference internal" href="#fallback-caches">Fallback Caches</a></li>
<li><a class="reference internal" href="#multitier-caches">Multitier Caches</a></li>
<li><a class="reference internal" href="#cache-combinations">Cache Combinations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#riak-caches">Riak Caches</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="formats.html" title="Image Formats"
             >next</a> |</li>
        <li class="right" >
          <a href="seed.html" title="Seeder"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../documentation.html" >MapServer 8.0.1 Documentation</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >MapCache 1.14.0</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Cache Types</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; <a href="../copyright.html">Copyright</a> 2023, Open Source Geospatial Foundation.
      Last updated on 2023-12-22.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.5.
    </div>
  </body>
</html>