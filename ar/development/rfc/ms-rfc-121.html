<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml" lang="ar">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MS RFC 121: PostgreSQL and ElasticSearch Support in MapCache dimensions &#8212; MapServer 7.2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '7.2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="shortcut icon" href="../../_static/mapserver.ico"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="copyright" title="Copyright" href="../../copyright.html" />
    <link rel="top" title="MapServer 7.2.0 documentation" href="../../index.html" />
    <link rel="up" title="Request for Comments" href="index.html" />
    <link rel="next" title="MS RFC 122: A Tool for Coverage Analysis of MapCache Multi-SQLite Caches" href="ms-rfc-122.html" />
    <link rel="prev" title="MS RFC 120: INSPIRE download service support for WCS 2.0" href="ms-rfc-120.html" /> 
  </head>
  <body role="document">

<table width="100%" style="width: 100%; background-color: white;">
  <tr>
    <td rowspan="2" style="padding: 10px 0px 10px 10px;">
      <a href="../../index.html" title="Home"><img src="../../_static/banner.png" alt="MapServer banner" border="0" /></a>
    </td>
    <td style="padding: 10px 10px 0px 0px; text-align: right; vertical-align: top;">
      <a href="../../index.html" title="Home">Home</a> |
      <a href="../../products.html" title="Products (MapServer core, MapCache, TinyOWS">Products</a> |
      <a href="https://github.com/mapserver/mapserver/issues/" title="Issue Tracker (MapServer core)">Issue Tracker</a> |
      <a href="../../community/service_providers.html" title="Professional Service Providers">Service Providers</a> |      
      <a href="../../faq.html" title="Frequently Asked Questions">FAQ</a> |
      <a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a> |
      <a href="../../download.html" title="Download Source or Binaries">Download </a>
    </td>
  </tr>
  <tr>
    <td style="padding: 0px 10px 0px 0px; text-align: right; vertical-align: bottom;">
        
          
            <a href="../../../development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/en.png" alt="en" title="en" border="0" /></a>
          
        
        <img src="../../_static/flagicons/ar.png" alt="ar" title="ar" border="0" width="18px" height="13px"/>
        
          
            <a href="../../../de/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/de.png" alt="de" title="de" border="0" /></a>
          
        
        
          
            <a href="../../../el/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/el.png" alt="el" title="el" border="0" /></a>
          
        
        
          
            <a href="../../../es/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/es.png" alt="es" title="es" border="0" /></a>
          
        
        
          
            <a href="../../../fr/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/fr.png" alt="fr" title="fr" border="0" /></a>
          
        
        
          
            <a href="../../../id/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/id.png" alt="id" title="id" border="0" /></a>
          
        
        
          
            <a href="../../../it/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/it.png" alt="it" title="it" border="0" /></a>
          
        
        
          
            <a href="../../../ja/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/ja.png" alt="ja" title="ja" border="0" /></a>
          
        
        
          
            <a href="../../../nl_NL/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/nl_NL.png" alt="nl_NL" title="nl_NL" border="0" /></a>
          
        
        
          
            <a href="../../../pl/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/pl.png" alt="pl" title="pl" border="0" /></a>
          
        
        
          
            <a href="../../../ru/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/ru.png" alt="ru" title="ru" border="0" /></a>
          
        
        
          
            <a href="../../../sq/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/sq.png" alt="sq" title="sq" border="0" /></a>
          
        
        
          
            <a href="../../../tr/development/rfc/ms-rfc-121.html"><img src="../../_static/flagicons/tr.png" alt="tr" title="tr" border="0" /></a>
          
        

    </td>
  </tr>
</table>


    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="ms-rfc-122.html" title="MS RFC 122: A Tool for Coverage Analysis of MapCache Multi-SQLite Caches"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-120.html" title="MS RFC 120: INSPIRE download service support for WCS 2.0"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">Request for Comments</a> &#187;</li> 
      </ul>
    </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ms-rfc-121-postgresql-and-elasticsearch-support-in-mapcache-dimensions">
<span id="rfc121"></span><h1>MS RFC 121: PostgreSQL and ElasticSearch Support in MapCache dimensions<a class="headerlink" href="#ms-rfc-121-postgresql-and-elasticsearch-support-in-mapcache-dimensions" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">2018-06-25</td>
</tr>
<tr class="field-even field"><th class="field-name">Author:</th><td class="field-body">Jerome Boue</td>
</tr>
<tr class="field-odd field"><th class="field-name">Version:</th><td class="field-body">MapCache TBD</td>
</tr>
</tbody>
</table>
<div class="section" id="overview">
<h2>1. Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>MapCache dimension management provides dynamic storage of second level
dimensions in SQLite files, see <em>Second Level Dimensions</em> in
<a class="reference internal" href="../../mapcache/dimensions.html#mapcache-dimensions"><span class="std std-ref">Tileset Dimensions</span></a>. This proposal describes a support for storing
second level dimensions in a PostgreSQL database or an ElasticSearch index.
Moreover, Time Dimensions being implemented as a second level dimension, it
shall also benefit from these new dimension back-ends. A new configuration
interface is proposed to explicitly select a Time Dimension back-end.</p>
</div>
<div class="section" id="proposed-enhancements">
<h2>2. Proposed Enhancements<a class="headerlink" href="#proposed-enhancements" title="Permalink to this headline">¶</a></h2>
<div class="section" id="postgresql-dimensions">
<h3>2.1. PostgreSQL Dimensions<a class="headerlink" href="#postgresql-dimensions" title="Permalink to this headline">¶</a></h3>
<p>Being both based on SQL, PostgreSQL Dimensions are very similar to SQLite
Dimensions. On a configuration point of view, <code class="docutils literal"><span class="pre">&lt;list_query&gt;</span></code> and
<code class="docutils literal"><span class="pre">&lt;validate_query&gt;</span></code> elements are identical to the ones of SQLite Dimension
configuration. The <code class="docutils literal"><span class="pre">&lt;dbfile&gt;</span></code> element (path of SQLite file containing
dimension values) is replaced by a <code class="docutils literal"><span class="pre">&lt;connection&gt;</span></code> element which specifies
connection information to the PostgreSQL database containing dimension values.
This element contains the string required by the <a class="reference external" href="https://www.postgresql.org/docs/current/static/libpq-connect.html#id-1.7.3.8.2.12.2.1.2">PQconnectdb()</a> function of
the libpq - C library.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- PostgreSQL Dimension --&gt;</span>
<span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;postgresql&quot;</span> <span class="na">name=</span><span class="s">&quot;sensor&quot;</span> <span class="na">default=</span><span class="s">&quot;phr&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Access Point --&gt;</span>
    <span class="nt">&lt;connection&gt;</span>
        host=localhost user=mapcache password=mapcache dbname=mapcache port=5433
    <span class="nt">&lt;/connection&gt;</span>

    <span class="c">&lt;!-- All-values Query --&gt;</span>
    <span class="nt">&lt;list_query&gt;</span>
        SELECT distinct(product) FROM dim
    <span class="nt">&lt;/list_query&gt;</span>

    <span class="c">&lt;!-- Selected-values Query --&gt;</span>
    <span class="nt">&lt;validate_query&gt;</span>
        SELECT product FROM dim
        WHERE sensor=:dim
    <span class="nt">&lt;/validate_query&gt;</span>

<span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="elasticsearch-dimensions">
<h3>2.2. ElasticSearch Dimensions<a class="headerlink" href="#elasticsearch-dimensions" title="Permalink to this headline">¶</a></h3>
<p>ElasticSearch main difference with SQLite and PostgreSQL is its query language,
Query-DSL, based on JSON instead of SQL. Therefore, <code class="docutils literal"><span class="pre">&lt;list_query&gt;</span></code> and
<code class="docutils literal"><span class="pre">&lt;validate_query&gt;</span></code> elements shall contain queries expressed in that language.
Inserting JSON data in XML configuration may need to encapsulate it in a
<code class="docutils literal"><span class="pre">&lt;![CDATA[</span> <span class="pre">...</span> <span class="pre">]]&gt;</span></code> element.</p>
<p>In addition, the complex structure of ElasticSearch responses, also expressed
in JSON, raises the need for extraction instructions to get sub-dimension
values from query responses.</p>
<p>For example, let’s assume that this ElasticSearch query:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>   <span class="nt">&quot;size&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;aggs&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;distinct_product&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;terms&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;product/keyword&quot;</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="nt">&quot;query&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;term&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;sensor&quot;</span><span class="p">:</span> <span class="s2">&quot;phr&quot;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>returns this response:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">{</span>   <span class="nt">&quot;took&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nt">&quot;timed_out&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nt">&quot;_shards&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&quot;successful&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&quot;skipped&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nt">&quot;failed&quot;</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">{</span> <span class="nt">&quot;total&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nt">&quot;max_score&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nt">&quot;hits&quot;</span><span class="p">:</span> <span class="p">[]</span> <span class="p">},</span>
    <span class="nt">&quot;aggregations&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;distinct_product&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;doc_count_error_upper_bound&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;sum_other_doc_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="nt">&quot;buckets&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span> <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;phr_img1&quot;</span><span class="p">,</span> <span class="nt">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
                <span class="p">{</span> <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;phr_img2&quot;</span><span class="p">,</span> <span class="nt">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span>
                <span class="p">{</span> <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;phr_img3&quot;</span><span class="p">,</span> <span class="nt">&quot;doc_count&quot;</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The expected sub-dimension values are then:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="s2">&quot;phr_img1&quot;</span><span class="p">,</span> <span class="s2">&quot;phr_img2&quot;</span><span class="p">,</span> <span class="s2">&quot;phr_img3&quot;</span> <span class="p">]</span>
</pre></div>
</div>
<p>This list is obtained by extracting the <code class="docutils literal"><span class="pre">aggregations</span></code> item from the outer
dictionary, then <code class="docutils literal"><span class="pre">distinct_product</span></code> , then <code class="docutils literal"><span class="pre">buckets</span></code>. Finally the <code class="docutils literal"><span class="pre">key</span></code>
item is to be extracted from each dictionary of the <code class="docutils literal"><span class="pre">bucket</span></code> list. The
extraction instructions take the form of a path-like list of keywords to be
used to extract sub-dimension values from JSON response provided by
ElasticSearch:</p>
<div class="highlight-json"><div class="highlight"><pre><span></span><span class="p">[</span> <span class="s2">&quot;aggregations&quot;</span><span class="p">,</span> <span class="s2">&quot;distinct_product&quot;</span><span class="p">,</span> <span class="s2">&quot;buckets&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span> <span class="p">]</span>
</pre></div>
</div>
<p>This is specified in the MapCache configuration file by way of new XML
elements, namely  <code class="docutils literal"><span class="pre">&lt;list_response&gt;</span></code> and <code class="docutils literal"><span class="pre">&lt;validate_response&gt;</span></code>, containing
extraction instructions respectively for <code class="docutils literal"><span class="pre">&lt;list_query&gt;</span></code> and
<code class="docutils literal"><span class="pre">&lt;validate_query&gt;</span></code> queries.</p>
<p>Access point to an ElasticSearch index is configured with a <code class="docutils literal"><span class="pre">&lt;http&gt;</span></code> element
in place of SQLite&#8217;s <code class="docutils literal"><span class="pre">&lt;dbfile&gt;</span></code> or PostgreSQL&#8217;s <code class="docutils literal"><span class="pre">&lt;connection&gt;</span></code>. In that
<code class="docutils literal"><span class="pre">&lt;http&gt;</span></code> element, both <code class="docutils literal"><span class="pre">&lt;url&gt;</span></code> and <code class="docutils literal"><span class="pre">&lt;Content-Type&gt;</span></code> shall be specified.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- ElasticSearch Dimension --&gt;</span>
<span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;elasticsearch&quot;</span> <span class="na">name=</span><span class="s">&quot;sensor&quot;</span> <span class="na">default=</span><span class="s">&quot;phr&quot;</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- Access Point --&gt;</span>
    <span class="nt">&lt;http&gt;</span>
        <span class="nt">&lt;url&gt;</span>http://localhost:9200/sensor/_search<span class="nt">&lt;/url&gt;</span>
        <span class="nt">&lt;headers&gt;</span>
            <span class="nt">&lt;Content-Type&gt;</span>application/json<span class="nt">&lt;/Content-Type&gt;</span>
        <span class="nt">&lt;/headers&gt;</span>
    <span class="nt">&lt;/http&gt;</span>

    <span class="c">&lt;!-- All-values Query --&gt;</span>
    <span class="nt">&lt;list_query&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        {   &quot;size&quot;: 0,</span>
<span class="cp">            &quot;aggs&quot;: {</span>
<span class="cp">                &quot;products&quot;: { &quot;terms&quot;: { &quot;field&quot;: &quot;product.keyword&quot; } }</span>
<span class="cp">            }</span>
<span class="cp">        }</span>
<span class="cp">    ]]&gt;</span><span class="nt">&lt;/list_query&gt;</span>

    <span class="c">&lt;!-- All-values Response Extration Instructions --&gt;</span>
    <span class="nt">&lt;list_response&gt;</span>
        [ &quot;aggregations&quot;, &quot;products&quot;, &quot;buckets&quot;, &quot;key&quot; ]
    <span class="nt">&lt;/list_response&gt;</span>

    <span class="c">&lt;!-- Selected-values Query --&gt;</span>
    <span class="nt">&lt;validate_query&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">        {   &quot;size&quot;: 0,</span>
<span class="cp">            &quot;aggs&quot;: {</span>
<span class="cp">                &quot;products&quot;: { &quot;terms&quot;: { &quot;field&quot;: &quot;product.keyword&quot; } }</span>
<span class="cp">            },</span>
<span class="cp">            &quot;query&quot;: { &quot;term&quot;: { &quot;sensor&quot;: &quot;:dim&quot; } }</span>
<span class="cp">        }</span>
<span class="cp">    ]]&gt;</span><span class="nt">&lt;/validate_query&gt;</span>

    <span class="c">&lt;!-- Selected-values Response Extration Instructions --&gt;</span>
    <span class="nt">&lt;validate_response&gt;</span>
        [ &quot;aggregations&quot;, &quot;products&quot;, &quot;buckets&quot;, &quot;key&quot; ]
    <span class="nt">&lt;/validate_response&gt;</span>

<span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="time-dimensions">
<h3>2.3. Time Dimensions<a class="headerlink" href="#time-dimensions" title="Permalink to this headline">¶</a></h3>
<p>Time Dimensions currently use a SQLite back-end for storing allowed dimension
values. Hereafter is an example of current Time Dimension configuration:</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span> <span class="c">&lt;!-- &quot;time&quot; dimension, &quot;old-style&quot; definition</span>

<span class="c">      This example defines a &quot;time&quot; dimension whose possible values are</span>
<span class="c">      stored in the /data/times.sqlite SQLite file. The default value is</span>
<span class="c">      &quot;d1&quot;.</span>

<span class="c">      A WMS request with that dimension may contain, e.g.</span>
<span class="c">      &quot;... &amp;time=1999-08-11T11:03:07Z/2001-09-21T08:17:56Z&amp; ...&quot;</span>
<span class="c"> --&gt;</span>
<span class="hll"> <span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;time&quot;</span> <span class="na">name=</span><span class="s">&quot;time&quot;</span> <span class="na">default=</span><span class="s">&quot;d1&quot;</span><span class="nt">&gt;</span>
</span>   <span class="nt">&lt;dbfile&gt;</span>/data/times.sqlite<span class="nt">&lt;/dbfile&gt;</span>
   <span class="nt">&lt;query&gt;</span>
        SELECT strftime(&quot;%Y-%m-%dT%H:%M:%SZ&quot;,ts) FROM timedim
         WHERE ts <span class="ni">&amp;gt;</span>= datetime(:start_timestamp,&quot;unixepoch&quot;)
           AND ts <span class="ni">&amp;lt;</span>= datetime(:end_timestamp,&quot;unixepoch&quot;)
      ORDER BY ts DESC
   <span class="nt">&lt;/query&gt;</span>
 <span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
<p>In a perspective where Dimensions back-ends will be implemented in other ways
than SQLite, it may be relevant to make Time Dimensions back-end agnostic. In a
configuration point of view this is achieved by adding a boolean <code class="docutils literal"><span class="pre">time</span></code>
attribute to a dimension of any type among <code class="docutils literal"><span class="pre">sqlite</span></code>, <code class="docutils literal"><span class="pre">postgresql</span></code> or
<code class="docutils literal"><span class="pre">elasticsearch</span></code>. Following are examples of such configurations.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span> <span class="c">&lt;!-- &quot;time&quot; dimension, &quot;new-style&quot; definition using a SQLite back-end</span>

<span class="c">      This example defines a &quot;time&quot; dimension whose possible values are</span>
<span class="c">      stored in the /data/times.sqlite SQLite file. The default value is</span>
<span class="c">      &quot;d1&quot;.</span>

<span class="c">      A WMS request with that dimension may contain, e.g.</span>
<span class="c">      &quot;... &amp;time=1999-08-11T11:03:07Z/2001-09-21T08:17:56Z&amp; ...&quot;</span>
<span class="c"> --&gt;</span>
<span class="hll"> <span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;sqlite&quot;</span> <span class="na">name=</span><span class="s">&quot;time&quot;</span> <span class="na">default=</span><span class="s">&quot;d1&quot;</span> <span class="na">time=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span>   <span class="nt">&lt;dbfile&gt;</span>/data/times.sqlite<span class="nt">&lt;/dbfile&gt;</span>
   <span class="nt">&lt;list_query&gt;</span>SELECT ts FROM timedim<span class="nt">&lt;/list_query&gt;</span>
   <span class="nt">&lt;validate_query&gt;</span>
        SELECT strftime(&quot;%Y-%m-%dT%H:%M:%SZ&quot;,ts) FROM timedim
         WHERE ts <span class="ni">&amp;gt;</span>= datetime(:start_timestamp,&quot;unixepoch&quot;)
           AND ts <span class="ni">&amp;lt;</span>= datetime(:end_timestamp,&quot;unixepoch&quot;)
      ORDER BY ts DESC
   <span class="nt">&lt;/validate_query&gt;</span>
 <span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span> <span class="c">&lt;!-- &quot;time&quot; dimension, &quot;new-style&quot; definition using a PostgreSQL back-end</span>

<span class="c">      This example defines a &quot;time&quot; dimension whose possible values are</span>
<span class="c">      stored in the postgresql://mapcache:mapcache@localhost:5433/time</span>
<span class="c">      PostgreSQL database. The default value is &quot;d1&quot;.</span>

<span class="c">      A WMS request with that dimension may contain, e.g.</span>
<span class="c">      &quot;... &amp;time=1999-08-11T11:03:07Z/2001-09-21T08:17:56Z&amp; ...&quot;</span>
<span class="c"> --&gt;</span>
<span class="hll"> <span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;postgresql&quot;</span> <span class="na">name=</span><span class="s">&quot;time&quot;</span> <span class="na">default=</span><span class="s">&quot;d1&quot;</span> <span class="na">time=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span>   <span class="nt">&lt;connection&gt;</span>
     host=localhost user=mapcache password=mapcache dbname=times port=5433
   <span class="nt">&lt;/connection&gt;</span>
   <span class="nt">&lt;list_query&gt;</span>SELECT ts FROM timedim<span class="nt">&lt;/list_query&gt;</span>
   <span class="nt">&lt;validate_query&gt;</span>
        SELECT to_char(ts,&#39;YYYY-MM-DD&quot;T&quot;HH24:MI:SS&quot;Z&quot;&#39;) FROM timedim
         WHERE ts <span class="ni">&amp;gt;</span>= to_timestamp(:start_timestamp)
           AND ts <span class="ni">&amp;lt;</span>= to_timestamp(:end_timestamp)
      ORDER BY ts DESC
   <span class="nt">&lt;/validate_query&gt;</span>
 <span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
<div class="highlight-xml"><div class="highlight"><pre><span></span> <span class="c">&lt;!-- &quot;time&quot; dimension, &quot;new-style&quot; definition using an ElasticSearch back-end</span>

<span class="c">      This example defines a &quot;time&quot; dimension whose possible values are</span>
<span class="c">      stored in the http://localhost:9200/times ElasticSearch index. The</span>
<span class="c">      default value is &quot;d1&quot;.</span>

<span class="c">      A WMS request with that dimension may contain, e.g.</span>
<span class="c">      &quot;... &amp;time=1999-08-11T11:03:07Z/2001-09-21T08:17:56Z&amp; ...&quot;</span>
<span class="c"> --&gt;</span>
<span class="hll"> <span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;elasticsearch&quot;</span> <span class="na">name=</span><span class="s">&quot;time&quot;</span> <span class="na">default=</span><span class="s">&quot;d1&quot;</span> <span class="na">time=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
</span>   <span class="nt">&lt;http&gt;</span>
     <span class="nt">&lt;url&gt;</span>http://localhost:9200/times/_search<span class="nt">&lt;/url&gt;</span>
     <span class="nt">&lt;headers&gt;</span>
       <span class="nt">&lt;Content-Type&gt;</span>application/json<span class="nt">&lt;/Content-Type&gt;</span>
     <span class="nt">&lt;/headers&gt;</span>
   <span class="nt">&lt;/http&gt;</span>

   <span class="nt">&lt;list_query&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">     { &quot;query&quot;: { &quot;match_all&quot;: { } } }</span>
<span class="cp">   ]]&gt;</span><span class="nt">&lt;/list_query&gt;</span>
   <span class="nt">&lt;list_response&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">     [ &quot;hits&quot;, &quot;hits&quot;, &quot;_source&quot;, &quot;ts&quot; ]</span>
<span class="cp">   ]]&gt;</span><span class="nt">&lt;/list_response&gt;</span>

   <span class="nt">&lt;validate_query&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">     { &quot;query&quot;: {</span>
<span class="cp">         &quot;range&quot;: {</span>
<span class="cp">           &quot;ts&quot;: { &quot;gte&quot;: :start_timestamp, &quot;lte&quot;: :end_timestamp }</span>
<span class="cp">         }</span>
<span class="cp">       },</span>
<span class="cp">       &quot;sort&quot;: { &quot;ts&quot;: { &quot;order&quot;: &quot;desc&quot; } },</span>
<span class="cp">       &quot;script_fields&quot;: {</span>
<span class="cp">         &quot;iso_ts&quot;: {</span>
<span class="cp">           &quot;lang&quot;: &quot;painless&quot;,</span>
<span class="cp">           &quot;source&quot;: &quot;SimpleDateFormat f=new SimpleDateFormat(params.fmt); f.setTimeZone(params.tz); return (f.format(doc.ts.value.getMillis()))&quot;,</span>
<span class="cp">           &quot;params&quot;: {</span>
<span class="cp">             &quot;fmt&quot;: &quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss&#39;Z&#39;&quot;,</span>
<span class="cp">             &quot;tz: &quot;UTC&quot;</span>
<span class="cp">           }</span>
<span class="cp">         }</span>
<span class="cp">       }</span>
<span class="cp">     }</span>
<span class="cp">   ]]&gt;</span><span class="nt">&lt;/validate_query&gt;</span>
   <span class="nt">&lt;validate_response&gt;</span><span class="cp">&lt;![CDATA[</span>
<span class="cp">     [ &quot;hits&quot;, &quot;hits&quot;, &quot;fields&quot;, &quot;iso_ts&quot;, 0 ]</span>
<span class="cp">   ]]&gt;</span><span class="nt">&lt;/validate_response&gt;</span>

 <span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
<div class="section" id="compatibility-issue-on-time-dimension-with-implicit-sqlite-back-end">
<h4>Compatibility issue on Time Dimension with implicit SQLite back-end<a class="headerlink" href="#compatibility-issue-on-time-dimension-with-implicit-sqlite-back-end" title="Permalink to this headline">¶</a></h4>
<p>Together with explicit back-end configuration, an almost backward compatible
configuration of Time dimension is still provided with an implicit SQLite
back-end. Following example highlights the differences:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><div class="first last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- &quot;time&quot; dimension</span>

<span class="c">     This example defines a &quot;time&quot; dimension whose possible values</span>
<span class="c">     are stored in the /data/times.sqlite SQLite file. The</span>
<span class="c">     default value is &quot;2010&quot;.</span>

<span class="c">     A WMS request with that dimension may contain, e.g.  &quot;...</span>
<span class="c">     &amp;time=1999-08-11T11:03:07Z/2001-09-21T08:17:56Z&amp; ...&quot;</span>
<span class="c">--&gt;</span>
<span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;time&quot;</span> <span class="na">name=</span><span class="s">&quot;time&quot;</span> <span class="na">default=</span><span class="s">&quot;2010&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dbfile&gt;</span>/data/times.sqlite<span class="nt">&lt;/dbfile&gt;</span>
<span class="hll">    <span class="nt">&lt;query&gt;</span>
</span>         SELECT strftime(&quot;%Y-%m-%dT%H:%M:%SZ&quot;,ts) FROM time
          WHERE ts <span class="ni">&amp;gt;</span>= datetime(:start_timestamp,&quot;unixepoch&quot;)
            AND ts <span class="ni">&amp;lt;</span>= datetime(:end_timestamp,&quot;unixepoch&quot;)
       ORDER BY ts DESC
<span class="hll">    <span class="nt">&lt;/query&gt;</span>
</span>
<span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
</td>
<td><div class="first last highlight-xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- &quot;time&quot; dimension</span>

<span class="c">     This example defines a &quot;time&quot; dimension whose possible values</span>
<span class="c">     are stored in the /data/times.sqlite SQLite file. The</span>
<span class="c">     default value is &quot;2010&quot;.</span>

<span class="c">     A WMS request with that dimension may contain, e.g.  &quot;...</span>
<span class="c">     &amp;time=1999-08-11T11:03:07Z/2001-09-21T08:17:56Z&amp; ...&quot;</span>
<span class="c">--&gt;</span>
<span class="nt">&lt;dimension</span> <span class="na">type=</span><span class="s">&quot;time&quot;</span> <span class="na">name=</span><span class="s">&quot;time&quot;</span> <span class="na">default=</span><span class="s">&quot;2010&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;dbfile&gt;</span>/data/times.sqlite<span class="nt">&lt;/dbfile&gt;</span>
<span class="hll">    <span class="nt">&lt;validate_query&gt;</span>
</span>         SELECT strftime(&quot;%Y-%m-%dT%H:%M:%SZ&quot;,ts) FROM time
          WHERE ts <span class="ni">&amp;gt;</span>= datetime(:start_timestamp,&quot;unixepoch&quot;)
            AND ts <span class="ni">&amp;lt;</span>= datetime(:end_timestamp,&quot;unixepoch&quot;)
       ORDER BY ts DESC
<span class="hll">    <span class="nt">&lt;/validate_query&gt;</span>
</span><span class="hll">    <span class="nt">&lt;list_query&gt;</span>SELECT ts FROM time<span class="nt">&lt;/list_query&gt;</span>
</span><span class="nt">&lt;/dimension&gt;</span>
</pre></div>
</div>
</td>
</tr>
<tr class="row-even"><td>Up to MapCache 1.6.1</td>
<td>From MapCache &gt; 1.6.1 on</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="implementation-details">
<h2>3. Implementation Details<a class="headerlink" href="#implementation-details" title="Permalink to this headline">¶</a></h2>
<div class="section" id="dependencies">
<h3>3.1. Dependencies<a class="headerlink" href="#dependencies" title="Permalink to this headline">¶</a></h3>
<p>Both PostgreSQL and ElasticSearch Dimensions need specific libraries to work.
Both needs are fulfilled with off-the-shelf solutions. PostgreSQL interface
uses a third party library whereas ElasticSearch interface uses code that is
embedded into MapCache.</p>
<dl class="docutils">
<dt><strong>PostgreSQL</strong></dt>
<dd><a class="reference external" href="https://www.postgresql.org/docs/current/static/libpq.html">libpq</a> is the C API to PostgreSQL. This is a third party library that
shall be linked to MapCache in order for PostgreSQL Dimension back-end to
work.</dd>
<dt><strong>ElasticSearch</strong></dt>
<dd>While ElasticSearch JSON queries can be passed to the server as simple text
strings, ElasticSearch JSON responses must be parsed in order to extract
relevant information to be further handled by MapCache. For that purpose an
off-the-shelf solution is proposed, namely <a class="reference external" href="https://github.com/DaveGamble/cJSON">cJSON</a>, available on GitHub
through a MIT license. Files <code class="docutils literal"><span class="pre">cJSON.h</span></code> and <code class="docutils literal"><span class="pre">cJSON.c</span></code> are simply copied
in MapCache project, respectively in <code class="docutils literal"><span class="pre">include/</span></code> and <code class="docutils literal"><span class="pre">lib/</span></code> directories.</dd>
</dl>
</div>
<div class="section" id="affected-files">
<h3>3.2. Affected files<a class="headerlink" href="#affected-files" title="Permalink to this headline">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="40%" />
<col width="13%" />
<col width="47%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">File name</th>
<th class="head">Status</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>include/mapcache.h</td>
<td>Modified</td>
<td>Interface changes introduced by
proposed features</td>
</tr>
<tr class="row-odd"><td>lib/dimension.c</td>
<td>Modified</td>
<td>Only processings common to all
dimension backends are kept in
this file.</td>
</tr>
<tr class="row-even"><td>lib/dimension_sqlite.c,
lib/dimension_es.c,
lib/dimension_pg.c</td>
<td>New</td>
<td>Backend-specific processings get
their own source files.</td>
</tr>
<tr class="row-odd"><td>lib/dimension_time.c</td>
<td>New</td>
<td>Time dimension gets its own source
file</td>
</tr>
<tr class="row-even"><td>include/cJSON.h, lib/cJSON.c</td>
<td>New</td>
<td>Embedded JSON parser for
ElsaticSearch backend</td>
</tr>
<tr class="row-odd"><td>CMakeLists.txt,
include/mapcache-config.h.in</td>
<td>Modified</td>
<td>Account for optional external
PostgreSQL library</td>
</tr>
<tr class="row-even"><td>lib/util.c</td>
<td>Modified</td>
<td>New ancillary needs from proposed
features</td>
</tr>
<tr class="row-odd"><td>lib/service_wms.c,
lib/tileset.c,
lib/configuration_xml.c,
util/mapcache_seed.c</td>
<td>Modified</td>
<td>Various impacts of proposed
features on existing code</td>
</tr>
<tr class="row-even"><td>mapcache.xml</td>
<td>Modified</td>
<td>Configuration example of a
PostgreSQL dimension</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="documentation">
<h3>3.3. Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h3>
<p>MapCache&#8217;s <a class="reference internal" href="../../mapcache/dimensions.html#mapcache-dimensions"><span class="std std-ref">Tileset Dimensions</span></a> document shall be updated accordingly.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script><h3>Navigation</h3>
<p>
<a href="../../about.html" title="About">About</a><br>
<a href="../../products.html" title="Products">Products</a><br>
<a href="../../community/index.html" title="Community">Community</a><br>
<a href="../index.html" title="Development">Development</a><br>
<a href="../../download.html" title="Downloads">Downloads</a><br>
<a href="../../documentation.html" title="Documentation">Documentation</a><br>
<a href="../../faq.html" title="FAQ">FAQ</a><br>
<a href="../../psc.html" title="PSC">PSC</a><br>
<a href="https://twitter.com/mapserver_osgeo" title="Twitter">Twitter</a>
</p>
  <h3>Current Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MS RFC 121: PostgreSQL and ElasticSearch Support in MapCache dimensions</a><ul>
<li><a class="reference internal" href="#overview">1. Overview</a></li>
<li><a class="reference internal" href="#proposed-enhancements">2. Proposed Enhancements</a><ul>
<li><a class="reference internal" href="#postgresql-dimensions">2.1. PostgreSQL Dimensions</a></li>
<li><a class="reference internal" href="#elasticsearch-dimensions">2.2. ElasticSearch Dimensions</a></li>
<li><a class="reference internal" href="#time-dimensions">2.3. Time Dimensions</a><ul>
<li><a class="reference internal" href="#compatibility-issue-on-time-dimension-with-implicit-sqlite-back-end">Compatibility issue on Time Dimension with implicit SQLite back-end</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-details">3. Implementation Details</a><ul>
<li><a class="reference internal" href="#dependencies">3.1. Dependencies</a></li>
<li><a class="reference internal" href="#affected-files">3.2. Affected files</a></li>
<li><a class="reference internal" href="#documentation">3.3. Documentation</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="ms-rfc-122.html" title="MS RFC 122: A Tool for Coverage Analysis of MapCache Multi-SQLite Caches"
             >next</a> |</li>
        <li class="right" >
          <a href="ms-rfc-120.html" title="MS RFC 120: INSPIRE download service support for WCS 2.0"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Home</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Development</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >Request for Comments</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; <a href="../../copyright.html">Copyright</a> 2018, Open Source Geospatial Foundation.
      Last updated on 2018-07-30.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.9.
    </div>
  </body>
</html>